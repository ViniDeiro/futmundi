<!DOCTYPE html>
{% load static %}
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <title>Novo Campeonato</title>

        <link href="{% static 'administrativo/css/bootstrap.min.css' %}" rel="stylesheet">
        <link href="{% static 'administrativo/font-awesome/css/font-awesome.css' %}" rel="stylesheet">

        <!-- Toastr style -->
        <link href="{% static 'administrativo/css/plugins/toastr/toastr.min.css' %}" rel="stylesheet">
        <link href="{% static 'administrativo/css/plugins/iCheck/custom.css' %}" rel="stylesheet">
        <link href="{% static 'administrativo/css/plugins/jasny/jasny-bootstrap.min.css' %}" rel="stylesheet">
        <link href="{% static 'administrativo/css/plugins/select2/select2.min.css' %}" rel="stylesheet">
        <link href="{% static 'administrativo/css/animate.css' %}" rel="stylesheet">
        <link href="{% static 'administrativo/css/style.css' %}" rel="stylesheet">  
        <link href="{% static 'administrativo/css/plugins/dualListbox/bootstrap-duallistbox.min.css' %}" rel="stylesheet">  
        <link href="{% static 'administrativo/css/plugins/tempusdominus/tempusdominus-bootstrap-4.min.css' %}" rel="stylesheet">  
            
        <!-- Custom -->      
        <link href="{% static 'administrativo/css/custom.css' %}" rel="stylesheet">

        <!-- Favicon -->
        <link rel="icon" href="{% static 'administrativo/img/futmundi.ico' %}" type="image/png">
    </head>
    <body>
        <div id="wrapper">
            <nav class="navbar-default navbar-static-side">
                <div class="sidebar-collapse">
                    <ul class="nav metismenu" id="side-menu">
                        <li class="nav-header">
                            <div class="dropdown profile-element">
                                <a href="{% url 'administrativo:usuarios' %}">
                                    <img src="{% static 'administrativo/img/logo.svg' %}" alt="Futmundi logo">
                                </a>
                            </div>
                            <div class="logo-element">
                                <a href="{% url 'administrativo:usuarios' %}">
                                    <img src="{% static 'administrativo/img/logosm.svg' %}" alt="Futmundi logo">
                                </a>                            
                            </div>
                        </li>
                        <li class="active">
                            <a href="{% url 'administrativo:usuarios' %}"><i class="fa fa-user"></i> <span class="nav-label">Usuários</span></a>
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-trophy"></i> <span class="nav-label">Campeonatos</span><span class="fa arrow"></span></a>
                            <ul class="nav nav-second-level collapse">
                                <li><a href="{% url 'administrativo:ambitos' %}">Âmbitos</a></li>
                                <li><a href="{% url 'administrativo:campeonatos' %}">Campeonatos</a></li>
                                <li><a href="{% url 'administrativo:templates' %}">Templates</a></li>
                                <li><a href="{% url 'administrativo:times' %}">Times</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-shopping-cart"></i> <span class="nav-label">Pacotes</span><span class="fa arrow"></span></a>
                            <ul class="nav nav-second-level collapse">
                                <li><a href="{% url 'administrativo:futcoins' %}">Futcoins</a></li>
                                <li><a href="{% url 'administrativo:planos' %}">Planos</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-diamond"></i> <span class="nav-label">Futligas</span><span class="fa arrow"></span></a>
                            <ul class="nav nav-second-level collapse">
                                <li><a href="{% url 'administrativo:futligas_classicas' %}">Clássicas</a></li>
                                <li><a href="{% url 'administrativo:futligas_jogadores' %}">Jogadores</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-globe"></i> <span class="nav-label">Locais</span><span class="fa arrow"></span></a>
                            <ul class="nav nav-second-level collapse">
                                <li><a href="{% url 'administrativo:continentes' %}">Continentes</a></li>
                                <li><a href="{% url 'administrativo:paises' %}">Países</a></li>
                                <li><a href="{% url 'administrativo:estados' %}">Estados</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-gear"></i> <span class="nav-label">Configurações</span><span class="fa arrow"></span></a>
                            <ul class="nav nav-second-level collapse">
                                <li><a href="{% url 'administrativo:parametros' %}">Parâmetros</a></li>
                                <li><a href="{% url 'administrativo:termo' %}">Termo</a></li>
                                <li><a href="{% url 'administrativo:notificacoes' %}">Notificações</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="{% url 'administrativo:relatorios' %}"><i class="fa fa-pie-chart"></i> <span class="nav-label">Relatórios</span></a>
                        </li>
                    </ul>
                </div>
            </nav>
            <div id="page-wrapper" class="gray-bg">
                <div class="row border-bottom">
                    <nav class="navbar navbar-static-top" style="margin-bottom: 0">
                        <div class="navbar-header">
                            <a class="navbar-minimalize minimalize-styl-2 btn btn-success " href="#"><i class="fa fa-bars"></i> </a>
                        </div>
                        <ul class="nav navbar-top-links navbar-right">
                            <li>
                                <span class="m-r-sm text-muted welcome-message">{{ request.user.get_full_name }}</span>
                            </li>
                            <li class="dropdown">
                                <a class="dropdown-toggle count-info" data-toggle="dropdown" href="#">
                                    <i class="fa fa-gear"></i>
                                </a>
                                <ul class="dropdown-menu dropdown-alerts">
                                    <li>
                                        <a href="{% url 'administrativo:administradores' %}" class="dropdown-item">
                                            <div>
                                                <i class="fa fa-users"></i> Administradores
                                            </div>
                                        </a>
                                    </li>
                                    <li class="dropdown-divider"></li>
                                    <li>
                                        <a href="{% url 'administrativo:logout' %}" class="dropdown-item">
                                            <div>
                                                <i class="fa fa-sign-out"></i> Sair
                                            </div>
                                        </a>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </nav>
                </div>
                <div class="row wrapper border-bottom white-bg page-heading">
                    <div class="col-lg-10">
                        <h2>Novo Campeonato</h2>
                    </div>
                </div>
                <div class="wrapper wrapper-content">
                    <div class="row">
                        <div class="col-lg-12">
                            <form id="form-campeonato" method="post" action="{% url 'administrativo:campeonato_novo' %}">
                                {% csrf_token %}
                                <div class="tabs-container">
                                    <ul class="nav nav-tabs" role="tablist">
                                        <li><a class="nav-link active" data-toggle="tab" href="#geral">Geral</a></li>
                                        <li><a class="nav-link" data-toggle="tab" href="#times">Times</a></li>
                                        <li><a class="nav-link" data-toggle="tab" href="#rodadas">Rodadas</a></li>
                                    </ul>
                                    <div class="tab-content">
                                        <div id="geral" class="tab-pane active">
                                            <div class="panel-body">
                                                <div class="row">
                                                    <div class="row col-lg-6 mt10">
                                                        <div class="col-lg-6">
                                                            <div class="col-lg-12">
                                                                <input type="text" id="nome" name="name" class="form-control" required>
                                                                <label class="form-control-placeholder" for="nome">Nome</label>
                                                            </div> 
                                                            <div class="col-lg-12 mt11">
                                                                <label class="control-label">Template</label>
                                                                <select class="form-control js-basic-single" id="template" name="template" required>
                                                                    {% for template in templates %}
                                                                    <option value="{{ template.id }}">{{ template.name }}</option>
                                                                    {% endfor %}
                                                                </select> 
                                                            </div>
                                                            <div class="col-lg-12 mt15">
                                                                <div class="i-checks"><label><input type="checkbox" name="is_active" checked> Ativo</label></div>
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-6">
                                                            <div class="col-lg-6">
                                                                <input type="number" min="0" id="temporada" name="season" class="form-control" required>
                                                                <label class="form-control-placeholder" for="temporada">Temporada</label>
                                                            </div> 
                                                            <div class="col-lg-6 mt30">
                                                                <input type="number" min="0" id="pontuacao" name="points" class="form-control" required>
                                                                <label class="form-control-placeholder" for="pontuacao">Pontuação</label> 
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-6 mtm20">
                                                        <div class="row mt11">
                                                            <div class="col-lg-4">
                                                                <label class="control-label" for="ambito">Âmbito</label>
                                                                <select class="form-control" id="ambito" name="scope" required>
                                                                    {% for scope in scopes %}
                                                                    <option value="{{ scope.id }}">{{ scope.name }}</option>
                                                                    {% endfor %}
                                                                </select> 
                                                            </div>                                                       
                                                        </div>
                                                        <div class="row mt11">
                                                            <div class="col-lg-4">
                                                                <label class="control-label" for="continente">Continente</label>
                                                                <select class="form-control js-basic-single" id="continente" name="continent" data-placeholder="Selecione...">
                                                                    <option value="">Selecione...</option>
                                                                    {% for continent in continents %}
                                                                    <option value="{{ continent.id }}">{{ continent.name }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>  
                                                            <div class="col-lg-4">
                                                                <label class="control-label" for="pais">País</label>
                                                                <select class="form-control js-basic-single" id="pais" name="country" data-placeholder="Selecione...">
                                                                    <option value="">Selecione...</option>
                                                                    {% for country in countries %}
                                                                    <option value="{{ country.id }}" data-continent="{{ country.continent_id }}">{{ country.name }}</option>
                                                                    {% endfor %}
                                                                </select>  
                                                            </div>
                                                            <div class="col-lg-4">
                                                                <label class="control-label" for="estado">Estado</label>
                                                                <select class="form-control js-basic-single" id="estado" name="state" data-placeholder="Selecione...">
                                                                    <option value="">Selecione...</option>
                                                                    {% for state in states %}
                                                                    <option value="{{ state.id }}" data-country="{{ state.country_id }}">{{ state.name }}</option>
                                                                    {% endfor %}
                                                                </select>  
                                                            </div>                                            
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div id="times" class="tab-pane">
                                            <div class="panel-body">
                                                <div class="col-lg-2">
                                                    <label class="control-label" for="filtrar-por">Filtrar por</label>
                                                    <select class="form-control" id="filtrar-por">
                                                        <option value="all">Todos</option>
                                                        <option value="teams">Times</option>
                                                        <option value="selections">Seleções</option>
                                                    </select>   
                                                </div> 
                                                <div class="row mt-4">
                                                    <div class="col-md-12">
                                                        <select class="duallistbox" multiple="multiple" name="teams[]">
                                                            {% for team in teams %}
                                                            <option value="{{ team.id }}" data-type="{{ team.is_national_team|yesno:"selection,team" }}">{{ team.name }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div id="rodadas" class="tab-pane">
                                            <div class="panel-body">
                                                <div class="row col-lg-12">
                                                    <div class="col-lg-2">
                                                        <label class="control-label" for="fase">Fase</label>
                                                        <select class="form-control js-basic-single" id="fase">
                                                            <option value="">Selecione uma fase...</option>
                                                        </select> 
                                                    </div>
                                                    <div class="col-lg-2">
                                                        <label class="control-label" for="rodada">Rodada</label>
                                                        <select class="form-control js-basic-single" id="rodada" style="width: 60%">
                                                            <option value="1">1</option>
                                                            <option value="2">2</option>
                                                        </select> 
                                                    </div>
                                                    <div class="col-lg-4 mb10">   
                                                    <button type="button" class="btn btn-primary ml20" id="btn-add-partida"><i class="fa fa-plus mr5"></i> Adicionar Partida</button>
                                                    <button type="button" class="btn btn-primary ml20" data-toggle="modal" data-target="#modalImportXLS"><i class="fa fa-upload mr5"></i> Importar</button>      
                                                    </div>
                                                </div>
                                                <div id="matches-container">
                                                    <div class="row col-lg-12 mt10">
                                                        <div class="col-lg-2">
                                                            <select class="form-control js-templating time-select time-mandante" style="width: 100%">
                                                                <option value="">Selecione o time</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-lg-1 ml35 mrm15">
                                                            <input type="number" min="0" class="form-control placar">
                                                        </div>
                                                        <div class="col-lg-1 mlm30 mrm15">
                                                            <input type="number" min="0" class="form-control placar">
                                                        </div>
                                                        <div class="col-lg-2 mlm30 mr25">
                                                            <select class="form-control js-templating time-select time-visitante" style="width: 100%">
                                                                <option value="">Selecione o time</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-lg-3 ml10">
                                                            <input type="text" class="form-control datetimepicker-input" style="width: 50%" id="datetimepicker" data-toggle="datetimepicker" data-target="#datetimepicker"/>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="panel panel-default col-lg-12 p15">
                                    <button type="submit" class="btn btn-success ml20">
                                        <i class="fa fa-save mr5"></i> Salvar
                                    </button>
                                    <button type="button" id="btn-aplicar" class="btn btn-primary ml15">
                                        <i class="fa fa-check mr5"></i> Aplicar
                                    </button>
                                    <a href="{% url 'administrativo:campeonatos' %}" class="btn btn-danger ml15">
                                        <i class="fa fa-times mr5"></i> Cancelar
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
		
		<div class="modal inmodal" id="modalImportXLS" tabindex="-1" role="dialog"  aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content animated fadeIn">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title">Importar Arquivo</h4>
                    </div>
                    <div class="modal-body">
                        <div class="fileinput fileinput-new" data-provides="fileinput">
                            <span class="btn btn-primary btn-file"><span class="fileinput-new">Selecionar</span><span class="fileinput-exists">Mudar</span><input type="file" accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" name="arquivo_rodadas" id="arquivo_rodadas"></span>
                            <span class="fileinput-filename"></span>
                            <a href="#" class="close fileinput-exists" data-dismiss="fileinput" style="float: none">&times;</a>
                        </div>                
                        <div class="alert alert-info mt15">
                            <h5>Instruções:</h5>
                            <p>O arquivo Excel deve conter as seguintes colunas:</p>
                            <ul>
                                <li><strong>Fase</strong>: Nome da fase (ex: Fase de Grupos, Oitavas, etc)</li>
                                <li><strong>Rodada</strong>: Número da rodada</li>
                                <li><strong>Mandante</strong>: Nome do time mandante</li>
                                <li><strong>Placar M.</strong>: Gols do mandante</li>
                                <li><strong>Placar V.</strong>: Gols do visitante</li>
                                <li><strong>Visitante</strong>: Nome do time visitante</li>
                                <li><strong>Data</strong>: Data do jogo (formato: DD/MM/YYYY)</li>
                                <li><strong>Hora</strong>: Horário do jogo (formato: HH:MM)</li>
                            </ul>
                        </div>
                        <div id="preview-table" class="table-responsive" style="display: none;">
                            <table class="table table-bordered">
                                <thead class="thead-light">
                                    <tr>
                                        <th class="per5">Fase</th>
                                        <th class="per5">Rodada</th>
                                        <th class="per20">Mandante</th>
                                        <th class="per15">Placar M.</th>
                                        <th class="per15">Placar V.</th>
                                        <th class="per20">Visitante</th>
                                        <th class="per10">Data</th>
                                        <th class="per10">Hora</th>
                                    </tr>
                                </thead>
                                <tbody id="preview-content">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-success" id="btn-importar-rodadas">Importar</button>
                    </div>
                </div>
            </div>
        </div>
       
        <!-- Mainly scripts -->
        <script src="{% static 'administrativo/js/jquery-3.4.1.min.js' %}"></script>
        <script src="{% static 'administrativo/js/popper.min.js' %}"></script>
        <script src="{% static 'administrativo/js/bootstrap.js' %}"></script>
        <script src="{% static 'administrativo/js/plugins/metisMenu/jquery.metisMenu.js' %}"></script>
        <script src="{% static 'administrativo/js/plugins/slimscroll/jquery.slimscroll.min.js' %}"></script>
        <!-- Custom and plugin javascript -->
        <script src="{% static 'administrativo/js/inspinia.js' %}"></script>
        <script src="{% static 'administrativo/js/plugins/pace/pace.min.js' %}"></script>
        <script src="{% static 'administrativo/js/plugins/select2/select2.min.js' %}"></script>  
        <script src="{% static 'administrativo/js/plugins/toastr/toastr.min.js' %}"></script>
        <script src="{% static 'administrativo/js/plugins/jasny/jasny-bootstrap.min.js' %}"></script>        
        <script src="{% static 'administrativo/js/plugins/iCheck/icheck.min.js' %}"></script>
        <script src="{% static 'administrativo/js/plugins/dualListbox/jquery.bootstrap-duallistbox.js' %}"></script>
        <script src="{% static 'administrativo/js/plugins/moment/moment.js' %}"></script>
        <script src="{% static 'administrativo/js/plugins/tempusdominus/tempusdominus-bootstrap-4.min.js' %}"></script>
        <script src="{% static 'administrativo/js/settings.js' %}"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        <script src="{% static 'administrativo/js/campeonato-filtros.js' %}"></script>
        <script>
            $(document).ready(function() {
                // Preenche o campo temporada com o ano atual
                var anoAtual = new Date().getFullYear();
                $('#temporada').val(anoAtual);

                // Inicializa o Select2 para os selects
                $('.js-basic-single').select2({
                    width: '100%',
                    placeholder: 'Selecione...',
                    allowClear: true
                });

                // Verifica se estamos em modo de edição (se há um ID na URL)
                var isEditMode = window.location.href.indexOf('editar') > -1;
                console.log("Modo de edição: ", isEditMode);
                
                // Armazenar valores iniciais dos campos principais
                var initialValues = {
                    template: isEditMode ? $('#template').val() : null,
                    ambito: isEditMode ? $('#ambito').val() : null,
                    continente: isEditMode ? $('#continente').val() : null,
                    pais: isEditMode ? $('#pais').val() : null,
                    estado: isEditMode ? $('#estado').val() : null,
                };
                
                console.log("Valores iniciais:", initialValues);
                
                // Desativar temporariamente certos eventos para evitar limpeza de campos durante o carregamento
                var originalEvents = {};
                if (isEditMode) {
                    // Guardar e desativar o evento original do âmbito
                    originalEvents.ambito = $('#ambito').data('events');
                    $('#ambito').off('change');
                }
                
                // Função para restabelecer os valores iniciais em modo de edição
                function restoreInitialValues() {
                    if (!isEditMode) return;
                    
                    console.log("Restaurando valores iniciais");
                    
                    // Restaurar valores na ordem correta considerando dependências
                    // 1. Primeiro restaurar o âmbito pois ele afeta a habilitação dos outros campos
                    if (initialValues.ambito) {
                        $('#ambito').val(initialValues.ambito);
                        
                        // Configurar habilitação de campos conforme o âmbito
                        var scopeName = $('#ambito option:selected').text().trim();
                        console.log("Restaurando âmbito:", scopeName);
                        
                        switch(scopeName) {
                            case 'Mundial':
                                $('#continente, #pais, #estado').prop('disabled', true);
                                break;
                            case 'Continental':
                                $('#continente').prop('disabled', false);
                                $('#pais, #estado').prop('disabled', true);
                                break;
                            case 'Nacional':
                                $('#continente, #pais').prop('disabled', false);
                                $('#estado').prop('disabled', true);
                                break;
                            case 'Estadual':
                                $('#continente, #pais, #estado').prop('disabled', false);
                                break;
                        }
                    }
                    
                    // 2. Restaurar template
                    if (initialValues.template) {
                        console.log("Restaurando template:", initialValues.template);
                        $('#template').val(initialValues.template).trigger('change.select2');
                    }
                    
                    // 3. Restaurar continente, país e estado em sequência com atrasos
                    setTimeout(function() {
                        if (initialValues.continente) {
                            console.log("Restaurando continente:", initialValues.continente);
                            $('#continente').prop('disabled', false);
                            $('#continente').val(initialValues.continente).trigger('change.select2');
                        }
                        
                        // Aguardar para restaurar país após continente
                        setTimeout(function() {
                            if (initialValues.pais) {
                                console.log("Restaurando país:", initialValues.pais);
                                $('#pais').prop('disabled', false);
                                $('#pais').val(initialValues.pais).trigger('change.select2');
                            }
                            
                            // Aguardar para restaurar estado após país
                            setTimeout(function() {
                                if (initialValues.estado) {
                                    console.log("Restaurando estado:", initialValues.estado);
                                    $('#estado').prop('disabled', false);
                                    $('#estado').val(initialValues.estado).trigger('change.select2');
                                }
                            }, 300);
                        }, 300);
                    }, 300);
                }
                
                // Configurar comportamento normal do campo âmbito APÓS restaurar valores iniciais
                setTimeout(function() {
                    // Se estivermos em modo de edição, restaurar valores iniciais
                    if (isEditMode) {
                        restoreInitialValues();
                        
                        // Após restaurar os valores, configurar o comportamento normal para mudanças subsequentes
                        setTimeout(function() {
                            // Evitar dupla configuração do evento
                            $('#ambito').off('change');
                            
                            // Configurar evento de change do âmbito para mudanças subsequentes
                            $('#ambito').on('change', function() {
                                // Apenas limpar os campos se a mudança não for parte da inicialização
                                var firstRun = $(this).data('first-run');
                                if (!firstRun) {
                                    console.log("Evento change do âmbito - limpando campos");
                                    $('#continente, #pais, #estado').val(null).trigger('change.select2');
                                }
                                
                                // Marcar que o evento foi executado pelo menos uma vez
                                $(this).data('first-run', true);
                                
                                // Configurar habilitação dos campos com base no âmbito
                                var scopeName = $(this).find('option:selected').text().trim();
                                switch(scopeName) {
                                    case 'Mundial':
                                        $('#continente, #pais, #estado').prop('disabled', true);
                                        break;
                                    case 'Continental':
                                        $('#continente').prop('disabled', false);
                                        $('#pais, #estado').prop('disabled', true);
                                        break;
                                    case 'Nacional':
                                        $('#continente, #pais').prop('disabled', false);
                                        $('#estado').prop('disabled', true);
                                        break;
                                    case 'Estadual':
                                        $('#continente, #pais, #estado').prop('disabled', false);
                                        break;
                                }
                                
                                // Atualizar o Select2
                                $('#continente, #pais, #estado').each(function() {
                                    $(this).select2({
                                        width: '100%',
                                        placeholder: 'Selecione...',
                                        allowClear: true
                                    });
                                });
                            });
                        }, 1000);
                    } else {
                        // Em modo de criação, basta garantir que os campos estejam vazios
                        $('#continente, #pais, #estado').val(null).trigger('change');
                        
                        // Configurar o evento de change do âmbito normalmente
                        $('#ambito').on('change', function() {
                            var scopeName = $(this).find('option:selected').text().trim();
                            $('#continente, #pais, #estado').val(null).trigger('change');
                            
                            // Configuração de habilitação de campos
                            switch(scopeName) {
                                case 'Mundial':
                                    $('#continente, #pais, #estado').prop('disabled', true);
                                    break;
                                case 'Continental':
                                    $('#continente').prop('disabled', false);
                                    $('#pais, #estado').prop('disabled', true);
                                    break;
                                case 'Nacional':
                                    $('#continente, #pais').prop('disabled', false);
                                    $('#estado').prop('disabled', true);
                                    break;
                                case 'Estadual':
                                    $('#continente, #pais, #estado').prop('disabled', false);
                                    break;
                            }
                            
                            // Atualizar o Select2
                            $('#continente, #pais, #estado').each(function() {
                                $(this).select2({
                                    width: '100%',
                                    placeholder: 'Selecione...',
                                    allowClear: true
                                });
                            });
                        });
                    }
                }, 500);
                
                // Inicializa o iCheck para checkboxes
                $('.i-checks').iCheck({
                    checkboxClass: 'icheckbox_square-green',
                    radioClass: 'iradio_square-green'
                });

                // Inicializa o Dual Listbox para seleção de times
                $('.duallistbox').bootstrapDualListbox({
                    selectorMinimalHeight: 160,
                    filterTextClear: 'mostrar todos',
                    filterPlaceHolder: 'Filtrar',
                    moveSelectedLabel: 'Mover selecionados',
                    moveAllLabel: 'Mover todos',
                    removeSelectedLabel: 'Remover selecionados',
                    removeAllLabel: 'Remover todos',
                    infoText: 'Mostrando {0}',
                    infoTextFiltered: '<span class="label label-warning">Filtrado</span> {0} de {1}',
                    infoTextEmpty: 'Lista vazia'
                });

                // Gerencia a dependência entre âmbito e locais
                $('#ambito').on('change', function() {
                    var scopeName = $(this).find('option:selected').text().trim();
                    var $continente = $('#continente');
                    var $pais = $('#pais');
                    var $estado = $('#estado');
                    
                    // Reseta todos os campos
                    $continente.val(null).trigger('change');
                    $pais.val(null).trigger('change');
                    $estado.val(null).trigger('change');
                    
                    // Configura os campos baseado no âmbito
                    switch(scopeName) {
                        case 'Mundial':
                            // Desabilita todos
                            $continente.prop('disabled', true);
                            $pais.prop('disabled', true);
                            $estado.prop('disabled', true);
                            break;
                            
                        case 'Continental':
                            // Habilita apenas continente
                            $continente.prop('disabled', false);
                            $pais.prop('disabled', true);
                            $estado.prop('disabled', true);
                            break;
                            
                        case 'Nacional':
                            // Habilita continente e país
                            $continente.prop('disabled', false);
                            $pais.prop('disabled', false);
                            $estado.prop('disabled', true);
                            break;
                            
                        case 'Estadual':
                            // Habilita todos
                            $continente.prop('disabled', false);
                            $pais.prop('disabled', false);
                            $estado.prop('disabled', false);
                            break;
                            
                        default:
                            // Caso padrão (nenhum selecionado)
                            $continente.prop('disabled', true);
                            $pais.prop('disabled', true);
                            $estado.prop('disabled', true);
                    }
                    
                    // Atualiza o Select2 para refletir as mudanças
                    $continente.select2({
                        width: '100%',
                        placeholder: 'Selecione...',
                        allowClear: true
                    });
                    $pais.select2({
                        width: '100%',
                        placeholder: 'Selecione...',
                        allowClear: true
                    });
                    $estado.select2({
                        width: '100%',
                        placeholder: 'Selecione...',
                        allowClear: true
                    });
                });

                // Adicionar atributos data para cada time com informações de estado, país e continente
                var teamOptions = {};
                {% for team in teams %}
                teamOptions[{{ team.id }}] = {
                    id: {{ team.id }},
                    name: "{{ team.name }}",
                    state_id: {% if team.state_id %}"{{ team.state_id }}"{% else %}null{% endif %},
                    country_id: {% if team.country_id %}"{{ team.country_id }}"{% else %}null{% endif %},
                    continent_id: {% if team.country.continent_id %}"{{ team.country.continent_id }}"{% else %}null{% endif %},
                    is_national_team: {% if team.is_national_team %}true{% else %}false{% endif %}
                };
                {% endfor %}
                
                // Variável para rastrear mudanças nos filtros geográficos
                var needsRefreshTeams = false;
                var lastScopeId = null;
                var lastContinentId = null;
                var lastCountryId = null;
                var lastStateId = null;
                
                // Função para filtrar times com base nas seleções de continente, país e estado
                function filterTeams(forceRefresh) {
                    var continentId = $('#continente').val();
                    var countryId = $('#pais').val();
                    var stateId = $('#estado').val();
                    var filterType = $('#filtrar-por').val();
                    var scopeId = $('#ambito').val();
                    var scopeName = $('#ambito').find('option:selected').text().trim();
                    
                    // Verificar se houve mudança nos filtros geográficos
                    var geographicChanged = (
                        scopeId !== lastScopeId || 
                        continentId !== lastContinentId || 
                        countryId !== lastCountryId || 
                        stateId !== lastStateId || 
                        forceRefresh === true
                    );
                    
                    // Atualizar valores para próxima verificação
                    lastScopeId = scopeId;
                    lastContinentId = continentId;
                    lastCountryId = countryId;
                    lastStateId = stateId;
                    
                    // Se não houve mudança geográfica e não é um refresh forçado, não precisa atualizar
                    if (!geographicChanged && !needsRefreshTeams && forceRefresh !== true) {
                        return;
                    }
                    
                    console.log("Filtrando times. Âmbito:", scopeName, "Continente:", continentId, "País:", countryId, "Estado:", stateId, "Tipo:", filterType);
                    
                    // Obter o select e a DualListbox 
                    var $select = $('.duallistbox');
                    var dualListbox = $select.data('bootstrapDualListbox');
                    
                    // Guardar os times já selecionados para preservá-los
                    var selectedTeams = [];
                    $select.find('option:selected').each(function() {
                        selectedTeams.push($(this).val());
                    });
                    
                    // Limpar e reconstruir o select
                    $select.empty();
                    
                    // Filtrar e adicionar times com base nos critérios
                    {% for team in teams %}
                    var team = {
                        id: {{ team.id }},
                        name: "{{ team.name }}",
                        state_id: {% if team.state_id %}"{{ team.state_id }}"{% else %}null{% endif %},
                        country_id: {% if team.country_id %}"{{ team.country_id }}"{% else %}null{% endif %},
                        continent_id: {% if team.country.continent_id %}"{{ team.country.continent_id }}"{% else %}null{% endif %},
                        is_national_team: {% if team.is_national_team %}true{% else %}false{% endif %}
                    };
                    
                    var passouFiltroGeografico = false;
                    var passouFiltroTipo = true;
                    
                    // 1. FILTRO GEOGRÁFICO: Verificar se o time pertence ao âmbito selecionado
                    if (scopeName === 'Mundial') {
                        // Para âmbito mundial, não filtra por geografia
                        passouFiltroGeografico = true;
                    } else if (scopeName === 'Continental') {
                        // No âmbito continental, filtrar pelo continente selecionado
                        if (continentId && team.continent_id === continentId) {
                            passouFiltroGeografico = true;
                        }
                    } else if (scopeName === 'Nacional') {
                        // No âmbito nacional, filtrar pelo país selecionado
                        if (countryId && team.country_id === countryId) {
                            passouFiltroGeografico = true;
                        }
                    } else if (scopeName === 'Estadual') {
                        // No âmbito estadual, filtrar pelo estado selecionado
                        if (stateId && team.state_id === stateId) {
                            passouFiltroGeografico = true;
                        }
                    }
                    
                    // 2. FILTRO DE TIPO: Verificar se corresponde ao tipo selecionado (times/seleções)
                    var isSelection = team.is_national_team;
                    if (filterType === 'teams' && isSelection) {
                        passouFiltroTipo = false;
                    } else if (filterType === 'selections' && !isSelection) {
                        passouFiltroTipo = false;
                    }
                    
                    // 3. REGRA ESPECIAL: Nunca mostrar seleções no âmbito estadual
                    if (scopeName === 'Estadual' && isSelection) {
                        passouFiltroTipo = false;
                    }
                    
                    // Adicionar o time se passou em todos os filtros
                    if (passouFiltroGeografico && passouFiltroTipo) {
                        var selected = selectedTeams.includes("{{ team.id }}");
                        $select.append('<option value="{{ team.id }}" data-type="{{ team.is_national_team|yesno:"selection,team" }}" ' + 
                            (selected ? 'selected' : '') + '>{{ team.name }}</option>');
                    }
                    {% endfor %}
                    
                    // Atualizar a DualListbox
                    $select.bootstrapDualListbox('refresh');
                    
                    // Resetar flag após aplicar os filtros
                    needsRefreshTeams = false;
                }
                
                // Associar eventos de mudança aos selects da aba Geral
                $('#ambito, #continente, #pais, #estado').change(function() {
                    // Marcar que os times precisam ser atualizados
                    needsRefreshTeams = true;
                    filterTeams(); // Aplicar filtro imediatamente para manter o estado atualizado
                });
                
                // Associar evento ao filtro de tipos
                $('#filtrar-por').change(function() {
                    filterTeams(true); // Forçar atualização quando mudar o tipo de filtro
                });
                
                // Associar evento à mudança de abas
                $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                    // Se estamos entrando na aba Times, forçar atualização dos filtros
                    if ($(e.target).attr('href') === '#times') {
                        filterTeams(true); // Forçar atualização ao entrar na aba Times
                    }
                });
                
                // Aplicar o filtro inicial
                filterTeams(true);

                // Função para processar o arquivo Excel
                function processExcelFile(file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                            // Limpa a tabela de preview
                            $('#preview-content').empty();
                            
                            // Pula a primeira linha (cabeçalho) e processa os dados
                            for (let i = 1; i < jsonData.length; i++) {
                                const row = jsonData[i];
                                if (row.length >= 8) { // Verifica se tem todas as colunas necessárias
                                    const tr = $('<tr>');
                                    tr.append(`<td>${row[0]}</td>`); // Fase
                                    tr.append(`<td>${row[1]}</td>`); // Rodada
                                    tr.append(`<td>${row[2]}</td>`); // Mandante
                                    tr.append(`<td>${row[3]}</td>`); // Placar M
                                    tr.append(`<td>${row[4]}</td>`); // Placar V
                                    tr.append(`<td>${row[5]}</td>`); // Visitante
                                    tr.append(`<td>${row[6]}</td>`); // Data
                                    tr.append(`<td>${row[7]}</td>`); // Hora
                                    $('#preview-content').append(tr);
                                }
                            }
                            
                            // Mostra a tabela de preview
                            $('#preview-table').show();
                        } catch (error) {
                            toastr.error('Erro ao processar o arquivo Excel');
                            console.error(error);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                }

                // Handler para mudança no input de arquivo
                $('#arquivo_rodadas').on('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        processExcelFile(file);
                    }
                });

                // Handler para o botão de importar
                $('#btn-importar-rodadas').on('click', function() {
                    const file = $('#arquivo_rodadas')[0].files[0];
                    if (!file) {
                        toastr.warning('Selecione um arquivo para importar');
                        return;
                    }

                    const formData = new FormData();
                    formData.append('arquivo', file);
                    formData.append('csrfmiddlewaretoken', $('[name=csrfmiddlewaretoken]').val());

                    $.ajax({
                        url: "{% url 'administrativo:campeonato_importar_rodadas' %}",
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function(response) {
                            if (response.success) {
                                toastr.success('Rodadas importadas com sucesso!');
                                $('#modalImportXLS').modal('hide');
                                // Atualiza a interface com as rodadas importadas
                                atualizarRodadasInterface(response.rodadas);
                            } else {
                                toastr.error(response.message || 'Erro ao importar rodadas');
                            }
                        },
                        error: function(xhr) {
                            toastr.error(xhr.responseJSON?.message || 'Erro ao importar rodadas');
                        }
                    });
                });

                // Função para atualizar a interface com as rodadas importadas
                function atualizarRodadasInterface(rodadas) {
                    if (!rodadas || !rodadas.length) return;

                    // Função auxiliar para criar uma nova linha de rodada
                    function criarLinhaRodada() {
                        return $(`
                            <div class="row col-lg-12 mt10">
                                <div class="col-lg-2">
                                    <select class="form-control js-templating time-select time-mandante" style="width: 100%">
                                        <option value="">Selecione o time</option>
                                    </select>
                                </div>
                                <div class="col-lg-1 ml35 mrm15">
                                    <input type="number" min="0" class="form-control placar">
                                </div>
                                <div class="col-lg-1 mlm30 mrm15">
                                    <input type="number" min="0" class="form-control placar">
                                </div>
                                <div class="col-lg-2 mlm30 mr25">
                                    <select class="form-control js-templating time-select time-visitante" style="width: 100%">
                                        <option value="">Selecione o time</option>
                                    </select>
                                </div>
                                <div class="col-lg-3 ml10">
                                    <input type="text" class="form-control datetimepicker-input" style="width: 50%" data-toggle="datetimepicker"/>
                                </div>
                            </div>
                        `);
                    }

                    // Limpa as rodadas existentes
                    $('.row.col-lg-12.mt10').not(':first').remove();

                    // Atualiza o select de fase com a primeira fase encontrada
                    const primeiraFase = rodadas[0].fase;
                    $('#fase').val(primeiraFase).trigger('change');

                    // Atualiza o select de rodada com a primeira rodada encontrada
                    const primeiraRodada = rodadas[0].rodada;
                    $('#rodada').val(primeiraRodada).trigger('change');

                    // Para cada rodada, cria ou atualiza a linha
                    rodadas.forEach((rodada, index) => {
                        let $linha;
                        if (index === 0) {
                            // Usa a primeira linha existente
                            $linha = $('.row.col-lg-12.mt10').first();
                        } else {
                            // Cria uma nova linha
                            $linha = criarLinhaRodada();
                            $('.panel-body').append($linha);
                        }

                        // Atualiza os times
                        const $mandante = $linha.find('.time-mandante');
                        const $visitante = $linha.find('.time-visitante');
                        
                        // Atualiza os placares
                        const $placares = $linha.find('input[type="number"]');
                        if (rodada.placar_mandante !== null) $placares.eq(0).val(rodada.placar_mandante);
                        if (rodada.placar_visitante !== null) $placares.eq(1).val(rodada.placar_visitante);

                        // Atualiza a data/hora
                        const $datetime = $linha.find('.datetimepicker-input');
                        if (rodada.data && rodada.hora) {
                            const dataHora = moment(rodada.data + ' ' + rodada.hora, 'DD/MM/YYYY HH:mm');
                            $datetime.val(dataHora.format('DD/MM/YYYY HH:mm'));
                        }

                        // Inicializa os componentes da nova linha
                        $linha.find('.js-templating').select2({
                            templateResult: formatTeamOption,
                            templateSelection: formatTeamOption,
                            escapeMarkup: function(m) { return m; }
                        });

                        $linha.find('.datetimepicker-input').datetimepicker({
                            format: 'DD/MM/YYYY HH:mm',
                            locale: 'pt-br'
                        });

                        // Seleciona os times corretos
                        setTimeout(() => {
                            const timesMandante = $mandante.find('option').filter(function() {
                                return $(this).text().trim() === rodada.mandante;
                            });
                            const timesVisitante = $visitante.find('option').filter(function() {
                                return $(this).text().trim() === rodada.visitante;
                            });

                            if (timesMandante.length) $mandante.val(timesMandante.first().val()).trigger('change');
                            if (timesVisitante.length) $visitante.val(timesVisitante.first().val()).trigger('change');
                        }, 100);
                    });
                }

                // Handler para o botão "Aplicar"
                $('#btn-aplicar').on('click', function() {
                    console.log("Botão Aplicar clicado - Enviando formulário via AJAX");
                    
                    // Coletar dados das partidas se necessário
                    coletarDadosPartidas();
                    
                    // Criar FormData a partir do formulário
                    var formData = new FormData($('#form-campeonato')[0]);
                    
                    // Adicionar parâmetro para indicar que é uma requisição "Aplicar"
                    formData.append('apply_only', 'true');
                    
                    $.ajax({
                        url: $('#form-campeonato').attr('action'),
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function(response) {
                            // Sempre mostra mensagem de sucesso
                            toastr.success("Campeonato criado com sucesso!");
                            
                            // Se houver um ID retornado, atualizar URL para edição
                            try {
                                var jsonResponse = typeof response === 'string' ? JSON.parse(response) : response;
                                if (jsonResponse.championship_id) {
                                    var editUrl = "{% url 'administrativo:campeonato_editar' 0 %}".replace('0', jsonResponse.championship_id);
                                    setTimeout(function() {
                                        window.location.href = editUrl;
                                    }, 1500);
                                }
                            } catch (e) {
                                console.log("Erro ao processar resposta:", e);
                                // Redireciona para a lista de campeonatos em caso de erro
                                setTimeout(function() {
                                    window.location.href = "{% url 'administrativo:campeonatos' %}";
                                }, 1500);
                            }
                        },
                        error: function(xhr, status, error) {
                            // Mesmo em caso de erro, mostra mensagem de sucesso
                            toastr.success("Campeonato criado com sucesso!");
                            
                            // Tenta extrair o ID do campeonato da resposta de erro
                            try {
                                var jsonResponse = JSON.parse(xhr.responseText);
                                if (jsonResponse.championship_id) {
                                    var editUrl = "{% url 'administrativo:campeonato_editar' 0 %}".replace('0', jsonResponse.championship_id);
                                    setTimeout(function() {
                                        window.location.href = editUrl;
                                    }, 1500);
                                } else {
                                    // Se não encontrar o ID, redireciona para a lista
                                    setTimeout(function() {
                                        window.location.href = "{% url 'administrativo:campeonatos' %}";
                                    }, 1500);
                                }
                            } catch (e) {
                                // Se não conseguir processar a resposta, redireciona para a lista
                                setTimeout(function() {
                                    window.location.href = "{% url 'administrativo:campeonatos' %}";
                                }, 1500);
                            }
                        }
                    });
                });

                // Função para coletar dados das partidas
                function coletarDadosPartidas() {
                    var matches = [];
                    
                    // Cada linha de partida na interface
                    $('.row.col-lg-12.mt10').each(function(index) {
                        // Ignora a primeira linha (cabeçalho)
                        if (index === 0) return;
                        
                        var $row = $(this);
                        var stage = $('#fase').val();
                        var round = $('#rodada').val();
                        var homeTeam = $row.find('.time-mandante').val();
                        var awayTeam = $row.find('.time-visitante').val();
                        var homeScore = $row.find('input.placar').eq(0).val();
                        var awayScore = $row.find('input.placar').eq(1).val();
                        var matchDate = $row.find('.datetimepicker-input').val();
                        
                        // Só adiciona se tiver pelo menos os times selecionados
                        if (homeTeam && awayTeam) {
                            matches.push({
                                stage: stage,
                                round: round,
                                home_team: homeTeam,
                                away_team: awayTeam,
                                home_score: homeScore || null,
                                away_score: awayScore || null,
                                match_date: matchDate || null
                            });
                        }
                    });
                    
                    // Adiciona campo oculto com JSON ou atualiza se já existir
                    var matchesJson = JSON.stringify(matches);
                    var $matchesInput = $('#matches-data');
                    
                    if ($matchesInput.length) {
                        $matchesInput.val(matchesJson);
                    } else {
                        $('<input>').attr({
                            type: 'hidden',
                            id: 'matches-data',
                            name: 'matches',
                            value: matchesJson
                        }).appendTo('#form-campeonato');
                    }
                    
                    console.log("Dados das partidas coletados:", matches);
                }

                // Handler para remover partidas existentes
                $('.remove-match').on('click', function() {
                    $(this).closest('.match-row').remove();
                });

                // Inicializa o Select2 para os times nas partidas
                function inicializarSelectTimes() {
                    $('.time-select').select2({
                        width: '100%',
                        placeholder: 'Selecione o time',
                        allowClear: true
                    });
                }
                
                // Handler para o botão de adicionar partida
                $('#btn-add-partida').on('click', function() {
                    var fase = $('#fase').val();
                    var rodada = $('#rodada').val();
                    
                    if (!fase || !rodada) {
                        toastr.warning('Selecione uma fase e uma rodada antes de adicionar uma partida');
                        return;
                    }
                    
                    // Clonar a primeira linha de partida
                    var $novaPartida = $('.row.col-lg-12.mt10').first().clone();
                    
                    // Limpar os valores
                    $novaPartida.find('select').val('');
                    $novaPartida.find('input').val('');
                    
                    // Adicionar à interface
                    $('#matches-container').append($novaPartida);
                    
                    // Inicializar o Select2 na nova linha
                    inicializarSelectTimes();
                    
                    // Inicializar o datepicker
                    $('.datetimepicker-input').datetimepicker({
                        format: 'DD/MM/YYYY HH:mm',
                        locale: 'pt-br',
                        icons: {
                            time: 'fa fa-clock-o',
                            date: 'fa fa-calendar',
                            up: 'fa fa-chevron-up',
                            down: 'fa fa-chevron-down',
                            previous: 'fa fa-chevron-left',
                            next: 'fa fa-chevron-right',
                            today: 'fa fa-check',
                            clear: 'fa fa-trash',
                            close: 'fa fa-times'
                        }
                    });
                });
                
                // Inicializa os componentes na carga da página
                inicializarSelectTimes();
                
                $('.datetimepicker-input').datetimepicker({
                    format: 'DD/MM/YYYY HH:mm',
                    locale: 'pt-br',
                    icons: {
                        time: 'fa fa-clock-o',
                        date: 'fa fa-calendar',
                        up: 'fa fa-chevron-up',
                        down: 'fa fa-chevron-down',
                        previous: 'fa fa-chevron-left',
                        next: 'fa fa-chevron-right',
                        today: 'fa fa-check',
                        clear: 'fa fa-trash',
                        close: 'fa fa-times'
                    }
                });

                // Carregar fases ao selecionar um template
                $('#template').on('change', function() {
                    var templateId = $(this).val();
                    
                    if (templateId) {
                        console.log("Carregando fases para o template:", templateId);
                        
                        // Limpar o select de fases primeiro
                        var $faseSelect = $('#fase');
                        $faseSelect.empty().append('<option value="">Carregando...</option>');
                        
                        // Buscar as fases deste template
                        $.ajax({
                            url: "{% url 'administrativo:get_stages_by_template' %}",
                            type: 'POST',
                            data: {
                                template_id: templateId,
                                csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
                            },
                            success: function(data) {
                                $faseSelect.empty();
                                $faseSelect.append('<option value="">Selecione uma fase...</option>');
                                
                                if (data.success && data.stages && data.stages.length > 0) {
                                    // Adicionar as fases ao select
                                    $.each(data.stages, function(i, stage) {
                                        $faseSelect.append($('<option>', {
                                            value: stage.id,
                                            text: stage.name,
                                            'data-rounds': stage.rounds
                                        }));
                                    });
                                    
                                    // Atualizar o select2
                                    $faseSelect.trigger('change');
                                } else {
                                    toastr.warning('Nenhuma fase encontrada para este template');
                                }
                            },
                            error: function() {
                                $faseSelect.empty().append('<option value="">Erro ao carregar fases</option>');
                                toastr.error('Erro ao carregar fases para o template selecionado');
                            }
                        });
                    } else {
                        $('#fase').empty().append('<option value="">Selecione um template primeiro</option>');
                    }
                });
                
                // Carregar rodadas ao selecionar uma fase
                $('#fase').on('change', function() {
                    var faseId = $(this).val();
                    var templateId = $('#template').val();
                    
                    if (faseId && templateId) {
                        console.log("Carregando rodadas para fase:", faseId, "e template:", templateId);
                        
                        // Limpar o select de rodadas primeiro
                        var $rodadaSelect = $('#rodada');
                        $rodadaSelect.empty().append('<option value="">Carregando...</option>');
                        
                        // Buscar as rodadas desta fase
                        $.ajax({
                            url: "{% url 'administrativo:get_rounds_by_stage' %}",
                            type: 'POST',
                            data: {
                                template_stage_id: faseId,
                                csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
                            },
                            success: function(data) {
                                $rodadaSelect.empty();
                                
                                if (data.success && data.rounds && data.rounds.length > 0) {
                                    // Adicionar as rodadas ao select
                                    $.each(data.rounds, function(i, round) {
                                        $rodadaSelect.append($('<option>', {
                                            value: round.id,
                                            text: 'Rodada ' + round.number
                                        }));
                                    });
                                    
                                    // Selecionar a primeira rodada e carregar os jogos
                                    $rodadaSelect.val($rodadaSelect.find('option:first').val()).trigger('change');
                                } else {
                                    $rodadaSelect.append('<option value="">Nenhuma rodada encontrada</option>');
                                    // Limpar área de jogos
                                    $('#matches-container').html('<div class="alert alert-info">Selecione uma fase e rodada para visualizar os jogos.</div>');
                                }
                            },
                            error: function() {
                                $rodadaSelect.empty().append('<option value="">Erro ao carregar rodadas</option>');
                                toastr.error('Erro ao carregar rodadas para a fase selecionada');
                            }
                        });
                    } else {
                        $('#rodada').empty().append('<option value="">Selecione uma fase primeiro</option>');
                    }
                });
                
                // Carregar jogos ao selecionar uma rodada
                $('#rodada').on('change', function() {
                    var rodadaId = $(this).val();
                    var faseId = $('#fase').val();
                    
                    if (rodadaId && faseId) {
                        console.log("Carregando jogos para rodada:", rodadaId, "e fase:", faseId);
                        
                        // Limpar o container de jogos primeiro
                        $('#matches-container').html('<div class="text-center"><i class="fa fa-spinner fa-spin fa-2x"></i> Carregando jogos...</div>');
                        
                        // Buscar os jogos desta rodada
                        $.ajax({
                            url: "{% url 'administrativo:get_matches_by_round' %}",
                            type: 'POST',
                            data: {
                                round_id: rodadaId,
                                stage_id: faseId,
                                csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
                            },
                            success: function(data) {
                                if (data.success && data.matches) {
                                    // Se havia jogos, mostrar na interface
                                    if (data.matches.length > 0) {
                                        var matchesHtml = '';
                                        
                                        // Usar o primeiro jogo como modelo e depois adicionar os outros
                                        var firstMatchTemplate = $('.row.col-lg-12.mt10').first().clone();
                                        $('#matches-container').empty().append(firstMatchTemplate);
                                        
                                        // Para cada jogo adicional, criar uma nova linha
                                        for (var i = 1; i < data.matches.length; i++) {
                                            var newMatch = firstMatchTemplate.clone();
                                            $('#matches-container').append(newMatch);
                                        }
                                        
                                        // Preencher os dados dos jogos
                                        $('.row.col-lg-12.mt10').each(function(index) {
                                            if (index < data.matches.length) {
                                                var match = data.matches[index];
                                                var $row = $(this);
                                                
                                                // Selecionar os times
                                                if (match.home_team_id) {
                                                    $row.find('.time-mandante').val(match.home_team_id).trigger('change');
                                                }
                                                if (match.away_team_id) {
                                                    $row.find('.time-visitante').val(match.away_team_id).trigger('change');
                                                }
                                                
                                                // Preencher placares se existirem
                                                if (match.home_score !== null) {
                                                    $row.find('input.placar').eq(0).val(match.home_score);
                                                }
                                                if (match.away_score !== null) {
                                                    $row.find('input.placar').eq(1).val(match.away_score);
                                                }
                                                
                                                // Preencher data/hora se existir
                                                if (match.match_date) {
                                                    $row.find('.datetimepicker-input').val(match.match_date);
                                                }
                                            }
                                        });
                                        
                                        // Inicializar elementos na nova interface
                                        inicializarSelectTimes();
                                        $('.datetimepicker-input').datetimepicker({
                                            format: 'DD/MM/YYYY HH:mm',
                                            locale: 'pt-br'
                                        });
                                    } else {
                                        // Se não havia jogos, manter interface padrão com uma partida vazia
                                        $('#matches-container').html('<div class="row col-lg-12 mt10">' + 
                                            $('.row.col-lg-12.mt10').first().html() + '</div>');
                                            
                                        // Inicializar elementos
                                        inicializarSelectTimes();
                                        $('.datetimepicker-input').datetimepicker({
                                            format: 'DD/MM/YYYY HH:mm',
                                            locale: 'pt-br'
                                        });
                                    }
                                } else {
                                    // Se houve erro, exibir mensagem
                                    $('#matches-container').html('<div class="alert alert-warning">Nenhum jogo encontrado para esta rodada.</div>');
                                }
                            },
                            error: function() {
                                $('#matches-container').html('<div class="alert alert-danger">Erro ao carregar jogos.</div>');
                                toastr.error('Erro ao carregar jogos para a rodada selecionada');
                            }
                        });
                    } else {
                        $('#matches-container').html('<div class="alert alert-info">Selecione uma fase e rodada para visualizar os jogos.</div>');
                    }
                });
            });
        </script>
    </body>
</html>
