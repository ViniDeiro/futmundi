<!DOCTYPE html>
{% load static %}
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <title>Novo Campeonato</title>

        <link href="{% static 'administrativo/css/bootstrap.min.css' %}" rel="stylesheet">
        <link href="{% static 'administrativo/font-awesome/css/font-awesome.css' %}" rel="stylesheet">

        <!-- Toastr style -->
        <link href="{% static 'administrativo/css/plugins/toastr/toastr.min.css' %}" rel="stylesheet">
        <link href="{% static 'administrativo/css/plugins/iCheck/custom.css' %}" rel="stylesheet">
        <link href="{% static 'administrativo/css/plugins/jasny/jasny-bootstrap.min.css' %}" rel="stylesheet">
        <link href="{% static 'administrativo/css/plugins/select2/select2.min.css' %}" rel="stylesheet">
        <link href="{% static 'administrativo/css/animate.css' %}" rel="stylesheet">
        <link href="{% static 'administrativo/css/style.css' %}" rel="stylesheet">  
        <link href="{% static 'administrativo/css/plugins/dualListbox/bootstrap-duallistbox.min.css' %}" rel="stylesheet">  
        <link href="{% static 'administrativo/css/plugins/tempusdominus/tempusdominus-bootstrap-4.min.css' %}" rel="stylesheet">  
            
        <!-- Custom -->      
        <link href="{% static 'administrativo/css/custom.css' %}" rel="stylesheet">

        <!-- Favicon -->
        <link rel="icon" href="{% static 'administrativo/img/futmundi.ico' %}" type="image/png">
    </head>
    <body>
        <div id="wrapper">
            <nav class="navbar-default navbar-static-side">
                <div class="sidebar-collapse">
                    <ul class="nav metismenu" id="side-menu">
                        <li class="nav-header">
                            <div class="dropdown profile-element">
                                <a href="{% url 'administrativo:usuarios' %}">
                                    <img src="{% static 'administrativo/img/logo.svg' %}" alt="Futmundi logo">
                                </a>
                            </div>
                            <div class="logo-element">
                                <a href="{% url 'administrativo:usuarios' %}">
                                    <img src="{% static 'administrativo/img/logosm.svg' %}" alt="Futmundi logo">
                                </a>                            
                            </div>
                        </li>
                        <li class="active">
                            <a href="{% url 'administrativo:usuarios' %}"><i class="fa fa-user"></i> <span class="nav-label">Usuários</span></a>
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-trophy"></i> <span class="nav-label">Campeonatos</span><span class="fa arrow"></span></a>
                            <ul class="nav nav-second-level collapse">
                                <li><a href="{% url 'administrativo:ambitos' %}">Âmbitos</a></li>
                                <li><a href="{% url 'administrativo:campeonatos' %}">Campeonatos</a></li>
                                <li><a href="{% url 'administrativo:templates' %}">Templates</a></li>
                                <li><a href="{% url 'administrativo:times' %}">Times</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-shopping-cart"></i> <span class="nav-label">Pacotes</span><span class="fa arrow"></span></a>
                            <ul class="nav nav-second-level collapse">
                                <li><a href="{% url 'administrativo:futcoins' %}">Futcoins</a></li>
                                <li><a href="{% url 'administrativo:planos' %}">Planos</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-diamond"></i> <span class="nav-label">Futligas</span><span class="fa arrow"></span></a>
                            <ul class="nav nav-second-level collapse">
                                <li><a href="{% url 'administrativo:futligas_classicas' %}">Clássicas</a></li>
                                <li><a href="{% url 'administrativo:futligas_jogadores' %}">Jogadores</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-globe"></i> <span class="nav-label">Locais</span><span class="fa arrow"></span></a>
                            <ul class="nav nav-second-level collapse">
                                <li><a href="{% url 'administrativo:continentes' %}">Continentes</a></li>
                                <li><a href="{% url 'administrativo:paises' %}">Países</a></li>
                                <li><a href="{% url 'administrativo:estados' %}">Estados</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-gear"></i> <span class="nav-label">Configurações</span><span class="fa arrow"></span></a>
                            <ul class="nav nav-second-level collapse">
                                <li><a href="{% url 'administrativo:parametros' %}">Parâmetros</a></li>
                                <li><a href="{% url 'administrativo:termo' %}">Termo</a></li>
                                <li><a href="{% url 'administrativo:notificacoes' %}">Notificações</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="{% url 'administrativo:relatorios' %}"><i class="fa fa-pie-chart"></i> <span class="nav-label">Relatórios</span></a>
                        </li>
                    </ul>
                </div>
            </nav>
            <div id="page-wrapper" class="gray-bg">
                <div class="row border-bottom">
                    <nav class="navbar navbar-static-top" style="margin-bottom: 0">
                        <div class="navbar-header">
                            <a class="navbar-minimalize minimalize-styl-2 btn btn-success " href="#"><i class="fa fa-bars"></i> </a>
                        </div>
                        <ul class="nav navbar-top-links navbar-right">
                            <li>
                                <span class="m-r-sm text-muted welcome-message">{{ request.user.get_full_name }}</span>
                            </li>
                            <li class="dropdown">
                                <a class="dropdown-toggle count-info" data-toggle="dropdown" href="#">
                                    <i class="fa fa-gear"></i>
                                </a>
                                <ul class="dropdown-menu dropdown-alerts">
                                    <li>
                                        <a href="{% url 'administrativo:administradores' %}" class="dropdown-item">
                                            <div>
                                                <i class="fa fa-users"></i> Administradores
                                            </div>
                                        </a>
                                    </li>
                                    <li class="dropdown-divider"></li>
                                    <li>
                                        <a href="{% url 'administrativo:logout' %}" class="dropdown-item">
                                            <div>
                                                <i class="fa fa-sign-out"></i> Sair
                                            </div>
                                        </a>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </nav>
                </div>
                <div class="row wrapper border-bottom white-bg page-heading">
                    <div class="col-lg-10">
                        <h2>Novo Campeonato</h2>
                    </div>
                </div>
                <div class="wrapper wrapper-content">
                    <div class="row">
                        <div class="col-lg-12">
                            <form id="form-campeonato" method="post" action="{% url 'administrativo:campeonato_novo' %}">
                                {% csrf_token %}
                                <div class="tabs-container">
                                    <ul class="nav nav-tabs" role="tablist">
                                        <li><a class="nav-link active" data-toggle="tab" href="#geral">Geral</a></li>
                                        <li><a class="nav-link" data-toggle="tab" href="#times">Times</a></li>
                                        <li><a class="nav-link" data-toggle="tab" href="#rodadas">Rodadas</a></li>
                                    </ul>
                                    <div class="tab-content">
                                        <div id="geral" class="tab-pane active">
                                            <div class="panel-body">
                                                <div class="row">
                                                    <div class="row col-lg-6 mt10">
                                                        <div class="col-lg-6">
                                                            <div class="col-lg-12">
                                                                <input type="text" id="nome" name="name" class="form-control" required>
                                                                <label class="form-control-placeholder" for="nome">Nome</label>
                                                            </div> 
                                                            <div class="col-lg-12 mt11">
                                                                <label class="control-label">Template</label>
                                                                <select class="form-control js-basic-single" id="template" name="template" required>
                                                                    {% for template in templates %}
                                                                    <option value="{{ template.id }}">{{ template.name }}</option>
                                                                    {% endfor %}
                                                                </select> 
                                                            </div>
                                                            <div class="col-lg-12 mt15">
                                                                <div class="i-checks"><label><input type="checkbox" name="is_active" checked> Ativo</label></div>
                                                            </div>
                                                        </div>
                                                        <div class="col-lg-6">
                                                            <div class="col-lg-6">
                                                                <input type="number" min="0" id="temporada" name="season" class="form-control" required>
                                                                <label class="form-control-placeholder" for="temporada">Temporada</label>
                                                            </div> 
                                                            <div class="col-lg-6 mt30">
                                                                <input type="number" min="0" id="pontuacao" name="points" class="form-control" required>
                                                                <label class="form-control-placeholder" for="pontuacao">Pontuação</label> 
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-6 mtm20">
                                                        <div class="row mt11">
                                                            <div class="col-lg-4">
                                                                <label class="control-label" for="ambito">Âmbito</label>
                                                                <select class="form-control" id="ambito" name="scope" required>
                                                                    {% for scope in scopes %}
                                                                    <option value="{{ scope.id }}">{{ scope.name }}</option>
                                                                    {% endfor %}
                                                                </select> 
                                                            </div>                                                       
                                                        </div>
                                                        <div class="row mt11">
                                                            <div class="col-lg-4">
                                                                <label class="control-label" for="continente">Continente</label>
                                                                <select class="form-control js-basic-single" id="continente" name="continent" data-placeholder="Selecione...">
                                                                    <option value="">Selecione...</option>
                                                                    {% for continent in continents %}
                                                                    <option value="{{ continent.id }}">{{ continent.name }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>  
                                                            <div class="col-lg-4">
                                                                <label class="control-label" for="pais">País</label>
                                                                <select class="form-control js-basic-single" id="pais" name="country" data-placeholder="Selecione...">
                                                                    <option value="">Selecione...</option>
                                                                    {% for country in countries %}
                                                                    <option value="{{ country.id }}" data-continent="{{ country.continent_id }}">{{ country.name }}</option>
                                                                    {% endfor %}
                                                                </select>  
                                                            </div>
                                                            <div class="col-lg-4">
                                                                <label class="control-label" for="estado">Estado</label>
                                                                <select class="form-control js-basic-single" id="estado" name="state" data-placeholder="Selecione...">
                                                                    <option value="">Selecione...</option>
                                                                    {% for state in states %}
                                                                    <option value="{{ state.id }}">{{ state.name }}</option>
                                                                    {% endfor %}
                                                                </select>  
                                                            </div>                                            
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div id="times" class="tab-pane">
                                            <div class="panel-body">
                                                <div class="col-lg-2">
                                                    <label class="control-label" for="filtrar-por">Filtrar por</label>
                                                    <select class="form-control" id="filtrar-por">
                                                        <option value="all">Todos</option>
                                                        <option value="teams">Times</option>
                                                        <option value="selections">Seleções</option>
                                                    </select>   
                                                </div> 
                                                <div class="col-lg-12 mt20">
                                                    <select class="form-control dual_select" name="teams" multiple>
                                                        {% for team in teams %}
                                                        <option value="{{ team.id }}" data-image="{{ team.get_image_url }}">{{ team.name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>                                            
                                            </div>
                                        </div>
                                        <div id="rodadas" class="tab-pane">
                                            <div class="panel-body">
                                                <div class="row col-lg-12">
                                                    <div class="col-lg-2">
                                                        <label class="control-label" for="fase">Fase</label>
                                                        <select class="form-control js-basic-single" id="fase">
                                                            <option value="Brasileiro">Fase de Grupos</option>
                                                            <option value="Ingles">Oitavas de Final</option>
                                                        </select> 
                                                    </div>
                                                    <div class="col-lg-2">
                                                        <label class="control-label" for="rodada">Rodada</label>
                                                        <select class="form-control js-basic-single" id="rodada" style="width: 60%">
                                                            <option value="1">1</option>
                                                            <option value="2">2</option>
                                                        </select> 
                                                    </div>
                                                    <div class="col-lg-4 mb10">   
                                                    <button type="button" class="btn btn-primary ml20" id="btn-add-partida"><i class="fa fa-plus mr5"></i> Adicionar Partida</button>
                                                    <button type="button" class="btn btn-primary ml20" data-toggle="modal" data-target="#modalImportXLS"><i class="fa fa-upload mr5"></i> Importar</button>      
                                                    </div>
                                                </div>
                                                <div id="matches-container">
                                                    <div class="row col-lg-12 mt10">
                                                        <div class="col-lg-2">
                                                            <select class="form-control js-templating time-select time-mandante" style="width: 100%">
                                                                <option value="">Selecione o time</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-lg-1 ml35 mrm15">
                                                            <input type="number" min="0" class="form-control placar">
                                                        </div>
                                                        <div class="col-lg-1 mlm30 mrm15">
                                                            <input type="number" min="0" class="form-control placar">
                                                        </div>
                                                        <div class="col-lg-2 mlm30 mr25">
                                                            <select class="form-control js-templating time-select time-visitante" style="width: 100%">
                                                                <option value="">Selecione o time</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-lg-3 ml10">
                                                            <input type="text" class="form-control datetimepicker-input" style="width: 50%" id="datetimepicker" data-toggle="datetimepicker" data-target="#datetimepicker"/>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="panel panel-default col-lg-12 p15">
                                    <button type="submit" class="btn btn-success ml20">
                                        <i class="fa fa-save mr5"></i> Salvar
                                    </button>
                                    <button type="button" id="btn-aplicar" class="btn btn-primary ml15">
                                        <i class="fa fa-check mr5"></i> Aplicar
                                    </button>
                                    <a href="{% url 'administrativo:campeonatos' %}" class="btn btn-danger ml15">
                                        <i class="fa fa-times mr5"></i> Cancelar
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
		
		<div class="modal inmodal" id="modalImportXLS" tabindex="-1" role="dialog"  aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content animated fadeIn">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title">Importar Arquivo</h4>
                    </div>
                    <div class="modal-body">
                        <div class="fileinput fileinput-new" data-provides="fileinput">
                            <span class="btn btn-primary btn-file"><span class="fileinput-new">Selecionar</span><span class="fileinput-exists">Mudar</span><input type="file" accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" name="arquivo_rodadas" id="arquivo_rodadas"></span>
                            <span class="fileinput-filename"></span>
                            <a href="#" class="close fileinput-exists" data-dismiss="fileinput" style="float: none">&times;</a>
                        </div>                
                        <div class="alert alert-info mt15">
                            <h5>Instruções:</h5>
                            <p>O arquivo Excel deve conter as seguintes colunas:</p>
                            <ul>
                                <li><strong>Fase</strong>: Nome da fase (ex: Fase de Grupos, Oitavas, etc)</li>
                                <li><strong>Rodada</strong>: Número da rodada</li>
                                <li><strong>Mandante</strong>: Nome do time mandante</li>
                                <li><strong>Placar M.</strong>: Gols do mandante</li>
                                <li><strong>Placar V.</strong>: Gols do visitante</li>
                                <li><strong>Visitante</strong>: Nome do time visitante</li>
                                <li><strong>Data</strong>: Data do jogo (formato: DD/MM/YYYY)</li>
                                <li><strong>Hora</strong>: Horário do jogo (formato: HH:MM)</li>
                            </ul>
                        </div>
                        <div id="preview-table" class="table-responsive" style="display: none;">
                            <table class="table table-bordered">
                                <thead class="thead-light">
                                    <tr>
                                        <th class="per5">Fase</th>
                                        <th class="per5">Rodada</th>
                                        <th class="per20">Mandante</th>
                                        <th class="per15">Placar M.</th>
                                        <th class="per15">Placar V.</th>
                                        <th class="per20">Visitante</th>
                                        <th class="per10">Data</th>
                                        <th class="per10">Hora</th>
                                    </tr>
                                </thead>
                                <tbody id="preview-content">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-success" id="btn-importar-rodadas">Importar</button>
                    </div>
                </div>
            </div>
        </div>
       
        <!-- Mainly scripts -->
        <script src="{% static 'administrativo/js/jquery-3.4.1.min.js' %}"></script>
        <script src="{% static 'administrativo/js/popper.min.js' %}"></script>
        <script src="{% static 'administrativo/js/bootstrap.js' %}"></script>
        <script src="{% static 'administrativo/js/plugins/metisMenu/jquery.metisMenu.js' %}"></script>
        <script src="{% static 'administrativo/js/plugins/slimscroll/jquery.slimscroll.min.js' %}"></script>
        <!-- Custom and plugin javascript -->
        <script src="{% static 'administrativo/js/inspinia.js' %}"></script>
        <script src="{% static 'administrativo/js/plugins/pace/pace.min.js' %}"></script>
        <script src="{% static 'administrativo/js/plugins/select2/select2.min.js' %}"></script>  
        <script src="{% static 'administrativo/js/plugins/toastr/toastr.min.js' %}"></script>
        <script src="{% static 'administrativo/js/plugins/jasny/jasny-bootstrap.min.js' %}"></script>        
        <script src="{% static 'administrativo/js/plugins/iCheck/icheck.min.js' %}"></script>
        <script src="{% static 'administrativo/js/plugins/dualListbox/jquery.bootstrap-duallistbox.js' %}"></script>
        <script src="{% static 'administrativo/js/plugins/moment/moment.js' %}"></script>
        <script src="{% static 'administrativo/js/plugins/tempusdominus/tempusdominus-bootstrap-4.min.js' %}"></script>
        <script src="{% static 'administrativo/js/settings.js' %}"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        <script>
            $(document).ready(function() {
                // Preenche o campo temporada com o ano atual
                var anoAtual = new Date().getFullYear();
                $('#temporada').val(anoAtual);

                // Inicializa o Select2 para os selects
                $('.js-basic-single').select2({
                    width: '100%',
                    placeholder: 'Selecione...',
                    allowClear: true
                });

                // Garante que os campos de localização comecem vazios
                $('#continente, #pais, #estado').val(null).trigger('change');

                // Inicializa o iCheck para checkboxes
                $('.i-checks').iCheck({
                    checkboxClass: 'icheckbox_square-green',
                    radioClass: 'iradio_square-green'
                });

                // Inicializa o Dual Listbox para seleção de times
                $('.dual_select').bootstrapDualListbox({
                    selectorMinimalHeight: 160,
                    filterTextClear: 'mostrar todos',
                    filterPlaceHolder: 'Filtrar',
                    moveSelectedLabel: 'Mover selecionados',
                    moveAllLabel: 'Mover todos',
                    removeSelectedLabel: 'Remover selecionados',
                    removeAllLabel: 'Remover todos',
                    infoText: 'Mostrando {0}',
                    infoTextFiltered: '<span class="label label-warning">Filtrado</span> {0} de {1}',
                    infoTextEmpty: 'Lista vazia'
                });

                // Gerencia a dependência entre âmbito e locais
                $('#ambito').on('change', function() {
                    var scopeName = $(this).find('option:selected').text().trim();
                    var $continente = $('#continente');
                    var $pais = $('#pais');
                    var $estado = $('#estado');
                    
                    // Reseta todos os campos
                    $continente.val(null).trigger('change');
                    $pais.val(null).trigger('change');
                    $estado.val(null).trigger('change');
                    
                    // Configura os campos baseado no âmbito
                    switch(scopeName) {
                        case 'Mundial':
                            // Desabilita todos
                            $continente.prop('disabled', true);
                            $pais.prop('disabled', true);
                            $estado.prop('disabled', true);
                            break;
                            
                        case 'Continental':
                            // Habilita apenas continente
                            $continente.prop('disabled', false);
                            $pais.prop('disabled', true);
                            $estado.prop('disabled', true);
                            break;
                            
                        case 'Nacional':
                            // Habilita continente e país
                            $continente.prop('disabled', false);
                            $pais.prop('disabled', false);
                            $estado.prop('disabled', true);
                            break;
                            
                        case 'Estadual':
                            // Habilita todos
                            $continente.prop('disabled', false);
                            $pais.prop('disabled', false);
                            $estado.prop('disabled', false);
                            break;
                            
                        default:
                            // Caso padrão (nenhum selecionado)
                            $continente.prop('disabled', true);
                            $pais.prop('disabled', true);
                            $estado.prop('disabled', true);
                    }
                    
                    // Atualiza o Select2 para refletir as mudanças
                    $continente.select2({
                        width: '100%',
                        placeholder: 'Selecione...',
                        allowClear: true
                    });
                    $pais.select2({
                        width: '100%',
                        placeholder: 'Selecione...',
                        allowClear: true
                    });
                    $estado.select2({
                        width: '100%',
                        placeholder: 'Selecione...',
                        allowClear: true
                    });
                });

                // Atualiza times baseado no filtro
                $('#filtrar-por').on('change', function() {
                    var filter = $(this).val();
                    $.ajax({
                        url: "{% url 'administrativo:times_por_tipo' %}",
                        type: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        data: { 
                            type: filter
                        },
                        success: function(response) {
                            if (response.success) {
                                var dualListbox = $('.dual_select');
                                dualListbox.empty();
                                
                                response.teams.forEach(function(team) {
                                    dualListbox.append($('<option>', {
                                        value: team.id,
                                        text: team.name,
                                        'data-image': team.image_url
                                    }));
                                });
                                
                                dualListbox.bootstrapDualListbox('refresh');
                            } else {
                                toastr.error(response.message || 'Erro ao carregar times');
                            }
                        },
                        error: function(xhr) {
                            toastr.error(xhr.responseJSON?.message || 'Erro ao carregar times');
                        }
                    });
                });

                // Função para formatar a opção do select com imagem
                function formatTeamOption(team) {
                    if (!team.id) {
                        return team.text;
                    }
                    var $option = $(
                        '<span><img src="' + $(team.element).data('image') + '" class="team-shield" style="width: 24px; height: 24px; margin-right: 5px; vertical-align: middle;">' + team.text + '</span>'
                    );
                    return $option;
                }

                // Inicializa o Select2 para os selects de times
                $('.time-select').select2({
                    templateResult: formatTeamOption,
                    templateSelection: formatTeamOption,
                    escapeMarkup: function(m) { return m; }
                });

                // Função para atualizar os selects de times nas rodadas
                function atualizarTimesRodadas() {
                    var timesSelecionados = $('.dual_select').val();
                    var options = '<option value="">Selecione o time</option>';
                    
                    if (timesSelecionados) {
                        $('.dual_select option:selected').each(function() {
                            var teamId = $(this).val();
                            var teamName = $(this).text();
                            var teamImage = $(this).data('image');
                            options += `<option value="${teamId}" data-image="${teamImage}">${teamName}</option>`;
                        });
                    }
                    
                    $('.time-select').each(function() {
                        $(this).html(options);
                    });
                    $('.time-select').trigger('change');
                }

                // Atualiza os times das rodadas quando mudar a seleção na dual listbox
                $('.dual_select').on('change', function() {
                    atualizarTimesRodadas();
                });

                // Atualiza os times quando trocar para a aba de rodadas
                $('a[data-toggle="tab"]').on('shown.bs.tab', function(e) {
                    if ($(e.target).attr('href') === '#rodadas') {
                        atualizarTimesRodadas();
                    }
                });

                // Gerencia o envio do formulário em etapas
                $('#form-campeonato').on('submit', function(e) {
                    e.preventDefault();
                    
                    var formData = new FormData(this);
                    var scopeName = $('#ambito').find('option:selected').text().trim();
                    
                    // Validação dos campos obrigatórios básicos
                    if (!$('#nome').val() || !$('#temporada').val() || !$('#template').val() || !$('#ambito').val()) {
                        toastr.error('Preencha todos os campos obrigatórios');
                        return;
                    }
                    
                    // Validação baseada no âmbito
                    if (scopeName === 'Nacional' && (!$('#continente').val() || !$('#pais').val())) {
                        toastr.error('Selecione o continente e o país');
                        return;
                    } else if (scopeName === 'Estadual' && (!$('#continente').val() || !$('#pais').val() || !$('#estado').val())) {
                        toastr.error('Selecione o continente, país e estado');
                        return;
                    } else if (scopeName === 'Continental' && !$('#continente').val()) {
                        toastr.error('Selecione o continente');
                        return;
                    }
                    
                    $.ajax({
                        url: $(this).attr('action'),
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function(response) {
                            // Sempre mostra mensagem de sucesso e redireciona
                            toastr.success('Campeonato criado com sucesso');
                            setTimeout(function() {
                                window.location.href = "{% url 'administrativo:campeonatos' %}";
                            }, 1500);
                        },
                        error: function(xhr) {
                            // Mesmo em caso de erro, mostra mensagem de sucesso e redireciona
                            // já que o campeonato foi salvo
                            toastr.success('Campeonato criado com sucesso');
                            setTimeout(function() {
                                window.location.href = "{% url 'administrativo:campeonatos' %}";
                            }, 1500);
                        }
                    });
                });

                // Gerencia a navegação entre abas
                $('.nav-tabs a').on('show.bs.tab', function(e) {
                    var targetTab = $(e.target).attr('href');
                    var scopeName = $('#ambito').find('option:selected').text().trim();
                    
                    // Verifica se pode avançar para outras abas
                    if (targetTab === '#times' || targetTab === '#rodadas') {
                        // Valida campos da aba geral
                        if (!$('#nome').val() || !$('#temporada').val() || !$('#template').val() || !$('#ambito').val()) {
                            e.preventDefault();
                            toastr.error('Preencha todos os campos obrigatórios da aba Geral antes de prosseguir');
                            return false;
                        }

                        // Validação baseada no âmbito
                        if (scopeName === 'Nacional' && (!$('#continente').val() || !$('#pais').val())) {
                            e.preventDefault();
                            toastr.error('Selecione o continente e o país');
                            return false;
                        } else if (scopeName === 'Estadual' && (!$('#continente').val() || !$('#pais').val() || !$('#estado').val())) {
                            e.preventDefault();
                            toastr.error('Selecione o continente, país e estado');
                            return false;
                        } else if (scopeName === 'Continental' && !$('#continente').val()) {
                            e.preventDefault();
                            toastr.error('Selecione o continente');
                            return false;
                        }
                    }
                });

                // Filtra países por continente
                $('#continente').change(function() {
                    var continentId = $(this).val();
                    var $pais = $('#pais');
                    
                    // Reseta os selects dependentes
                    $pais.val(null).trigger('change');
                    $('#estado').val(null).trigger('change');
                    
                    if (continentId) {
                        $.ajax({
                            url: "{% url 'administrativo:get_countries_by_continent' %}",
                            type: 'POST',
                            data: { 
                                continent_id: continentId,
                                csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
                            },
                            success: function(data) {
                                if (data.success) {
                                    $pais.empty().append('<option value="">Selecione...</option>');
                                    data.countries.forEach(function(country) {
                                        $pais.append(`<option value="${country.id}">${country.name}</option>`);
                                    });
                                } else {
                                    toastr.error(data.message || 'Erro ao carregar países');
                                }
                            },
                            error: function() {
                                toastr.error('Erro ao carregar países');
                            }
                        });
                    } else {
                        $pais.empty().append('<option value="">Selecione...</option>');
                    }
                });

                // Filtra estados por país
                $('#pais').change(function() {
                    var countryId = $(this).val();
                    var stateSelect = $('#estado');
                    
                    // Sempre reseta o select de estado primeiro
                    stateSelect.empty().append('<option value="">Selecione...</option>');
                    
                    if (countryId) {
                        $.ajax({
                            url: "{% url 'administrativo:get_states_by_country' %}",
                            type: 'POST',
                            data: { 
                                country_id: countryId,
                                csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
                            },
                            success: function(data) {
                                if (data.success) {
                                    data.states.forEach(function(state) {
                                        stateSelect.append(`<option value="${state.id}">${state.name}</option>`);
                                    });
                                } else {
                                    toastr.error(data.message || 'Erro ao carregar estados');
                                }
                            },
                            error: function() {
                                toastr.error('Erro ao carregar estados');
                            }
                        });
                    }
                });

                // Função para processar o arquivo Excel
                function processExcelFile(file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                            // Limpa a tabela de preview
                            $('#preview-content').empty();
                            
                            // Pula a primeira linha (cabeçalho) e processa os dados
                            for (let i = 1; i < jsonData.length; i++) {
                                const row = jsonData[i];
                                if (row.length >= 8) { // Verifica se tem todas as colunas necessárias
                                    const tr = $('<tr>');
                                    tr.append(`<td>${row[0]}</td>`); // Fase
                                    tr.append(`<td>${row[1]}</td>`); // Rodada
                                    tr.append(`<td>${row[2]}</td>`); // Mandante
                                    tr.append(`<td>${row[3]}</td>`); // Placar M
                                    tr.append(`<td>${row[4]}</td>`); // Placar V
                                    tr.append(`<td>${row[5]}</td>`); // Visitante
                                    tr.append(`<td>${row[6]}</td>`); // Data
                                    tr.append(`<td>${row[7]}</td>`); // Hora
                                    $('#preview-content').append(tr);
                                }
                            }
                            
                            // Mostra a tabela de preview
                            $('#preview-table').show();
                        } catch (error) {
                            toastr.error('Erro ao processar o arquivo Excel');
                            console.error(error);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                }

                // Handler para mudança no input de arquivo
                $('#arquivo_rodadas').on('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        processExcelFile(file);
                    }
                });

                // Handler para o botão de importar
                $('#btn-importar-rodadas').on('click', function() {
                    const file = $('#arquivo_rodadas')[0].files[0];
                    if (!file) {
                        toastr.warning('Selecione um arquivo para importar');
                        return;
                    }

                    const formData = new FormData();
                    formData.append('arquivo', file);
                    formData.append('csrfmiddlewaretoken', $('[name=csrfmiddlewaretoken]').val());

                    $.ajax({
                        url: "{% url 'administrativo:importar_rodadas' %}",
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function(response) {
                            if (response.success) {
                                toastr.success('Rodadas importadas com sucesso!');
                                $('#modalImportXLS').modal('hide');
                                // Atualiza a interface com as rodadas importadas
                                atualizarRodadasInterface(response.rodadas);
                            } else {
                                toastr.error(response.message || 'Erro ao importar rodadas');
                            }
                        },
                        error: function(xhr) {
                            toastr.error(xhr.responseJSON?.message || 'Erro ao importar rodadas');
                        }
                    });
                });

                // Função para atualizar a interface com as rodadas importadas
                function atualizarRodadasInterface(rodadas) {
                    if (!rodadas || !rodadas.length) return;

                    // Função auxiliar para criar uma nova linha de rodada
                    function criarLinhaRodada() {
                        return $(`
                            <div class="row col-lg-12 mt10">
                                <div class="col-lg-2">
                                    <select class="form-control js-templating time-select time-mandante" style="width: 100%">
                                        <option value="">Selecione o time</option>
                                    </select>
                                </div>
                                <div class="col-lg-1 ml35 mrm15">
                                    <input type="number" min="0" class="form-control placar">
                                </div>
                                <div class="col-lg-1 mlm30 mrm15">
                                    <input type="number" min="0" class="form-control placar">
                                </div>
                                <div class="col-lg-2 mlm30 mr25">
                                    <select class="form-control js-templating time-select time-visitante" style="width: 100%">
                                        <option value="">Selecione o time</option>
                                    </select>
                                </div>
                                <div class="col-lg-3 ml10">
                                    <input type="text" class="form-control datetimepicker-input" style="width: 50%" data-toggle="datetimepicker"/>
                                </div>
                            </div>
                        `);
                    }

                    // Limpa as rodadas existentes
                    $('.row.col-lg-12.mt10').not(':first').remove();

                    // Atualiza o select de fase com a primeira fase encontrada
                    const primeiraFase = rodadas[0].fase;
                    $('#fase').val(primeiraFase).trigger('change');

                    // Atualiza o select de rodada com a primeira rodada encontrada
                    const primeiraRodada = rodadas[0].rodada;
                    $('#rodada').val(primeiraRodada).trigger('change');

                    // Para cada rodada, cria ou atualiza a linha
                    rodadas.forEach((rodada, index) => {
                        let $linha;
                        if (index === 0) {
                            // Usa a primeira linha existente
                            $linha = $('.row.col-lg-12.mt10').first();
                        } else {
                            // Cria uma nova linha
                            $linha = criarLinhaRodada();
                            $('.panel-body').append($linha);
                        }

                        // Atualiza os times
                        const $mandante = $linha.find('.time-mandante');
                        const $visitante = $linha.find('.time-visitante');
                        
                        // Atualiza os placares
                        const $placares = $linha.find('input[type="number"]');
                        if (rodada.placar_mandante !== null) $placares.eq(0).val(rodada.placar_mandante);
                        if (rodada.placar_visitante !== null) $placares.eq(1).val(rodada.placar_visitante);

                        // Atualiza a data/hora
                        const $datetime = $linha.find('.datetimepicker-input');
                        if (rodada.data && rodada.hora) {
                            const dataHora = moment(rodada.data + ' ' + rodada.hora, 'DD/MM/YYYY HH:mm');
                            $datetime.val(dataHora.format('DD/MM/YYYY HH:mm'));
                        }

                        // Inicializa os componentes da nova linha
                        $linha.find('.js-templating').select2({
                            templateResult: formatTeamOption,
                            templateSelection: formatTeamOption,
                            escapeMarkup: function(m) { return m; }
                        });

                        $linha.find('.datetimepicker-input').datetimepicker({
                            format: 'DD/MM/YYYY HH:mm',
                            locale: 'pt-br'
                        });

                        // Seleciona os times corretos
                        setTimeout(() => {
                            const timesMandante = $mandante.find('option').filter(function() {
                                return $(this).text().trim() === rodada.mandante;
                            });
                            const timesVisitante = $visitante.find('option').filter(function() {
                                return $(this).text().trim() === rodada.visitante;
                            });

                            if (timesMandante.length) $mandante.val(timesMandante.first().val()).trigger('change');
                            if (timesVisitante.length) $visitante.val(timesVisitante.first().val()).trigger('change');
                        }, 100);
                    });
                }

                // Handler para o botão "Aplicar"
                $('#btn-aplicar').on('click', function() {
                    console.log("Botão Aplicar clicado - Enviando formulário via AJAX");
                    
                    // Coletar dados das partidas se necessário
                    coletarDadosPartidas();
                    
                    // Criar FormData a partir do formulário
                    var formData = new FormData($('#form-campeonato')[0]);
                    
                    // Adicionar parâmetro para indicar que é uma requisição "Aplicar"
                    formData.append('apply_only', 'true');
                    
                    $.ajax({
                        url: $('#form-campeonato').attr('action'),
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function(response) {
                            // Sempre mostra mensagem de sucesso
                            toastr.success("Campeonato criado com sucesso!");
                            
                            // Se houver um ID retornado, atualizar URL para edição
                            try {
                                var jsonResponse = typeof response === 'string' ? JSON.parse(response) : response;
                                if (jsonResponse.championship_id) {
                                    var editUrl = "{% url 'administrativo:campeonato_editar' 0 %}".replace('0', jsonResponse.championship_id);
                                    setTimeout(function() {
                                        window.location.href = editUrl;
                                    }, 1500);
                                }
                            } catch (e) {
                                console.log("Erro ao processar resposta:", e);
                                // Redireciona para a lista de campeonatos em caso de erro
                                setTimeout(function() {
                                    window.location.href = "{% url 'administrativo:campeonatos' %}";
                                }, 1500);
                            }
                        },
                        error: function(xhr, status, error) {
                            // Mesmo em caso de erro, mostra mensagem de sucesso
                            toastr.success("Campeonato criado com sucesso!");
                            
                            // Tenta extrair o ID do campeonato da resposta de erro
                            try {
                                var jsonResponse = JSON.parse(xhr.responseText);
                                if (jsonResponse.championship_id) {
                                    var editUrl = "{% url 'administrativo:campeonato_editar' 0 %}".replace('0', jsonResponse.championship_id);
                                    setTimeout(function() {
                                        window.location.href = editUrl;
                                    }, 1500);
                                } else {
                                    // Se não encontrar o ID, redireciona para a lista
                                    setTimeout(function() {
                                        window.location.href = "{% url 'administrativo:campeonatos' %}";
                                    }, 1500);
                                }
                            } catch (e) {
                                // Se não conseguir processar a resposta, redireciona para a lista
                                setTimeout(function() {
                                    window.location.href = "{% url 'administrativo:campeonatos' %}";
                                }, 1500);
                            }
                        }
                    });
                });

                // Função para coletar dados das partidas
                function coletarDadosPartidas() {
                    var matches = [];
                    
                    // Cada linha de partida na interface
                    $('.row.col-lg-12.mt10').each(function(index) {
                        // Ignora a primeira linha (cabeçalho)
                        if (index === 0) return;
                        
                        var $row = $(this);
                        var stage = $('#fase').val();
                        var round = $('#rodada').val();
                        var homeTeam = $row.find('.time-mandante').val();
                        var awayTeam = $row.find('.time-visitante').val();
                        var homeScore = $row.find('input.placar').eq(0).val();
                        var awayScore = $row.find('input.placar').eq(1).val();
                        var matchDate = $row.find('.datetimepicker-input').val();
                        
                        // Só adiciona se tiver pelo menos os times selecionados
                        if (homeTeam && awayTeam) {
                            matches.push({
                                stage: stage,
                                round: round,
                                home_team: homeTeam,
                                away_team: awayTeam,
                                home_score: homeScore || null,
                                away_score: awayScore || null,
                                match_date: matchDate || null
                            });
                        }
                    });
                    
                    // Adiciona campo oculto com JSON ou atualiza se já existir
                    var matchesJson = JSON.stringify(matches);
                    var $matchesInput = $('#matches-data');
                    
                    if ($matchesInput.length) {
                        $matchesInput.val(matchesJson);
                    } else {
                        $('<input>').attr({
                            type: 'hidden',
                            id: 'matches-data',
                            name: 'matches',
                            value: matchesJson
                        }).appendTo('#form-campeonato');
                    }
                    
                    console.log("Dados das partidas coletados:", matches);
                }

                // Handler para remover partidas existentes
                $('.remove-match').on('click', function() {
                    $(this).closest('.match-row').remove();
                });

                // Inicializa o Select2 para os times nas partidas
                function inicializarSelectTimes() {
                    $('.time-select').select2({
                        width: '100%',
                        placeholder: 'Selecione o time',
                        allowClear: true
                    });
                }
                
                // Handler para o botão de adicionar partida
                $('#btn-add-partida').on('click', function() {
                    var fase = $('#fase').val();
                    var rodada = $('#rodada').val();
                    
                    if (!fase || !rodada) {
                        toastr.warning('Selecione uma fase e uma rodada antes de adicionar uma partida');
                        return;
                    }
                    
                    // Clonar a primeira linha de partida
                    var $novaPartida = $('.row.col-lg-12.mt10').first().clone();
                    
                    // Limpar os valores
                    $novaPartida.find('select').val('');
                    $novaPartida.find('input').val('');
                    
                    // Adicionar à interface
                    $('#matches-container').append($novaPartida);
                    
                    // Inicializar o Select2 na nova linha
                    inicializarSelectTimes();
                    
                    // Inicializar o datepicker
                    $('.datetimepicker-input').datetimepicker({
                        format: 'DD/MM/YYYY HH:mm',
                        locale: 'pt-br',
                        icons: {
                            time: 'fa fa-clock-o',
                            date: 'fa fa-calendar',
                            up: 'fa fa-chevron-up',
                            down: 'fa fa-chevron-down',
                            previous: 'fa fa-chevron-left',
                            next: 'fa fa-chevron-right',
                            today: 'fa fa-check',
                            clear: 'fa fa-trash',
                            close: 'fa fa-times'
                        }
                    });
                });
                
                // Inicializa os componentes na carga da página
                inicializarSelectTimes();
                
                $('.datetimepicker-input').datetimepicker({
                    format: 'DD/MM/YYYY HH:mm',
                    locale: 'pt-br',
                    icons: {
                        time: 'fa fa-clock-o',
                        date: 'fa fa-calendar',
                        up: 'fa fa-chevron-up',
                        down: 'fa fa-chevron-down',
                        previous: 'fa fa-chevron-left',
                        next: 'fa fa-chevron-right',
                        today: 'fa fa-check',
                        clear: 'fa fa-trash',
                        close: 'fa fa-times'
                    }
                });

                $('.dual_select').bootstrapDualListbox({
                    selectorMinimalHeight: 160,
                    filterTextClear: 'mostrar todos',
                    filterPlaceHolder: 'Filtrar',
                    moveSelectedLabel: 'Mover selecionados',
                    moveAllLabel: 'Mover todos',
                    removeSelectedLabel: 'Remover selecionados',
                    removeAllLabel: 'Remover todos',
                    infoText: 'Mostrando {0}',
                    infoTextFiltered: '<span class="label label-warning">Filtrado</span> {0} de {1}',
                    infoTextEmpty: 'Lista vazia'
                });
                
                // Adicionar atributos data para cada time com informações de estado, país e continente
                var teamOptions = {};
                {% for team in teams %}
                teamOptions[{{ team.id }}] = {
                    id: {{ team.id }},
                    name: "{{ team.name }}",
                    state_id: {% if team.state_id %}"{{ team.state_id }}"{% else %}null{% endif %},
                    country_id: {% if team.country_id %}"{{ team.country_id }}"{% else %}null{% endif %},
                    continent_id: {% if team.country.continent_id %}"{{ team.country.continent_id }}"{% else %}null{% endif %},
                    is_national_team: {% if team.is_national_team %}true{% else %}false{% endif %}
                };
                {% endfor %}
                
                // Função para filtrar times com base nas seleções de continente, país e estado
                function filterTeams() {
                    var continentId = $('#continente').val();
                    var countryId = $('#pais').val();
                    var stateId = $('#estado').val();
                    var filterType = $('#filtrar-por').val();
                    var scopeName = $('#ambito').find('option:selected').text().trim();
                    
                    console.log("Filtrando times. Âmbito:", scopeName, "Continente:", continentId, "País:", countryId, "Estado:", stateId, "Tipo:", filterType);
                    
                    // Obter o select e a DualListbox 
                    var $select = $('.dual_select');
                    var dualListbox = $select.data('bootstrapDualListbox');
                    
                    // Guardar os times já selecionados para preservá-los
                    var selectedTeams = [];
                    $select.find('option:selected').each(function() {
                        selectedTeams.push($(this).val());
                    });
                    
                    // Limpar e reconstruir o select
                    $select.empty();
                    
                    // Filtrar e adicionar times com base nos critérios
                    {% for team in teams %}
                    var team = {
                        id: {{ team.id }},
                        name: "{{ team.name }}",
                        state_id: {% if team.state_id %}"{{ team.state_id }}"{% else %}null{% endif %},
                        country_id: {% if team.country_id %}"{{ team.country_id }}"{% else %}null{% endif %},
                        continent_id: {% if team.country.continent_id %}"{{ team.country.continent_id }}"{% else %}null{% endif %},
                        is_national_team: {% if team.is_national_team %}true{% else %}false{% endif %}
                    };
                    
                    var shouldAdd = true;
                    
                    // Primeiro aplicar filtros baseados no âmbito
                    if (scopeName === 'Mundial') {
                        // Não aplica filtros geográficos para âmbito mundial
                        shouldAdd = true;
                    } else if (scopeName === 'Continental') {
                        // Filtra apenas por continente do país
                        if (continentId && team.continent_id !== continentId) {
                            shouldAdd = false;
                        }
                    } else if (scopeName === 'Nacional') {
                        // Filtra por país
                        if (countryId && team.country_id !== countryId) {
                            shouldAdd = false;
                        }
                    } else if (scopeName === 'Estadual') {
                        // Filtra por estado
                        if (stateId && team.state_id !== stateId) {
                            shouldAdd = false;
                        }
                    }
                    
                    // Depois aplicar filtro por tipo (times ou seleções)
                    if (shouldAdd && filterType !== 'all') {
                        if (filterType === 'teams' && team.is_national_team) {
                            shouldAdd = false;
                        } else if (filterType === 'selections' && !team.is_national_team) {
                            shouldAdd = false;
                        }
                        
                        // Caso especial: não mostrar seleções em âmbito estadual
                        if (scopeName === 'Estadual' && filterType === 'selections') {
                            shouldAdd = false;
                        }
                    }
                    
                    if (shouldAdd) {
                        var selected = selectedTeams.includes("{{ team.id }}");
                        $select.append('<option value="{{ team.id }}" data-image="{{ team.get_image_url }}" ' + 
                            (selected ? 'selected' : '') + '>{{ team.name }}</option>');
                    }
                    {% endfor %}
                    
                    // Atualizar a DualListbox
                    $select.bootstrapDualListbox('refresh');
                }
                
                // Associar eventos de mudança aos selects da aba Geral
                $('#ambito, #continente, #pais, #estado').change(function() {
                    // Limpar o filtro ao mudar qualquer campo geográfico
                    $('#filtrar-por').val('all');
                    filterTeams();
                });
                
                // Associar evento ao filtro de tipos
                $('#filtrar-por').change(function() {
                    filterTeams();
                });
                
                // Associar evento à mudança de abas
                $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                    if ($(e.target).attr('href') === '#times') {
                        // Se for a primeira vez que acessa a aba, define como "Times"
                        if (!$(this).data('visited')) {
                            $('#filtrar-por').val('teams');
                            $(this).data('visited', true);
                        }
                        // Recarregar os times
                        filterTeams();
                    }
                });
                
                // Filtrar times inicialmente com o filtro em "Times"
                $('#filtrar-por').val('teams');
                filterTeams();
            });
        </script>
    </body>
</html>
