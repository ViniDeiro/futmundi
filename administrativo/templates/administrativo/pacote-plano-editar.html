{% extends 'administrativo/pacote-plano-novo.html' %}

{% block title %}Editar Pacote{% endblock %}

{% block heading %}
<h2>Editar Pacote</h2>
{% endblock %}

{% block form_data %}
<script>
    // Configuração do CSRF token para requisições AJAX
    var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();
    
    function csrfSafeMethod(method) {
        // Estes métodos HTTP não requerem proteção CSRF
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });
    
    // Função para validar e formatar cores
    function validateColor(color) {
        if (!color) return '#000000';
        
        // Remove espaços e converte para minúsculas
        color = color.trim().toLowerCase();
        
        // Se já estiver no formato #RRGGBB, retorna como está
        if (/^#[0-9a-f]{6}$/.test(color)) {
            return color.toUpperCase();
        }
        
        // Se estiver no formato RGB(r,g,b), converte para hex
        let rgbMatch = color.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
        if (rgbMatch) {
            let r = parseInt(rgbMatch[1]);
            let g = parseInt(rgbMatch[2]);
            let b = parseInt(rgbMatch[3]);
            return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`.toUpperCase();
        }
        
        // Se for rgba, remove o canal alpha e converte para hex
        let rgbaMatch = color.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*[\d.]+\)/);
        if (rgbaMatch) {
            let r = parseInt(rgbaMatch[1]);
            let g = parseInt(rgbaMatch[2]);
            let b = parseInt(rgbaMatch[3]);
            return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`.toUpperCase();
        }
        
        // Se não estiver em nenhum formato válido, retorna preto
        return '#000000';
    }
    
    // Função para formatar data para exibição (YYYY-MM-DD HH:MM:SS -> DD/MM/YYYY HH:MM)
    function formatDateForDisplay(dateStr) {
        if (!dateStr) return '';
        
        try {
            // Tenta criar um objeto moment com a string de data
            var dateMoment = moment(dateStr);
            if (dateMoment.isValid()) {
                return dateMoment.format('DD/MM/YYYY HH:mm');
            }
            return '';
        } catch (e) {
            console.error('Erro ao formatar data para exibição:', e);
            return '';
        }
    }
    
    $(document).ready(function() {
        // Adiciona campos ocultos para armazenar as datas formatadas
        $('body').append('<input type="hidden" id="hidden_start_date">');
        $('body').append('<input type="hidden" id="hidden_end_date">');
        $('body').append('<input type="hidden" id="should_remove_image" name="should_remove_image" value="no">');
        // Adiciona campos ocultos para cores da etiqueta
        $('body').append('<input type="hidden" id="hidden_color_text_label">');
        $('body').append('<input type="hidden" id="hidden_color_background_label">');
        
        // Configura os datepickers
        $('#datetimepicker, #datetimepicker2').datetimepicker({
            format: 'DD/MM/YYYY HH:mm',
            locale: 'pt-br',
            icons: {
                time: 'fa fa-clock-o',
                date: 'fa fa-calendar',
                up: 'fa fa-chevron-up',
                down: 'fa fa-chevron-down',
                previous: 'fa fa-chevron-left',
                next: 'fa fa-chevron-right',
                today: 'fa fa-screenshot',
                clear: 'fa fa-trash',
                close: 'fa fa-remove'
            }
        });
        
        // Preenche os dados do plano
        const planData = JSON.parse('{{ plan_data|safe }}');
        console.log('Dados do plano recebidos:', planData);
        console.log('Valor de enabled recebido:', planData.enabled);
        console.log('Tipo do enabled:', typeof planData.enabled);
        
        // Preencher campos básicos
        $('#nome').val(planData.name || '');
        $('#plano').val(planData.plan || '');
        $('#vigencia').val(planData.billing_cycle || '');
        $('#tipo').val(planData.package_type || 'Padrão');
        $('#preco-padrao').val(planData.full_price || '');
        $('#preco-promocional').val(planData.promotional_price || '');
        $('#exibir-para').val(planData.show_to || 'Todos');
        
        // Configurar o checkbox de enabled - usando a mesma lógica do pacote-futcoin-editar.html
        var isEnabled = planData.enabled === true || planData.enabled === 'true' || planData.enabled === 1;
        console.log('Valor de enabled interpretado:', isEnabled);
        $('#enabled').iCheck(isEnabled ? 'check' : 'uncheck');
        
        $('#codigo-android').val(planData.android_product_code || '');
        $('#codigo-apple').val(planData.apple_product_code || '');
        $('#codigo-gateway').val(planData.gateway_product_code || '');
        
        console.log('Código Android carregado:', planData.android_product_code);
        console.log('Código Apple carregado:', planData.apple_product_code);
        console.log('Código Gateway carregado:', planData.gateway_product_code);
        console.log('Valor do campo código Android:', $('#codigo-android').val());
        console.log('Valor do campo código Apple:', $('#codigo-apple').val());
        console.log('Valor do campo código Gateway:', $('#codigo-gateway').val());
        
        // Define as cores nos color pickers
        $('#id3').colorpicker('setValue', planData.color_text_label || '#FFFFFF');
        $('#id4').colorpicker('setValue', planData.color_background_label || '#CC000C');
        
        // Atualiza também os campos ocultos para as cores
        $('#hidden_color_text_label').val(planData.color_text_label || '#FFFFFF');
        $('#hidden_color_background_label').val(planData.color_background_label || '#CC000C');
        
        // Adiciona listeners para atualizar os campos ocultos quando as cores mudarem
        $('#id3').on('changeColor', function(e) {
            $('#hidden_color_text_label').val(e.color.toString('hex'));
            console.log('Cor de texto atualizada:', e.color.toString('hex'));
        });
        
        $('#id4').on('changeColor', function(e) {
            $('#hidden_color_background_label').val(e.color.toString('hex'));
            console.log('Cor de fundo atualizada:', e.color.toString('hex'));
        });
        
        // Log para depuração das cores da etiqueta
        console.log('Valores da etiqueta ao carregar:');
        console.log('- Label:', planData.label);
        console.log('- Cor de texto:', planData.color_text_label);
        console.log('- Cor de fundo:', planData.color_background_label);
        console.log('- Campo etiqueta:', $('#etiqueta').val());
        console.log('- Colorpicker texto:', $('#id3').colorpicker('getValue'));
        console.log('- Colorpicker fundo:', $('#id4').colorpicker('getValue'));
        
        // Inicializa os datepickers com moment.js para garantir o formato correto
        if (planData.start_date) {
            console.log('Definindo data de início:', planData.start_date);
            $('#datetimepicker').val(planData.start_date);
            $('#hidden_start_date').val(planData.start_date);
            
            // Inicializa o datepicker com o valor
            try {
                $('#datetimepicker').datetimepicker('date', moment(planData.start_date, 'DD/MM/YYYY HH:mm'));
                console.log('Datepicker de início inicializado com sucesso');
            } catch (e) {
                console.error('Erro ao inicializar datepicker de início:', e);
            }
        }
        
        if (planData.end_date) {
            console.log('Definindo data de término:', planData.end_date);
            $('#datetimepicker2').val(planData.end_date);
            $('#hidden_end_date').val(planData.end_date);
            
            // Inicializa o datepicker com o valor
            try {
                $('#datetimepicker2').datetimepicker('date', moment(planData.end_date, 'DD/MM/YYYY HH:mm'));
                console.log('Datepicker de término inicializado com sucesso');
            } catch (e) {
                console.error('Erro ao inicializar datepicker de término:', e);
            }
        }
        
        // Adiciona listeners para atualizar os campos ocultos quando as datas mudarem
        $('#datetimepicker').on('change.datetimepicker', function(e) {
            if (e.date) {
                $('#hidden_start_date').val(e.date.format('DD/MM/YYYY HH:mm'));
                console.log('Data de início atualizada:', $('#hidden_start_date').val());
            }
        });
        
        $('#datetimepicker2').on('change.datetimepicker', function(e) {
            if (e.date) {
                $('#hidden_end_date').val(e.date.format('DD/MM/YYYY HH:mm'));
                console.log('Data de término atualizada:', $('#hidden_end_date').val());
            }
        });
        
        // Exibe a imagem se existir
        if (planData.image) {
            $('#image-preview').html(`
                <img src="${planData.image}" style="width: 48px; height: 48px; object-fit: contain; cursor: pointer;" onclick="document.getElementById('image').click()">
                <button type="button" class="btn btn-danger btn-xs" id="remove_image_btn" style="position: absolute; bottom: -7px; right: -30px;">
                    <i class="fa fa-trash"></i>
                </button>
            `);
            $('#image-preview').css('margin-top', '-7px');
            
            // Adiciona handler para o botão de remover
            $('#remove_image_btn').on('click', function() {
                $('#image').val('');
                $('#should_remove_image').val('yes');
                $('#image-preview').html('<i class="fa fa-file-image-o" style="font-size: 48px; color: #ccc; cursor: pointer;" onclick="document.getElementById(\'image\').click()"></i>');
            });
        }
        
        // Adiciona o handler para o preview da imagem quando uma nova imagem é selecionada
        $('#image').on('change', function() {
            var file = this.files[0];
            if (file) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    $('#image-preview').html(`
                        <img src="${e.target.result}" style="width: 48px; height: 48px; object-fit: contain; cursor: pointer;" onclick="document.getElementById('image').click()">
                        <button type="button" class="btn btn-danger btn-xs" id="remove_image_btn" style="position: absolute; bottom: -7px; right: -30px;">
                            <i class="fa fa-trash"></i>
                        </button>
                    `);
                    $('#image-preview').css('margin-top', '-7px');
                    
                    // Adiciona handler para o botão de remover
                    $('#remove_image_btn').on('click', function() {
                        $('#image').val('');
                        $('#should_remove_image').val('yes');
                        $('#image-preview').html('<i class="fa fa-file-image-o" style="font-size: 48px; color: #ccc; cursor: pointer;" onclick="document.getElementById(\'image\').click()"></i>');
                    });
                }
                reader.readAsDataURL(file);
            }
        });
        
        // Dispara o evento change do tipo para ajustar a visibilidade dos campos
        $('#tipo').trigger('change');
        
        // Garante que os campos de etiqueta sejam exibidos quando o tipo for promocional
        if (planData.package_type === 'Promocional') {
            $('.label-fields, #etiqueta, .date-fields').show();
        } else if (planData.package_type === 'Padrão' && planData.label) {
            $('.label-fields, #etiqueta').show();
        }
        
        // IMPORTANTE: Definimos o valor do campo etiqueta DEPOIS que a visibilidade dos campos
        // é ajustada, para garantir que não seja sobrescrito
        console.log('Definindo valor da etiqueta:', planData.label);
        $('#etiqueta').val(planData.label || '');
        
        // Força a atualização visual dos colorpickers após mostrar os campos
        setTimeout(function() {
            // Reaplica os valores para garantir que sejam exibidos corretamente
            if (planData.color_text_label) {
                $('#id3').colorpicker('setValue', planData.color_text_label);
                console.log('Reaplicando cor de texto:', planData.color_text_label);
            }
            if (planData.color_background_label) {
                $('#id4').colorpicker('setValue', planData.color_background_label);
                console.log('Reaplicando cor de fundo:', planData.color_background_label);
            }
            
            // AQUI: Força novamente o valor do campo etiqueta para garantir que não seja limpo
            $('#etiqueta').val(planData.label || '');
            console.log('Forçando valor da etiqueta novamente:', planData.label);
        }, 300);
        
        // Adiciona um evento para garantir que o valor da etiqueta não seja perdido
        // mesmo após qualquer script externo tentar modificá-lo
        setTimeout(function() {
            // Verifica uma última vez se o campo etiqueta está com o valor correto
            if ($('#etiqueta').val() !== planData.label && planData.label) {
                console.log('Campo etiqueta com valor incorreto. Corrigindo...');
                console.log('Valor atual:', $('#etiqueta').val());
                console.log('Valor esperado:', planData.label);
                $('#etiqueta').val(planData.label);
            }
        }, 500);
        
        // Salva o valor original da etiqueta para garantir que podemos restaurá-lo
        const originalLabelValue = planData.label || '';
        
        // Sobrescreve a função atualizarCamposTipo do arquivo pacote-plano-novo.js
        // para evitar que ela limpe o campo etiqueta na edição
        var originalAtualizarCamposTipo = window.atualizarCamposTipo;
        window.atualizarCamposTipo = function() {
            var tipo = $('#tipo').val();
            console.log('Função atualizarCamposTipo sobrescrita. Tipo:', tipo);
            
            // Esconde todos os campos especiais
            $('.label-fields, #etiqueta, .date-fields, label[for="etiqueta"]').hide();
            
            // NÃO limpa o valor da etiqueta na edição
            // $('#etiqueta').val('');  // <- Esta linha foi removida
            
            // Só mostra campos se tiver um tipo selecionado
            if (tipo === 'Padrão') {
                console.log('Tipo Padrão: mostrando campos de etiqueta');
                $('#etiqueta, label[for="etiqueta"]').show();
                $('.label-fields').show();
                
                // Restaura o valor original (se existir)
                if (originalLabelValue) {
                    $('#etiqueta').val(originalLabelValue);
                }
            } 
            else if (tipo === 'Promocional') {
                console.log('Tipo Promocional: mostrando campos de etiqueta e data');
                $('#etiqueta, label[for="etiqueta"]').show();
                $('.label-fields').show();
                $('.date-fields').show();
                
                // Usa o valor original ou define um valor padrão apenas se estiver vazio
                if (!$('#etiqueta').val()) {
                    if (originalLabelValue) {
                        $('#etiqueta').val(originalLabelValue);
                    } else {
                        $('#etiqueta').val('OFERTA ESPECIAL');
                    }
                }
                
                // Define valores padrão para as cores se não estiverem definidas
                if (!$('#id3').colorpicker('getValue')) {
                    $('#id3').colorpicker('setValue', '#FFFFFF');
                }
                if (!$('#id4').colorpicker('getValue')) {
                    $('#id4').colorpicker('setValue', '#CC000C');
                }
            }
        };
        
        console.log('Formulário preenchido com sucesso');
        
        // Sobrescreve o evento de clique do botão salvar para adicionar logs
        $('#btn-salvar').off('click').on('click', function() {
            console.log('Botão salvar clicado na edição');
            console.log('Valor do campo código Android antes do envio:', $('#codigo-android').val());
            console.log('Valor do campo código Apple antes do envio:', $('#codigo-apple').val());
            
            // Continua com o comportamento original
            var $btn = $(this);
            $btn.prop('disabled', true);
            
            // Cria o FormData para envio
            var formData = new FormData();
            
            // Adiciona os dados do formulário
            formData.append('name', $('#nome').val());
            formData.append('plan', $('#plano').val());
            formData.append('billing_cycle', $('#vigencia').val());
            formData.append('enabled', $('#enabled').prop('checked') ? 'true' : 'false');
            console.log('Valor de enabled enviado:', $('#enabled').prop('checked') ? 'true' : 'false');
            formData.append('tipo', $('#tipo').val());
            
            // Etiqueta e cores
            formData.append('label', $('#etiqueta').val() || '');
            
            // Obtenha os valores dos campos ocultos para garantir que sejam os mais atualizados
            var textColor = $('#hidden_color_text_label').val() || $('#id3').colorpicker('getValue') || '#FFFFFF';
            var bgColor = $('#hidden_color_background_label').val() || $('#id4').colorpicker('getValue') || '#CC000C';
            
            formData.append('color_text_label', validateColor(textColor));
            formData.append('color_background_label', validateColor(bgColor));
            
            console.log('Etiqueta a ser enviada:', $('#etiqueta').val());
            console.log('Cor de texto a ser enviada:', validateColor(textColor));
            console.log('Cor de fundo a ser enviada:', validateColor(bgColor));
            
            // Preços
            formData.append('full_price', $('#preco-padrao').val().replace(',', '.'));
            if ($('#preco-promocional').val()) {
                formData.append('promotional_price', $('#preco-promocional').val().replace(',', '.'));
            }
            
            // Datas - Usa os valores dos campos ocultos se disponíveis, senão usa os valores dos datepickers
            var startDate = $('#hidden_start_date').val() || $('#datetimepicker').val();
            var endDate = $('#hidden_end_date').val() || $('#datetimepicker2').val();
            
            console.log('Data de início a ser enviada:', startDate);
            console.log('Data de término a ser enviada:', endDate);
            
            if (startDate) formData.append('start_date', startDate);
            if (endDate) formData.append('end_date', endDate);
            
            // Outros campos
            formData.append('show_to', $('#exibir-para').val());
            
            // Códigos de produto - Adicionando logs para depuração
            var androidCode = $('#codigo-android').val() || '';
            var appleCode = $('#codigo-apple').val() || '';
            var gatewayCode = $('#codigo-gateway').val() || '';
            console.log('Código Android a ser enviado:', androidCode);
            console.log('Código Apple a ser enviado:', appleCode);
            console.log('Código Gateway a ser enviado:', gatewayCode);
            
            formData.append('android_product_code', androidCode);
            formData.append('apple_product_code', appleCode);
            formData.append('gateway_product_code', gatewayCode);
            
            // Imagem
            var imageFile = $('#image')[0].files[0];
            if (imageFile) {
                formData.append('image', imageFile);
            }
            
            // Adiciona o campo para remoção de imagem
            formData.append('should_remove_image', $('#should_remove_image').val());
            
            // Envia os dados
            $.ajax({
                url: window.location.pathname,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')
                },
                success: function(response) {
                    if (response.success) {
                        toastr.success(response.message);
                        setTimeout(function() {
                            window.location.href = $('#cancel-url').data('url');
                        }, 1500);
                    } else {
                        toastr.error(response.message || 'Erro ao salvar plano');
                        $btn.prop('disabled', false);
                    }
                },
                error: function(xhr) {
                    toastr.error(xhr.responseJSON?.message || 'Erro ao salvar plano');
                    $btn.prop('disabled', false);
                }
            });
            
            return false; // Impede o comportamento padrão
        });
    });
</script>
{% endblock %} 