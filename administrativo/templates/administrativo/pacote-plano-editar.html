{% extends 'administrativo/pacote-plano-novo.html' %}

{% block title %}Editar Pacote{% endblock %}

{% block heading %}
<h2>Editar Pacote</h2>
{% endblock %}

{% block form_data %}
<script>
    // Configuração do CSRF token para requisições AJAX
    var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();
    
    function csrfSafeMethod(method) {
        // Estes métodos HTTP não requerem proteção CSRF
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });
    
    // Função para validar e formatar cores
    function validateColor(color) {
        if (!color) return '#000000';
        
        // Remove espaços e converte para minúsculas
        color = color.trim().toLowerCase();
        
        // Se já estiver no formato #RRGGBB, retorna como está
        if (/^#[0-9a-f]{6}$/.test(color)) {
            return color.toUpperCase();
        }
        
        // Se estiver no formato RGB(r,g,b), converte para hex
        let rgbMatch = color.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
        if (rgbMatch) {
            let r = parseInt(rgbMatch[1]);
            let g = parseInt(rgbMatch[2]);
            let b = parseInt(rgbMatch[3]);
            return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`.toUpperCase();
        }
        
        // Se for rgba, remove o canal alpha e converte para hex
        let rgbaMatch = color.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*[\d.]+\)/);
        if (rgbaMatch) {
            let r = parseInt(rgbaMatch[1]);
            let g = parseInt(rgbaMatch[2]);
            let b = parseInt(rgbaMatch[3]);
            return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`.toUpperCase();
        }
        
        // Se não estiver em nenhum formato válido, retorna preto
        return '#000000';
    }
    
    // Função para formatar data para exibição (YYYY-MM-DD HH:MM:SS -> DD/MM/YYYY HH:MM)
    function formatDateForDisplay(dateStr) {
        if (!dateStr) return '';
        
        try {
            // Tenta criar um objeto moment com a string de data
            var dateMoment = moment(dateStr);
            if (dateMoment.isValid()) {
                return dateMoment.format('DD/MM/YYYY HH:mm');
            }
            return '';
        } catch (e) {
            console.error('Erro ao formatar data para exibição:', e);
            return '';
        }
    }
    
    $(document).ready(function() {
        // Adiciona campos ocultos para armazenar as datas formatadas
        $('body').append('<input type="hidden" id="hidden_start_date">');
        $('body').append('<input type="hidden" id="hidden_end_date">');
        $('body').append('<input type="hidden" id="should_remove_image" name="should_remove_image" value="no">');
        // Adiciona campos ocultos para cores da etiqueta
        $('body').append('<input type="hidden" id="hidden_color_text_label">');
        $('body').append('<input type="hidden" id="hidden_color_background_label">');
        
        // Adiciona campos ocultos para valores de novos jogadores
        $('body').append('<input type="hidden" id="hidden_promotion_days">');
        $('body').append('<input type="hidden" id="hidden_futcoins_package_benefit">');
        $('body').append('<input type="hidden" id="hidden_package_renewals">');
        
        // Configura os datepickers
        $('#datetimepicker, #datetimepicker2').datetimepicker({
            format: 'DD/MM/YYYY HH:mm',
            locale: 'pt-br',
            icons: {
                time: 'fa fa-clock-o',
                date: 'fa fa-calendar',
                up: 'fa fa-chevron-up',
                down: 'fa fa-chevron-down',
                previous: 'fa fa-chevron-left',
                next: 'fa fa-chevron-right',
                today: 'fa fa-screenshot',
                clear: 'fa fa-trash',
                close: 'fa fa-remove'
            }
        });
        
        // Preenche os dados do plano
        const planData = JSON.parse('{{ plan_data|safe }}');
        console.log('Dados do plano recebidos:', planData);
        console.log('Valor de enabled recebido:', planData.enabled);
        console.log('Tipo do enabled:', typeof planData.enabled);
        
        // Mostrar diretamente os dados dos campos específicos para depuração
        console.log('DADOS DE NOVOS JOGADORES:');
        console.log('- promotion_days:', planData.promotion_days);
        console.log('- futcoins_package_benefit:', planData.futcoins_package_benefit);
        console.log('- package_renewals:', planData.package_renewals);
        
        // ARMAZENAR VALORES EM CAMPOS OCULTOS
        $('#hidden_promotion_days').val(planData.promotion_days || '');
        $('#hidden_futcoins_package_benefit').val(planData.futcoins_package_benefit || '');
        $('#hidden_package_renewals').val(planData.package_renewals || '');
        
        // MOSTRAR ESTADO INICIAL DOS CAMPOS OCULTOS
        console.log('VALORES ARMAZENADOS NOS CAMPOS OCULTOS:');
        console.log('- hidden_promotion_days:', $('#hidden_promotion_days').val());
        console.log('- hidden_futcoins_package_benefit:', $('#hidden_futcoins_package_benefit').val());
        console.log('- hidden_package_renewals:', $('#hidden_package_renewals').val());
        
        // INSERINDO VALORES DIRETAMENTE NOS ELEMENTOS HTML NO MOMENTO DA INICIALIZAÇÃO
        // Garantir que os elementos existam primeiro (verificação de segurança)
        if (document.getElementById('dias-promocao') && planData.promotion_days) {
            document.getElementById('dias-promocao').value = planData.promotion_days;
            console.log('Valor de dias-promocao definido diretamente:', planData.promotion_days);
        } else {
            console.log('Elemento dias-promocao não encontrado ou não há valor para promotion_days');
        }
        
        if (document.getElementById('renovacoes-pacote') && planData.package_renewals) {
            document.getElementById('renovacoes-pacote').value = planData.package_renewals;
            console.log('Valor de renovacoes-pacote definido diretamente:', planData.package_renewals);
        } else {
            console.log('Elemento renovacoes-pacote não encontrado ou não há valor para package_renewals');
        }
        
        // Garantir que os campos sejam visíveis se tiver valores
        if (planData.promotion_days || planData.package_renewals || planData.futcoins_package_benefit) {
            console.log('Mostrando campos de Novos Jogadores porque existem valores');
            $('.novos-usuarios-fields').show();
            $('#bloco-beneficio-futcoins').show();
        }
        
        // Preencher campos básicos
        $('#nome').val(planData.name || '');
        $('#plano').val(planData.plan || '');
        $('#vigencia').val(planData.billing_cycle || '');
        
        // Ajustar o valor do tipo para exibição correta
        var tipoExibicao = planData.package_type || 'Padrão';
        console.log('Valor original do tipo recebido do servidor:', tipoExibicao);
        
        if (tipoExibicao === 'Dias Promoção Novos Jogadores') {
            tipoExibicao = 'Novos Jogadores';
            console.log('Convertendo tipo para exibição: Dias Promoção Novos Jogadores -> Novos Jogadores');
        }
        
        // Verificação de segurança para garantir que o valor seja válido
        var valoresValidos = ['Padrão', 'Promocional', 'Novos Jogadores'];
        if (valoresValidos.indexOf(tipoExibicao) === -1) {
            console.error('Valor do tipo inválido:', tipoExibicao, 'Usando valor padrão: Padrão');
            tipoExibicao = 'Padrão';
        }
        
        console.log('Definindo valor do tipo para:', tipoExibicao);
        $('#tipo').val(tipoExibicao);
        
        $('#preco-padrao').val(planData.full_price || '');
        $('#preco-promocional').val(planData.promotional_price || '');
        $('#exibir-para').val(planData.show_to || 'Todos');
        
        // Configurar o checkbox de enabled - usando a mesma lógica do pacote-futcoin-editar.html
        var isEnabled = planData.enabled === true || planData.enabled === 'true' || planData.enabled === 1;
        console.log('Valor de enabled interpretado:', isEnabled);
        $('#enabled').iCheck(isEnabled ? 'check' : 'uncheck');
        
        $('#codigo-android').val(planData.android_product_code || '');
        $('#codigo-apple').val(planData.apple_product_code || '');
        
        console.log('Código Android carregado:', planData.android_product_code);
        console.log('Código Apple carregado:', planData.apple_product_code);
        console.log('Valor do campo código Android:', $('#codigo-android').val());
        console.log('Valor do campo código Apple:', $('#codigo-apple').val());
        
        // Define as cores nos color pickers
        $('#id3').colorpicker('setValue', planData.color_text_label || '#FFFFFF');
        $('#id4').colorpicker('setValue', planData.color_background_label || '#CC000C');
        
        // Atualiza também os campos ocultos para as cores
        $('#hidden_color_text_label').val(planData.color_text_label || '#FFFFFF');
        $('#hidden_color_background_label').val(planData.color_background_label || '#CC000C');
        
        // Adiciona listeners para atualizar os campos ocultos quando as cores mudarem
        $('#id3').on('changeColor', function(e) {
            $('#hidden_color_text_label').val(e.color.toString('hex'));
            console.log('Cor de texto atualizada:', e.color.toString('hex'));
        });
        
        $('#id4').on('changeColor', function(e) {
            $('#hidden_color_background_label').val(e.color.toString('hex'));
            console.log('Cor de fundo atualizada:', e.color.toString('hex'));
        });
        
        // Log para depuração das cores da etiqueta
        console.log('Valores da etiqueta ao carregar:');
        console.log('- Label:', planData.label);
        console.log('- Cor de texto:', planData.color_text_label);
        console.log('- Cor de fundo:', planData.color_background_label);
        console.log('- Campo etiqueta:', $('#etiqueta').val());
        console.log('- Colorpicker texto:', $('#id3').colorpicker('getValue'));
        console.log('- Colorpicker fundo:', $('#id4').colorpicker('getValue'));
        
        // Inicializa os datepickers com moment.js para garantir o formato correto
        if (planData.start_date) {
            console.log('Definindo data de início:', planData.start_date);
            $('#datetimepicker').val(planData.start_date);
            $('#hidden_start_date').val(planData.start_date);
            
            // Inicializa o datepicker com o valor
            try {
                $('#datetimepicker').datetimepicker('date', moment(planData.start_date, 'DD/MM/YYYY HH:mm'));
                console.log('Datepicker de início inicializado com sucesso');
            } catch (e) {
                console.error('Erro ao inicializar datepicker de início:', e);
            }
        }
        
        if (planData.end_date) {
            console.log('Definindo data de término:', planData.end_date);
            $('#datetimepicker2').val(planData.end_date);
            $('#hidden_end_date').val(planData.end_date);
            
            // Inicializa o datepicker com o valor
            try {
                $('#datetimepicker2').datetimepicker('date', moment(planData.end_date, 'DD/MM/YYYY HH:mm'));
                console.log('Datepicker de término inicializado com sucesso');
            } catch (e) {
                console.error('Erro ao inicializar datepicker de término:', e);
            }
        }
        
        // Adiciona listeners para atualizar os campos ocultos quando as datas mudarem
        $('#datetimepicker').on('change.datetimepicker', function(e) {
            if (e.date) {
                $('#hidden_start_date').val(e.date.format('DD/MM/YYYY HH:mm'));
                console.log('Data de início atualizada:', $('#hidden_start_date').val());
            }
        });
        
        $('#datetimepicker2').on('change.datetimepicker', function(e) {
            if (e.date) {
                $('#hidden_end_date').val(e.date.format('DD/MM/YYYY HH:mm'));
                console.log('Data de término atualizada:', $('#hidden_end_date').val());
            }
        });
        
        // Exibe a imagem se existir
        if (planData.image) {
            $('#image-preview').html(`
                <img src="${planData.image}" style="width: 48px; height: 48px; object-fit: contain; cursor: pointer;" onclick="document.getElementById('image').click()">
                <button type="button" class="btn btn-danger btn-xs" id="remove_image_btn" style="position: absolute; bottom: -7px; right: -30px;">
                    <i class="fa fa-trash"></i>
                </button>
            `);
            $('#image-preview').css('margin-top', '-7px');
            
            // Adiciona handler para o botão de remover
            $('#remove_image_btn').on('click', function() {
                $('#image').val('');
                $('#should_remove_image').val('yes');
                $('#image-preview').html('<i class="fa fa-file-image-o" style="font-size: 48px; color: #ccc; cursor: pointer;" onclick="document.getElementById(\'image\').click()"></i>');
            });
        }
        
        // Adiciona o handler para o preview da imagem quando uma nova imagem é selecionada
        $('#image').on('change', function() {
            var file = this.files[0];
            if (file) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    $('#image-preview').html(`
                        <img src="${e.target.result}" style="width: 48px; height: 48px; object-fit: contain; cursor: pointer;" onclick="document.getElementById('image').click()">
                        <button type="button" class="btn btn-danger btn-xs" id="remove_image_btn" style="position: absolute; bottom: -7px; right: -30px;">
                            <i class="fa fa-trash"></i>
                        </button>
                    `);
                    $('#image-preview').css('margin-top', '-7px');
                    
                    // Adiciona handler para o botão de remover
                    $('#remove_image_btn').on('click', function() {
                        $('#image').val('');
                        $('#should_remove_image').val('yes');
                        $('#image-preview').html('<i class="fa fa-file-image-o" style="font-size: 48px; color: #ccc; cursor: pointer;" onclick="document.getElementById(\'image\').click()"></i>');
                    });
                }
                reader.readAsDataURL(file);
            }
        });
        
        // Dispara o evento change do tipo para ajustar a visibilidade dos campos
        $('#tipo').trigger('change');
        
        // Função específica para carregar e selecionar o pacote de futcoins correto
        function carregarESetarPacoteFutcoins() {
            // Apenas se tivermos um ID de pacote para selecionar
            if (planData.futcoins_package_benefit) {
                console.log('Tentando carregar e selecionar pacote futcoins:', planData.futcoins_package_benefit);
                
                // Faz a requisição direta
                $.ajax({
                    url: '/administrativo/api/pacotes-futcoins-ativos/',
                    type: 'GET',
                    dataType: 'json',
                    success: function(response) {
                        console.log('RESPOSTA DA API DE PACOTES:', response);
                        
                        // Limpar o select
                        $('#beneficio-futcoins').empty();
                        $('#beneficio-futcoins').append('<option value="">Selecione um pacote</option>');
                        
                        // Identificar a lista de pacotes (pode estar em 'packages' ou 'pacotes')
                        var listaPacotes = response.packages || response.pacotes || [];
                        
                        if (listaPacotes.length > 0) {
                            console.log('Lista de pacotes encontrada com ' + listaPacotes.length + ' itens');
                            
                            // Adicionar cada opção
                            listaPacotes.forEach(function(pacote) {
                                var selected = (pacote.id == planData.futcoins_package_benefit) ? 'selected' : '';
                                $('#beneficio-futcoins').append(`<option value="${pacote.id}" ${selected}>${pacote.name}</option>`);
                                
                                if (pacote.id == planData.futcoins_package_benefit) {
                                    console.log('Pacote correspondente encontrado e marcado como selecionado:', pacote.name);
                                }
                            });
                            
                            // Certificar-se de que o valor está selecionado
                            $('#beneficio-futcoins').val(planData.futcoins_package_benefit);
                            console.log('Valor definido para o select:', planData.futcoins_package_benefit);
                            console.log('Valor atual do select após definição:', $('#beneficio-futcoins').val());
                        } else {
                            console.log('Nenhum pacote encontrado na resposta');
                        }
                    },
                    error: function(error) {
                        console.error('Erro ao buscar pacotes futcoins:', error);
                    }
                });
            }
        }
        
        // Chamar a função para carregar e selecionar o pacote futcoins
        if (planData.package_type === 'Dias Promoção Novos Jogadores' || planData.package_type === 'Novos Jogadores') {
            // Garantir que os campos sejam exibidos
            $('.novos-usuarios-fields').show();
            $('#bloco-beneficio-futcoins').show();
            
            // Carregar os pacotes futcoins imediatamente
            carregarESetarPacoteFutcoins();
            
            // E tentar novamente após um tempo, para garantir
            setTimeout(carregarESetarPacoteFutcoins, 500);
        }
        
        // Garante que os campos de etiqueta sejam exibidos quando o tipo for promocional
        if (planData.package_type === 'Promocional') {
            $('.label-fields, #etiqueta, .date-fields').show();
        } else if (planData.package_type === 'Padrão' && planData.label) {
            $('.label-fields, #etiqueta').show();
        } else if (planData.package_type === 'Dias Promoção Novos Jogadores') {
            $('.label-fields, #etiqueta').show();
            // Garante que os campos específicos de Novos Jogadores sejam exibidos
            $('.novos-usuarios-fields').show();
            $('#bloco-beneficio-futcoins').show();
        }
        
        // IMPORTANTE: Definimos o valor do campo etiqueta DEPOIS que a visibilidade dos campos
        // é ajustada, para garantir que não seja sobrescrito
        console.log('Definindo valor da etiqueta:', planData.label);
        $('#etiqueta').val(planData.label || '');
        
        // Força a atualização visual dos colorpickers após mostrar os campos
        setTimeout(function() {
            // Reaplica os valores para garantir que sejam exibidos corretamente
            if (planData.color_text_label) {
                $('#id3').colorpicker('setValue', planData.color_text_label);
                console.log('Reaplicando cor de texto:', planData.color_text_label);
            }
            if (planData.color_background_label) {
                $('#id4').colorpicker('setValue', planData.color_background_label);
                console.log('Reaplicando cor de fundo:', planData.color_background_label);
            }
            
            // AQUI: Força novamente o valor do campo etiqueta para garantir que não seja limpo
            $('#etiqueta').val(planData.label || '');
            console.log('Forçando valor da etiqueta novamente:', planData.label);
            
            // Preenche os campos específicos de Novos Jogadores após o resto da interface estar inicializada
            setTimeout(function() {
                if (planData.package_type === 'Dias Promoção Novos Jogadores' || planData.package_type === 'Novos Jogadores') {
                    console.log('Verificação final dos campos de Novos Jogadores');
                    
                    // Dias Promoção - aplicar novamente
                    if (planData.promotion_days) {
                        var valorAtual = $('#dias-promocao').val();
                        if (valorAtual != planData.promotion_days) {
                            console.log('Corrigindo valor de dias-promocao:', valorAtual, '->', planData.promotion_days);
                            $('#dias-promocao').val(planData.promotion_days);
                        }
                    }
                    
                    // Qtde Renovações - aplicar novamente
                    if (planData.package_renewals) {
                        var valorAtual = $('#renovacoes-pacote').val();
                        if (valorAtual != planData.package_renewals) {
                            console.log('Corrigindo valor de renovacoes-pacote:', valorAtual, '->', planData.package_renewals);
                            $('#renovacoes-pacote').val(planData.package_renewals);
                        }
                    }
                    
                    // Benefício Pacote Futcoins - aplicar novamente
                    if (planData.futcoins_package_benefit) {
                        var valorAtual = $('#beneficio-futcoins').val();
                        if (valorAtual != planData.futcoins_package_benefit) {
                            console.log('Corrigindo valor de beneficio-futcoins:', valorAtual, '->', planData.futcoins_package_benefit);
                            $('#beneficio-futcoins').val(planData.futcoins_package_benefit);
                        }
                    }
                }
            }, 1000);
        }, 300);
        
        // Adiciona um evento para garantir que o valor da etiqueta não seja perdido
        // mesmo após qualquer script externo tentar modificá-lo
        setTimeout(function() {
            // Verifica uma última vez se o campo etiqueta está com o valor correto
            if ($('#etiqueta').val() !== planData.label && planData.label) {
                console.log('Campo etiqueta com valor incorreto. Corrigindo...');
                console.log('Valor atual:', $('#etiqueta').val());
                console.log('Valor esperado:', planData.label);
                $('#etiqueta').val(planData.label);
            }
            
            // Verifica novamente os campos específicos de Novos Jogadores depois de um tempo maior
            setTimeout(function() {
                if (planData.package_type === 'Dias Promoção Novos Jogadores' || planData.package_type === 'Novos Jogadores') {
                    console.log('Verificação final dos campos de Novos Jogadores');
                    
                    // Dias Promoção - aplicar novamente
                    if (planData.promotion_days) {
                        var valorAtual = $('#dias-promocao').val();
                        if (valorAtual != planData.promotion_days) {
                            console.log('Corrigindo valor de dias-promocao:', valorAtual, '->', planData.promotion_days);
                            $('#dias-promocao').val(planData.promotion_days);
                        }
                    }
                    
                    // Qtde Renovações - aplicar novamente
                    if (planData.package_renewals) {
                        var valorAtual = $('#renovacoes-pacote').val();
                        if (valorAtual != planData.package_renewals) {
                            console.log('Corrigindo valor de renovacoes-pacote:', valorAtual, '->', planData.package_renewals);
                            $('#renovacoes-pacote').val(planData.package_renewals);
                        }
                    }
                    
                    // Benefício Pacote Futcoins - aplicar novamente
                    if (planData.futcoins_package_benefit) {
                        var valorAtual = $('#beneficio-futcoins').val();
                        if (valorAtual != planData.futcoins_package_benefit) {
                            console.log('Corrigindo valor de beneficio-futcoins:', valorAtual, '->', planData.futcoins_package_benefit);
                            $('#beneficio-futcoins').val(planData.futcoins_package_benefit);
                        }
                    }
                }
            }, 200);
        }, 500);
        
        // Salva o valor original da etiqueta para garantir que podemos restaurá-lo
        const originalLabelValue = planData.label || '';
        
        // Sobrescreve a função atualizarCamposTipo para manter os valores na edição
        window.atualizarCamposTipo = function() {
            var tipo = $('#tipo').val();
            console.log('Função atualizarCamposTipo sobrescrita. Tipo:', tipo);
            
            // Salvar valores atuais para campos específicos de Novos Jogadores
            var valoresNovosJogadores = {
                diasPromocao: $('#dias-promocao').val(),
                beneficioFutcoins: $('#beneficio-futcoins').val(),
                renovacoesPacote: $('#renovacoes-pacote').val()
            };
            
            console.log('Salvando valores atuais antes de atualizar campos:', valoresNovosJogadores);
            
            // Esconde todos os campos especiais
            $('.label-fields, #etiqueta, .date-fields, label[for="etiqueta"]').hide();
            $('.novos-usuarios-fields, #bloco-beneficio-futcoins').hide();
            
            // Só mostra campos se tiver um tipo selecionado
            if (tipo === 'Padrão') {
                console.log('Tipo Padrão: mostrando campos de etiqueta');
                $('#etiqueta, label[for="etiqueta"]').show();
                $('.label-fields').show();
                
                // Restaura o valor original (se existir)
                if (originalLabelValue) {
                    $('#etiqueta').val(originalLabelValue);
                }
            } 
            else if (tipo === 'Promocional') {
                console.log('Tipo Promocional: mostrando campos de etiqueta e data');
                $('#etiqueta, label[for="etiqueta"]').show();
                $('.label-fields').show();
                $('.date-fields').show();
                
                // Usa o valor original ou define um valor padrão apenas se estiver vazio
                if (!$('#etiqueta').val()) {
                    if (originalLabelValue) {
                        $('#etiqueta').val(originalLabelValue);
                    } else {
                        $('#etiqueta').val('OFERTA ESPECIAL');
                    }
                }
                
                // Define valores padrão para as cores se não estiverem definidas
                if (!$('#id3').colorpicker('getValue')) {
                    $('#id3').colorpicker('setValue', '#FFFFFF');
                }
                if (!$('#id4').colorpicker('getValue')) {
                    $('#id4').colorpicker('setValue', '#CCA53F');
                }
            }
            else if (tipo === 'Novos Jogadores' || tipo === 'Dias Promoção Novos Jogadores') {
                console.log('Tipo Novos Jogadores: mostrando campos específicos');
                $('#etiqueta, label[for="etiqueta"]').show();
                $('.label-fields').show();
                $('.novos-usuarios-fields').show();
                $('#bloco-beneficio-futcoins').show();
                $('.date-fields').hide(); // Oculta campos de data para Novos Jogadores
                
                // Usa o valor original ou define um valor padrão apenas se estiver vazio
                if (!$('#etiqueta').val()) {
                    if (originalLabelValue) {
                        $('#etiqueta').val(originalLabelValue);
                    } else {
                        $('#etiqueta').val('NOVOS JOGADORES');
                    }
                }
                
                // Define valores padrão para as cores se não estiverem definidas
                if (!$('#id3').colorpicker('getValue')) {
                    $('#id3').colorpicker('setValue', '#FFFFFF');
                }
                if (!$('#id4').colorpicker('getValue')) {
                    $('#id4').colorpicker('setValue', '#CCA53F');
                }
                
                // IMPORTANTE: Restaurar valores específicos para Novos Jogadores
                setTimeout(function() {
                    // Restaurar valores apenas se existirem valores anteriores
                    if (valoresNovosJogadores.diasPromocao) {
                        $('#dias-promocao').val(valoresNovosJogadores.diasPromocao);
                        console.log('Restaurando dias-promocao:', valoresNovosJogadores.diasPromocao);
                    } else if (planData.promotion_days) {
                        $('#dias-promocao').val(planData.promotion_days);
                        console.log('Usando dias-promocao dos dados originais:', planData.promotion_days);
                    }
                    
                    if (valoresNovosJogadores.renovacoesPacote) {
                        $('#renovacoes-pacote').val(valoresNovosJogadores.renovacoesPacote);
                        console.log('Restaurando renovacoes-pacote:', valoresNovosJogadores.renovacoesPacote);
                    } else if (planData.package_renewals) {
                        $('#renovacoes-pacote').val(planData.package_renewals);
                        console.log('Usando package_renewals dos dados originais:', planData.package_renewals);
                    }
                    
                    // Carregar pacotes de futcoins sem perder seleção atual
                    if (typeof carregarPacotesFutcoins === 'function') {
                        var valorAtual = valoresNovosJogadores.beneficioFutcoins || planData.futcoins_package_benefit;
                        if (valorAtual) {
                            console.log('Preservando benefício futcoins:', valorAtual);
                            var oldFn = carregarPacotesFutcoins;
                            carregarPacotesFutcoins = function() {
                                oldFn();
                                setTimeout(function() {
                                    $('#beneficio-futcoins').val(valorAtual);
                                    console.log('Restaurado beneficio-futcoins após carregamento:', valorAtual);
                                }, 300);
                            };
                        }
                        carregarPacotesFutcoins();
                    } else if (planData.futcoins_package_benefit) {
                        // Usar função específica de edição
                        setTimeout(carregarESetarPacoteFutcoins, 300);
                    }
                }, 200);
            }
        };
        
        console.log('Formulário preenchido com sucesso');
        
        // Sobrescreve o evento de clique do botão salvar para adicionar logs
        $('#btn-salvar').off('click').on('click', function() {
            console.log('Botão salvar clicado na edição');
            console.log('Valor do campo código Android antes do envio:', $('#codigo-android').val());
            console.log('Valor do campo código Apple antes do envio:', $('#codigo-apple').val());
            
            // IMPORTANTE: Log específico dos valores de campos de Novos Jogadores
            console.log('VALORES DOS CAMPOS DE NOVOS JOGADORES ANTES DO ENVIO:');
            console.log('- Dias Promoção:', $('#dias-promocao').val());
            console.log('- Benefício Futcoins:', $('#beneficio-futcoins').val());
            console.log('- Renovações Pacote:', $('#renovacoes-pacote').val());
            
            // Continua com o comportamento original
            var $btn = $(this);
            $btn.prop('disabled', true);
            
            // Cria o FormData para envio
            var formData = new FormData();
            
            // Adiciona os dados do formulário
            formData.append('name', $('#nome').val());
            formData.append('plan', $('#plano').val());
            formData.append('billing_cycle', $('#vigencia').val());
            formData.append('enabled', $('#enabled').prop('checked') ? 'true' : 'false');
            console.log('Valor de enabled enviado:', $('#enabled').prop('checked') ? 'true' : 'false');
            
            // Converter o valor "Novos Jogadores" para um valor válido no backend
            var tipo = $('#tipo').val();
            console.log('Valor bruto do tipo antes da conversão:', tipo);
            console.log('Elemento #tipo existe:', $('#tipo').length > 0);
            console.log('Opções disponíveis no select:', $('#tipo option').map(function() { return $(this).val(); }).get());
            
            // Verificação adicional para evitar null
            if (!tipo || tipo === '') {
                console.error('ATENÇÃO: Tipo está nulo ou vazio! Usando valor padrão "Padrão"');
                tipo = 'Padrão'; // Valor padrão seguro
            }
            
            if (tipo === 'Novos Jogadores') {
                console.log('Convertendo "Novos Jogadores" para valor válido aceito pelo backend');
                tipo = 'Dias Promoção Novos Jogadores'; // Valor que o backend aceita
            }
            
            // Verificação final para garantir que package_type nunca seja nulo
            if (!tipo) {
                console.error('ERRO CRÍTICO: Tipo continua nulo após correções. Forçando valor "Padrão"');
                tipo = 'Padrão';
            }
            
            formData.append('package_type', tipo);
            formData.append('package_type_backup', tipo); // Adiciona uma cópia redundante
            formData.append('tipo', tipo); // Adiciona outra cópia com nome alternativo
            console.log('Tipo a ser enviado:', tipo);
            
            // Etiqueta e cores
            formData.append('label', $('#etiqueta').val() || '');
            
            // Obtenha os valores dos campos ocultos para garantir que sejam os mais atualizados
            var textColor = $('#hidden_color_text_label').val() || $('#id3').colorpicker('getValue') || '#FFFFFF';
            var bgColor = $('#hidden_color_background_label').val() || $('#id4').colorpicker('getValue') || '#CC000C';
            
            formData.append('color_text_label', validateColor(textColor));
            formData.append('color_background_label', validateColor(bgColor));
            
            console.log('Etiqueta a ser enviada:', $('#etiqueta').val());
            console.log('Cor de texto a ser enviada:', validateColor(textColor));
            console.log('Cor de fundo a ser enviada:', validateColor(bgColor));
            
            // Preços
            formData.append('full_price', $('#preco-padrao').val().replace(',', '.'));
            if ($('#preco-promocional').val()) {
                formData.append('promotional_price', $('#preco-promocional').val().replace(',', '.'));
            }
            
            // Datas - Usa os valores dos campos ocultos se disponíveis, senão usa os valores dos datepickers
            var startDate = $('#hidden_start_date').val() || $('#datetimepicker').val();
            var endDate = $('#hidden_end_date').val() || $('#datetimepicker2').val();
            
            console.log('Data de início a ser enviada:', startDate);
            console.log('Data de término a ser enviada:', endDate);
            
            // Para o tipo "Novos Jogadores", definir datas padrão se não estiverem preenchidas
            if ($('#tipo').val() === 'Novos Jogadores' && (!startDate || !endDate)) {
                console.log('Definindo datas padrão para Novos Jogadores');
                
                // Data de início: hoje
                var hoje = moment().format('DD/MM/YYYY HH:mm');
                
                // Data de término: 1 ano no futuro
                var umAnoFuturo = moment().add(1, 'year').format('DD/MM/YYYY HH:mm');
                
                if (!startDate) {
                    startDate = hoje;
                    $('#datetimepicker').val(startDate);
                    console.log('Data de início definida como:', startDate);
                }
                
                if (!endDate) {
                    endDate = umAnoFuturo;
                    $('#datetimepicker2').val(endDate);
                    console.log('Data de término definida como:', endDate);
                }
            }
            
            if (startDate) formData.append('start_date', startDate);
            if (endDate) formData.append('end_date', endDate);
            
            // Dias Promoção
            var diasPromocao = $('#dias-promocao').val();
            if (diasPromocao) {
                // Remover zeros à esquerda para evitar problemas de conversão de octal
                diasPromocao = parseInt(diasPromocao, 10).toString();
                formData.append('promotion_days', diasPromocao);
                console.log('Adicionando promotion_days ao FormData:', diasPromocao);
            } else if (planData.promotion_days) {
                // Remover zeros à esquerda para evitar problemas de conversão de octal
                var daysValue = parseInt(planData.promotion_days, 10).toString();
                formData.append('promotion_days', daysValue);
                console.log('Usando promotion_days dos dados originais:', daysValue);
            } else if ($('#hidden_promotion_days').val()) {
                // Remover zeros à esquerda para evitar problemas de conversão de octal
                var hiddenValue = parseInt($('#hidden_promotion_days').val(), 10).toString();
                formData.append('promotion_days', hiddenValue);
                console.log('Usando promotion_days do campo oculto:', hiddenValue);
            }
            
            // Benefício Pacote Futcoins
            var beneficioFutcoins = $('#beneficio-futcoins').val();
            if (beneficioFutcoins) {
                // Remover zeros à esquerda para evitar problemas de conversão de octal
                beneficioFutcoins = parseInt(beneficioFutcoins, 10).toString();
                formData.append('futcoins_package_benefit', beneficioFutcoins);
                console.log('Adicionando futcoins_package_benefit ao FormData:', beneficioFutcoins);
            } else if (planData.futcoins_package_benefit) {
                // Remover zeros à esquerda para evitar problemas de conversão de octal
                var futcoinsValue = parseInt(planData.futcoins_package_benefit, 10).toString();
                formData.append('futcoins_package_benefit', futcoinsValue);
                console.log('Usando futcoins_package_benefit dos dados originais:', futcoinsValue);
            } else if ($('#hidden_futcoins_package_benefit').val()) {
                // Remover zeros à esquerda para evitar problemas de conversão de octal
                var hiddenValue = parseInt($('#hidden_futcoins_package_benefit').val(), 10).toString();
                formData.append('futcoins_package_benefit', hiddenValue);
                console.log('Usando futcoins_package_benefit do campo oculto:', hiddenValue);
            }
            
            // Qtde Renovações Pacote
            var qtdeRenovacoes = $('#renovacoes-pacote').val();
            if (qtdeRenovacoes) {
                // Remover zeros à esquerda para evitar problemas de conversão de octal
                qtdeRenovacoes = parseInt(qtdeRenovacoes, 10).toString();
                formData.append('package_renewals', qtdeRenovacoes);
                console.log('Adicionando package_renewals ao FormData:', qtdeRenovacoes);
            } else if (planData.package_renewals) {
                // Remover zeros à esquerda para evitar problemas de conversão de octal
                var renewalsValue = parseInt(planData.package_renewals, 10).toString();
                formData.append('package_renewals', renewalsValue);
                console.log('Usando package_renewals dos dados originais:', renewalsValue);
            } else if ($('#hidden_package_renewals').val()) {
                // Remover zeros à esquerda para evitar problemas de conversão de octal
                var hiddenValue = parseInt($('#hidden_package_renewals').val(), 10).toString();
                formData.append('package_renewals', hiddenValue);
                console.log('Usando package_renewals do campo oculto:', hiddenValue);
            }
            
            // Outros campos
            formData.append('show_to', $('#exibir-para').val());
            
            // Códigos de produto - Adicionando logs para depuração
            var androidCode = $('#codigo-android').val() || '';
            var appleCode = $('#codigo-apple').val() || '';
            var gatewayCode = $('#codigo-gateway').val() || planData.gateway_product_code || '';
            console.log('Código Android a ser enviado:', androidCode);
            console.log('Código Apple a ser enviado:', appleCode);
            console.log('Código Gateway a ser enviado:', gatewayCode);
            
            formData.append('android_product_code', androidCode);
            formData.append('apple_product_code', appleCode);
            formData.append('gateway_product_code', gatewayCode);
            
            // Imagem
            var imageFile = $('#image')[0].files[0];
            if (imageFile) {
                formData.append('image', imageFile);
            }
            
            // Adiciona o campo para remoção de imagem
            formData.append('should_remove_image', $('#should_remove_image').val());
            
            // Log para visualizar todos os pares chave/valor do FormData
            console.log('Dados sendo enviados:');
            for (var pair of formData.entries()) {
                console.log(pair[0] + ': ' + pair[1]);
            }
            
            // Envia os dados
            $.ajax({
                url: window.location.pathname,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')
                },
                success: function(response) {
                    if (response.success) {
                        toastr.success(response.message);
                        setTimeout(function() {
                            window.location.href = $('#cancel-url').data('url');
                        }, 1500);
                    } else {
                        toastr.error(response.message || 'Erro ao salvar plano');
                        $btn.prop('disabled', false);
                    }
                },
                error: function(xhr) {
                    toastr.error(xhr.responseJSON?.message || 'Erro ao salvar plano');
                    $btn.prop('disabled', false);
                }
            });
            
            return false; // Impede o comportamento padrão
        });
        
        // GARANTIR QUE OS VALORES DE NOVOS JOGADORES SEJAM PRESERVADOS
        var preservarValoresNovosJogadores = function() {
            // Armazenar valores atuais
            var valoresSalvos = {
                diasPromocao: $('#dias-promocao').val(),
                beneficioFutcoins: $('#beneficio-futcoins').val(),
                renovacoesPacote: $('#renovacoes-pacote').val()
            };
            
            console.log('Preservando valores de Novos Jogadores:', valoresSalvos);
            
            // Detectar quando o tipo mudar
            $('#tipo').on('change', function() {
                var tipo = $(this).val();
                
                // Só restaurar se o tipo for Novos Jogadores
                if (tipo === 'Novos Jogadores') {
                    // Dar tempo para outros scripts executarem
                    setTimeout(function() {
                        // Restaurar valores
                        if (valoresSalvos.diasPromocao) {
                            $('#dias-promocao').val(valoresSalvos.diasPromocao);
                        }
                        
                        if (valoresSalvos.renovacoesPacote) {
                            $('#renovacoes-pacote').val(valoresSalvos.renovacoesPacote);
                        }
                        
                        if (valoresSalvos.beneficioFutcoins) {
                            $('#beneficio-futcoins').val(valoresSalvos.beneficioFutcoins);
                        }
                        
                        console.log('Valores restaurados após mudança de tipo para Novos Jogadores');
                    }, 200);
                }
            });
        };
        
        // Inicializar preservation logic
        setTimeout(preservarValoresNovosJogadores, 500);
        
        // Garantir que os campos específicos de Novos Jogadores sejam tratados adequadamente
        var verificarCamposNovosJogadores = function() {
            if ((planData.package_type === 'Dias Promoção Novos Jogadores' || planData.package_type === 'Novos Jogadores') && 
                $('#tipo').val() === 'Novos Jogadores') {
                
                // Garantir que os campos apareçam
                $('.novos-usuarios-fields').show();
                $('#bloco-beneficio-futcoins').show();
                
                // Forçar os valores corretos
                if (planData.promotion_days) {
                    $('#dias-promocao').val(planData.promotion_days);
                    console.log('FORÇANDO dias-promocao:', planData.promotion_days);
                }
                
                if (planData.package_renewals) {
                    $('#renovacoes-pacote').val(planData.package_renewals);
                    console.log('FORÇANDO renovacoes-pacote:', planData.package_renewals);
                }
                
                // Recarregar benefício futcoins
                if (planData.futcoins_package_benefit) {
                    setTimeout(carregarESetarPacoteFutcoins, 300);
                }
            }
        };
        
        // Verificar campos após carregamento inicial
        setTimeout(verificarCamposNovosJogadores, 800);
        
        // Verificar novamente após alteração do tipo
        $('#tipo').on('change', function() {
            setTimeout(verificarCamposNovosJogadores, 300);
        });
    });
</script>
{% endblock %} 