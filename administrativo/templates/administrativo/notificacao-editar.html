{% load static %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <title>Editar Notificação</title>

        <link href="{% static 'administrativo/css/bootstrap.min.css' %}" rel="stylesheet">
        <link href="{% static 'administrativo/font-awesome/css/font-awesome.css' %}" rel="stylesheet">

        <!-- Toastr style -->
        <link href="{% static 'administrativo/css/plugins/toastr/toastr.min.css' %}" rel="stylesheet">
        
        <link href="{% static 'administrativo/css/plugins/iCheck/custom.css' %}" rel="stylesheet">
        <link href="{% static 'administrativo/css/plugins/tempusdominus/tempusdominus-bootstrap-4.min.css' %}" rel="stylesheet">
        <link href="{% static 'administrativo/css/plugins/select2/select2.min.css' %}" rel="stylesheet">
        <link href="{% static 'administrativo/css/animate.css' %}" rel="stylesheet">
        <link href="{% static 'administrativo/css/style.css' %}" rel="stylesheet">  
        
        <!-- Custom -->      
        <link href="{% static 'administrativo/css/custom.css' %}" rel="stylesheet">

        <!-- Favicon -->
        <link rel="icon" href="{% static 'administrativo/img/futmundi.ico' %}" type="image/png">

        <style>
            .form-group {
                margin-bottom: 15px;
            }
            .form-control {
                border-radius: 0;
                box-shadow: none;
                border: 1px solid #e5e6e7;
            }
            .select2-container {
                width: 200px !important;
            }
            .select2-container .select2-selection--single {
                height: 34px;
                border-radius: 0;
            }
            .select2-container--default .select2-selection--single {
                border: 1px solid #e5e6e7;
            }
            .select2-container--default .select2-selection--single .select2-selection__rendered {
                line-height: 32px;
            }
            .select2-container--default .select2-selection--single .select2-selection__arrow {
                height: 32px;
            }
            .input-group-text {
                border-radius: 0;
            }
            .btn {
                border-radius: 3px;
                padding: 6px 12px;
                margin-right: 5px;
            }
            .btn i {
                margin-right: 5px;
            }
            .btn-success {
                background-color: #1ab394;
                border-color: #1ab394;
            }
            .btn-danger {
                background-color: #ed5565;
                border-color: #ed5565;
            }
            .form-row {
                display: flex;
                margin-bottom: 15px;
            }
            .form-row > div {
                margin-right: 15px;
            }
            .form-row > div:last-child {
                margin-right: 0;
            }
            .radio-row {
                display: flex;
                align-items: center;
                margin-bottom: 15px;
            }
            .radio-row label {
                margin-right: 20px;
            }
        </style>
    </head>
    <body>
        <div id="wrapper">
            <nav class="navbar-default navbar-static-side">
                <div class="sidebar-collapse">
                    <ul class="nav metismenu" id="side-menu">
                        <li class="nav-header">
                            <div class="dropdown profile-element">
                                <a href="{% url "administrativo:usuarios" %}">
                                    <img src="{% static 'administrativo/img/logo.svg' %}" alt="Futmundi logo">
                                </a>
                            </div>
                            <div class="logo-element">
                                <a href="{% url "administrativo:usuarios" %}">
                                    <img src="{% static 'administrativo/img/logosm.svg' %}" alt="Futmundi logo">
                                </a>                            
                            </div>
                        </li>
                        <li>
                            <a href="{% url "administrativo:usuarios" %}"><i class="fa fa-user"></i> <span class="nav-label">Usuários</span></a>
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-trophy"></i> <span class="nav-label">Campeonatos</span><span class="fa arrow"></span></a>
                            <ul class="nav nav-second-level collapse">
                                <li><a href="{% url "administrativo:ambitos" %}">Âmbitos</a></li>
                                <li><a href="{% url "administrativo:campeonatos" %}">Campeonatos</a></li>
                                <li><a href="{% url "administrativo:templates" %}">Templates</a></li>
                                <li><a href="{% url "administrativo:times" %}">Times</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-shopping-cart"></i> <span class="nav-label">Pacotes</span><span class="fa arrow"></span></a>
                            <ul class="nav nav-second-level collapse">
                                <li><a href="{% url "administrativo:futcoins" %}">Futcoins</a></li>
                                <li><a href="{% url "administrativo:planos" %}">Planos</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-diamond"></i> <span class="nav-label">Futligas</span><span class="fa arrow"></span></a>
                            <ul class="nav nav-second-level collapse">
                                <li><a href="{% url "administrativo:futligas_classicas" %}">Clássicas</a></li>
                                <li><a href="{% url "administrativo:futligas_jogadores" %}">Jogadores</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-globe"></i> <span class="nav-label">Locais</span><span class="fa arrow"></span></a>
                            <ul class="nav nav-second-level collapse">
                                <li><a href="{% url "administrativo:continentes" %}">Continentes</a></li>
                                <li><a href="{% url "administrativo:paises" %}">Países</a></li>
                                <li><a href="{% url "administrativo:estados" %}">Estados</a></li>
                            </ul>
                        </li>
                        <li class="active">
                            <a href="#"><i class="fa fa-gear"></i> <span class="nav-label">Configurações</span><span class="fa arrow"></span></a>
                            <ul class="nav nav-second-level collapse">
                                <li><a href="{% url "administrativo:parametros" %}">Parâmetros</a></li>
                                <li><a href="{% url "administrativo:termo" %}">Termo</a></li>
                                <li><a href="{% url "administrativo:notificacoes" %}">Notificações</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="{% url "administrativo:relatorios" %}"><i class="fa fa-pie-chart"></i> <span class="nav-label">Relatórios</span></a>
                        </li>
                    </ul>
                </div>
            </nav>
            <div id="page-wrapper" class="gray-bg">
                <div class="row border-bottom">
                    <nav class="navbar navbar-static-top" style="margin-bottom: 0">
                        <div class="navbar-header">
                            <a class="navbar-minimalize minimalize-styl-2 btn btn-success " href="#"><i class="fa fa-bars"></i> </a>
                        </div>
                        <ul class="nav navbar-top-links navbar-right">
                            <li>
                                <span class="m-r-sm text-muted welcome-message">{{ request.session.admin_name }}</span>
                            </li>
                            <li class="dropdown">
                                <a class="dropdown-toggle count-info" data-toggle="dropdown" href="#">
                                    <i class="fa fa-gear"></i>
                                </a>
                                <ul class="dropdown-menu dropdown-alerts">
                                    <li>
                                        <a href="{% url "administrativo:administradores" %}" class="dropdown-item">
                                            <div>
                                                <i class="fa fa-users"></i> Administradores
                                            </div>
                                        </a>
                                    </li>
                                    <li class="dropdown-divider"></li>
                                    <li>
                                        <a href="{% url "administrativo:login" %}" class="dropdown-item">
                                            <div>
                                                <i class="fa fa-sign-out"></i> Sair
                                            </div>
                                        </a>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </nav>
                </div>
                <div class="row wrapper border-bottom white-bg page-heading">
                    <div class="col-lg-10">
                        <h2>Editar Notificação</h2>
                    </div>
                </div>
                <div class="wrapper wrapper-content">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="ibox-content">
                                <div class="row mt10">
                                    <div class="col-lg-4">
                                        <form method="post" class="mt10" id="notificationForm">
                                            {% csrf_token %}
                                            <div class="form-group col-lg-12">
                                                <div class="row">
                                                    <div class="col-lg-6 mtm20">
                                                        <label class="control-label" for="tipo">Tipo</label>
                                                        <select class="form-control js-example-basic-single" name="notification_type" id="tipo" style="width: 80%">
                                                            <option value="Geral" {% if notification.notification_type == 'Geral' %}selected{% endif %}>Geral</option>
                                                            <option value="PacoteFutcoins" {% if notification.notification_type == 'PacoteFutcoins' %}selected{% endif %}>Pacote Futcoins</option>
                                                            <option value="PacotePlano" {% if notification.notification_type == 'PacotePlano' %}selected{% endif %}>Pacote Plano</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-lg-6 mtm20" id="pacote-container" {% if notification.notification_type == 'Geral' %}style="display: none;"{% endif %}>
                                                        <label class="control-label" for="pacote">Pacote</label>
                                                        <select class="form-control js-example-basic-single" name="package" id="pacote" style="width: 80%">
                                                            <option value="">Selecione um pacote</option>
                                                            {% if notification.notification_type == 'PacoteFutcoins' %}
                                                                {% for package in futcoin_packages %}
                                                                    <option value="{{ package.id }}" {% if notification.package_id == package.id %}selected{% endif %}>{{ package.name }}</option>
                                                                {% endfor %}
                                                            {% elif notification.notification_type == 'PacotePlano' %}
                                                                {% for package in plan_packages %}
                                                                    <option value="{{ package.id }}" {% if notification.package_id == package.id %}selected{% endif %}>{{ package.name }}</option>
                                                                {% endfor %}
                                                            {% endif %}
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group col-lg-8">
                                                <input type="text" id="nome" name="title" class="form-control" required value="{{ notification.title }}">
                                                <label class="form-control-placeholder" for="nome">Título</label>
                                            </div>
                                            <div class="form-group col-lg-12 mt30">
                                                <input type="text" id="mensagem" name="message" class="form-control" required value="{{ notification.message }}">
                                                <label class="form-control-placeholder" for="mensagem">Mensagem</label>
                                            </div>
                                            <div>
                                                <button type="submit" class="btn btn-success ml15"><i class="fa fa-check mr5"></i> Salvar</button>
                                                <a href="{% url 'administrativo:notificacoes' %}" class="btn btn-danger ml15"><i class="fa fa-times mr5"></i> Cancelar</a>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="col-lg-4 ml30 mt10">
                                        <div class="row">
                                            <div class="form-group col-lg-6 ml10">
                                                <div class="i-checks"><label> <input type="radio" value="option1" name="a" checked> <i></i>Envio Imediato</label></div>
                                            </div>
                                            <div class="form-group col-lg-6 mlm50">
                                                <div class="i-checks"><label> <input type="radio" value="option2" name="a"> <i></i>Agendada</label></div>
                                            </div> 
                                        </div>
                                        <div class="form-group col-lg-8 mtm10">
                                            <label class="control-label">Data Envio</label>
                                            <div class="input-group date" data-target-input="nearest">
                                                <input type="text" class="form-control datetimepicker-input" name="send_at" id="datetimepicker" data-toggle="datetimepicker" data-target="#datetimepicker" value="{{ notification.send_at|date:'Y-m-d H:i'|default:'' }}">
                                                <div class="input-group-append" data-target="#datetimepicker" data-toggle="datetimepicker">
                                                    <div class="input-group-text"><i class="fa fa-calendar"></i></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Mainly scripts -->
        <script src="{% static 'administrativo/js/jquery-3.4.1.min.js' %}"></script>
        <script src="{% static 'administrativo/js/popper.min.js' %}"></script>
        <script src="{% static 'administrativo/js/bootstrap.js' %}"></script>
        <script src="{% static 'administrativo/js/plugins/metisMenu/jquery.metisMenu.js' %}"></script>
        <script src="{% static 'administrativo/js/plugins/slimscroll/jquery.slimscroll.min.js' %}"></script>

        <!-- Custom and plugin javascript -->
        <script src="{% static 'administrativo/js/inspinia.js' %}"></script>
        <script src="{% static 'administrativo/js/plugins/pace/pace.min.js' %}"></script>
        <script src="{% static 'administrativo/js/plugins/toastr/toastr.min.js' %}"></script>
        <script src="{% static 'administrativo/js/plugins/select2/select2.min.js' %}"></script>    
        <script src="{% static 'administrativo/js/plugins/moment/moment.js' %}"></script>
        <script src="{% static 'administrativo/js/plugins/tempusdominus/tempusdominus-bootstrap-4.min.js' %}"></script>   
        <script src="{% static 'administrativo/js/plugins/iCheck/icheck.min.js' %}"></script>
        <script src="{% static 'administrativo/js/settings.js' %}"></script>

        <script>
            $(document).ready(function() {
                // Configuração do Toastr
                toastr.options = {
                    closeButton: true,
                    progressBar: true,
                    showMethod: 'slideDown',
                    timeOut: 2000,
                    preventDuplicates: true,
                    positionClass: 'toast-top-right'
                };

                {% if messages %}
                    {% for message in messages %}
                        toastr.{{ message.tags }}("{{ message }}");
                    {% endfor %}
                {% endif %}

                // Inicializa o Select2
                $('.js-example-basic-single').select2({
                    width: '100%'
                });

                // Inicializa o iCheck
                $('.i-checks').iCheck({
                    checkboxClass: 'icheckbox_square-green',
                    radioClass: 'iradio_square-green'
                });

                // Inicializa o DateTimePicker
                $('#datetimepicker').datetimepicker({
                    format: 'DD/MM/YYYY HH:mm',
                    icons: {
                        time: 'fa fa-clock-o',
                        date: 'fa fa-calendar',
                        up: 'fa fa-chevron-up',
                        down: 'fa fa-chevron-down',
                        previous: 'fa fa-chevron-left',
                        next: 'fa fa-chevron-right',
                        today: 'fa fa-screenshot',
                        clear: 'fa fa-trash',
                        close: 'fa fa-remove'
                    }
                });

                // Manipulação dos tipos de notificação e pacotes
                $('#tipo').on('change', function() {
                    var selectedType = $(this).val();
                    var pacoteContainer = $('#pacote-container');
                    var pacoteSelect = $('#pacote');
                    
                    // Limpa o select de pacotes
                    pacoteSelect.empty();
                    pacoteSelect.append('<option value="">Selecione um pacote</option>');
                    
                    // Mostra ou esconde o container de pacotes dependendo do tipo
                    if (selectedType === 'Geral') {
                        pacoteContainer.hide();
                        // Para notificações gerais, define mensagens padrão
                        $('#nome').val('Futmundi - Comunicado importante');
                        $('#mensagem').val('Temos uma novidade para você! Confira agora!');
                    } else {
                        pacoteContainer.show();
                        
                        // Carrega os pacotes apropriados via AJAX
                        $.ajax({
                            url: '{% url "administrativo:get_packages" %}',
                            type: 'GET',
                            data: {
                                'type': selectedType
                            },
                            success: function(data) {
                                if (data.packages) {
                                    $.each(data.packages, function(index, package) {
                                        pacoteSelect.append('<option value="' + package.id + '">' + package.name + '</option>');
                                    });
                                }
                            }
                        });
                    }
                });
                
                // Inicializa o tipo e pacote corretos ao carregar a página
                var initialType = '{{ notification.notification_type }}';
                $('#tipo').val(initialType).trigger('change');
                
                // Preenchimento automático do título e mensagem quando um pacote é selecionado
                $('#pacote').on('change', function() {
                    var selectedType = $('#tipo').val();
                    var selectedPackage = $(this).find('option:selected').text();
                    
                    if (selectedPackage && selectedPackage !== 'Selecione um pacote') {
                        // Formata o título para ambos os tipos de pacote
                        var title = selectedPackage + ' disponível agora!!';
                        $('#nome').val(title);
                        
                        // Formata a mensagem dependendo do tipo de pacote
                        if (selectedType === 'PacoteFutcoins') {
                            $('#mensagem').val('Adquira já o pacote e impulsione seus palpites.');
                        } else if (selectedType === 'PacotePlano') {
                            $('#mensagem').val('Seja Craque agora e aproveite todas as vantagens.');
                        }
                    }
                });
                
                // Controle do campo de data baseado no tipo de envio
                $('input[name="a"]').on('ifChecked', function(event) {
                    if ($(this).val() === 'option1') {
                        $('#datetimepicker').prop('disabled', true).val('');
                    } else {
                        $('#datetimepicker').prop('disabled', false);
                    }
                });

                // Inicializa os valores da notificação existente
                var notification = {
                    notification_type: "{{ notification.notification_type|default:'Geral' }}",
                    package_id: "{{ notification.package_id|default:'' }}",
                    title: "{{ notification.title|escapejs }}",
                    message: "{{ notification.message|escapejs }}",
                    send_at: "{{ notification.send_at|date:'Y-m-d H:i'|default:'' }}"
                };

                // Preenche os campos com os valores existentes
                $('#nome').val(notification.title);
                $('#mensagem').val(notification.message);
                
                // Define o estado do envio agendado
                if (notification.send_at) {
                    $('input[name="a"][value="option2"]').iCheck('check');
                    $('#datetimepicker').prop('disabled', false);
                    $('#datetimepicker').val(moment(notification.send_at, 'YYYY-MM-DD HH:mm').format('DD/MM/YYYY HH:mm'));
                } else {
                    $('input[name="a"][value="option1"]').iCheck('check');
                    $('#datetimepicker').prop('disabled', true);
                }

                // Adiciona validação do formulário
                $('form').on('submit', function(e) {
                    var titulo = $('#nome').val();
                    var mensagem = $('#mensagem').val();

                    if (!titulo || !mensagem) {
                        e.preventDefault();
                        toastr.error('Por favor, preencha todos os campos obrigatórios');
                        return false;
                    }

                    var envioImediato = $('input[name="a"][value="option1"]').is(':checked');
                    var dataEnvio = $('#datetimepicker').val();

                    if (!envioImediato && !dataEnvio) {
                        e.preventDefault();
                        toastr.error('Por favor, selecione uma data de envio');
                        return false;
                    }

                    if (!envioImediato && dataEnvio) {
                        $(this).append('<input type="hidden" name="send_at" value="' + 
                            moment(dataEnvio, 'DD/MM/YYYY HH:mm').format('YYYY-MM-DD HH:mm') + '">');
                    }
                    
                    return true;
                });
            });
        </script>
    </body>
</html>
