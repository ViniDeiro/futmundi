{% extends "administrativo/futliga-classica-novo.html" %}

{% block title %}Editar Futliga Clássica{% endblock %}

{% block heading %}Editar Futliga Clássica{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Preenche os campos com os dados da Futliga
        $('#nome').val('{{ futliga.name }}');
        
        // Preencher o campo de participantes corretamente
        if ({{ futliga.players }} === 1) {
            $('#participantes').val('Comum');
        } else if ({{ futliga.players }} === 2) {
            $('#participantes').val('Craque');
        } else {
            $('#participantes').val('Todos');
        }
        
        // Frequência de premiação - corrigindo mapeamento dos valores
        var frequencia = '{{ futliga.award_frequency }}';
        if (frequencia === 'weekly') {
            $('#frequencia').val('Semanal');
        } else if (frequencia === 'monthly') {
            $('#frequencia').val('Mensal');
        } else if (frequencia === 'annual') {
            $('#frequencia').val('Anual');
        }
        $('#frequencia').trigger('change');
        
        // Dia/horário de premiação
        if (frequencia === 'weekly') {
            // Converte o dia da semana de 0-6 para 1-7
            var weekday = {{ futliga.weekday }};
            $('#dia-premiacao').val(weekday);
        } else if (frequencia === 'monthly') {
            $('#mes-premiacao').val('{{ futliga.monthday }}');
        }
        
        // Horário de premiação
        {% if futliga.award_time %}
        $('.clockpicker input').val('{{ futliga.award_time }}');
        {% endif %}
        
        // Imagem principal
        {% if futliga.image %}
        $('#image-preview').html(`
            <img src="{{ futliga.image.url }}" style="width: 48px; height: 48px; object-fit: contain; cursor: pointer;" onclick="document.getElementById('image').click()">
            <button type="button" class="btn btn-danger btn-xs" id="remove_image_btn" style="position: absolute; bottom: -7px; right: -30px;">
                <i class="fa fa-trash"></i>
            </button>
        `);
        
        // Adiciona handler para o botão de remover
        $('#remove_image_btn').on('click', function() {
            $('#image').val('');
            $('#image-preview').html('<i class="fa fa-file-image-o" style="font-size: 48px; color: #ccc; cursor: pointer;" onclick="document.getElementById(\'image\').click()"></i>');
        });
        {% endif %}
        
        // Prêmios
        {% for prize in futliga.prizes.all %}
        var prizeCounter = {{ forloop.counter }};
        var newRow = $('<tr>').attr('id', 'prize-row-' + prizeCounter);
        
        // Coluna Posição - readonly pois o sistema já reorganiza automaticamente
        newRow.append($('<td>').append(
            $('<input>').attr({
                'type': 'number',
                'class': 'form-control position-input',
                'required': true,
                'min': '1',
                'value': '{{ prize.position }}',
                'readonly': true
            })
        ));
        
        // Coluna Imagem
        var imageCell = $('<td>').addClass('center-middle').append(
            $('<div>').attr('class', 'prize-image-container').append(
                $('<input>').attr({
                    'type': 'file',
                    'class': 'prize-image',
                    'accept': 'image/*',
                    'style': 'display: none;'
                })
            )
        );
        
        // Se já tem imagem, exibe preview
        {% if prize.image %}
        imageCell.find('.prize-image-container').append(
            $('<div>').attr('class', 'prize-image-preview').html(`
                <img src="{{ prize.image.url }}" style="width: 32px; height: 32px; object-fit: contain; cursor: pointer;" onclick="$(this).closest('.prize-image-container').find('.prize-image').click()">
                <button type="button" class="btn btn-danger btn-xs clear-prize-image" style="position: absolute; bottom: -5px; right: -5px;">
                    <i class="fa fa-trash"></i>
                </button>
            `)
        );
        
        // Handler para limpar a imagem
        imageCell.find('.clear-prize-image').on('click', function(e) {
            e.stopPropagation();
            var container = $(this).closest('.prize-image-container');
            container.find('.prize-image').val('');
            container.find('.prize-image-preview').html(`
                <i class="fa fa-file-image-o" style="font-size: 24px; color: #ccc; cursor: pointer;"></i>
            `);
        });
        {% else %}
        imageCell.find('.prize-image-container').append(
            $('<div>').attr('class', 'prize-image-preview').html(`
                <i class="fa fa-file-image-o" style="font-size: 24px; color: #ccc; cursor: pointer;"></i>
            `)
        );
        {% endif %}
        
        newRow.append(imageCell);
        
        // Coluna Prêmio
        newRow.append($('<td>').append(
            $('<input>').attr({
                'type': 'number',
                'class': 'form-control prize-input',
                'required': true,
                'min': '0',
                'value': '{{ prize.prize }}'
            })
        ));
        
        // Coluna Ações
        newRow.append($('<td>').append(
            $('<button>').attr({
                'type': 'button',
                'class': 'btn btn-danger btn-xs remove-prize',
                'title': 'Excluir'
            }).html('<i class="fa fa-trash"></i>').click(function() {
                $(this).closest('tr').remove();
                updatePositions();
            })
        ));
        
        $('#prizes-table tbody').append(newRow);
        
        // Preview de imagem quando altera
        newRow.find('.prize-image').change(function() {
            var file = this.files[0];
            var preview = $(this).siblings('.prize-image-preview');
            
            if (file) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    preview.html(`
                        <img src="${e.target.result}" style="width: 32px; height: 32px; object-fit: contain; cursor: pointer;" onclick="$(this).closest('.prize-image-container').find('.prize-image').click()">
                        <button type="button" class="btn btn-danger btn-xs clear-prize-image" style="position: absolute; bottom: -5px; right: -5px;">
                            <i class="fa fa-trash"></i>
                        </button>
                    `);
                    
                    // Handler para limpar a imagem
                    preview.find('.clear-prize-image').on('click', function(e) {
                        e.stopPropagation();
                        var container = $(this).closest('.prize-image-container');
                        container.find('.prize-image').val('');
                        container.find('.prize-image-preview').html(`
                            <i class="fa fa-file-image-o" style="font-size: 24px; color: #ccc; cursor: pointer;"></i>
                        `);
                    });
                }
                reader.readAsDataURL(file);
            }
        });
        {% endfor %}
        
        // Atualiza o formulário para enviar para a URL de edição
        $('#save-btn').click(function() {
            // Validação do nome
            var nome = $('#nome').val().trim();
            if (!nome) {
                toastr.error('O campo Nome é obrigatório');
                $('#nome').focus();
                return;
            }

            var formData = new FormData();
            
            // Dados básicos
            formData.append('name', nome);
            formData.append('players', $('#participantes').val());
            
            // Converte a frequência para o formato do backend
            var frequencia = $('#frequencia').val();
            var award_frequency;
            if (frequencia === 'Semanal') {
                award_frequency = 'weekly';
            } else if (frequencia === 'Mensal') {
                award_frequency = 'monthly';
            }
            formData.append('award_frequency', award_frequency);
            
            // Imagem principal
            var mainImage = $('#image')[0].files[0];
            if (mainImage) {
                formData.append('image', mainImage);
            }
            
            // Dia/horário de premiação
            if (frequencia === 'Semanal') {
                // Converte o dia da semana (1-7 para 0-6)
                var weekday = parseInt($('#dia-premiacao').val());
                formData.append('weekday', weekday > 0 ? weekday - 1 : 6);
            } else if (frequencia === 'Mensal') {
                formData.append('monthday', $('#mes-premiacao').val());
            }
            
            // Horário é sempre enviado
            formData.append('award_time', $('.clockpicker input').val());
            
            // Prêmios
            $('#prizes-table tbody tr').each(function() {
                var position = $(this).find('.position-input').val();
                var prize = $(this).find('.prize-input').val();
                var prizeImage = $(this).find('.prize-image')[0].files[0];
                
                if (position && prize) {
                    formData.append('prize_positions[]', position);
                    formData.append('prize_descriptions[]', prize);
                    if (prizeImage) {
                        formData.append('prize_images[]', prizeImage);
                    }
                }
            });

            $.ajax({
                url: '{% url "administrativo:futliga_classica_editar" futliga.id %}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        toastr.success('Futliga Clássica atualizada com sucesso!');
                        setTimeout(function() {
                            window.location.href = '{% url "administrativo:futligas_classicas" %}';
                        }, 1500);
                    } else {
                        toastr.error(response.message || 'Erro ao atualizar Futliga Clássica');
                    }
                },
                error: function(xhr) {
                    toastr.error(xhr.responseJSON?.message || 'Erro ao atualizar Futliga Clássica');
                }
            });
        });
    });
</script>
{% endblock %}

<div class="ibox-footer text-center">
    <a href="{% url 'administrativo:futligas_classicas' %}" class="btn btn-danger" style="width: 120px;">Cancelar</a>
    <button type="button" class="btn btn-success" id="btn-save" style="width: 120px;">Salvar</button>
</div>

</script> 