{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="csrf-token" content="{{ csrf_token }}">

        <title>Novo Pacote</title>

        <link href="{% static 'administrativo/css/bootstrap.min.css' %}" rel="stylesheet">
        <link href="{% static 'administrativo/font-awesome/css/font-awesome.css' %}" rel="stylesheet">

        <!-- Toastr style -->
        <link href="{% static 'administrativo/css/plugins/toastr/toastr.min.css' %}" rel="stylesheet">
        <link href="{% static 'administrativo/css/plugins/iCheck/custom.css' %}" rel="stylesheet">
        <link href="{% static 'administrativo/css/plugins/jasny/jasny-bootstrap.min.css' %}" rel="stylesheet">
        <link href="{% static 'administrativo/css/plugins/colorpicker/bootstrap-colorpicker.min.css' %}" rel="stylesheet">
        <link href="{% static 'administrativo/css/plugins/tempusdominus/tempusdominus-bootstrap-4.min.css' %}" rel="stylesheet"> 
        <link href="{% static 'administrativo/css/animate.css' %}" rel="stylesheet">
        <link href="{% static 'administrativo/css/style.css' %}" rel="stylesheet">  
        
        <!-- Custom -->      
        <link href="{% static 'administrativo/css/custom.css' %}" rel="stylesheet">

        <!-- Favicon -->
        <link rel="icon" href="img/futmundi.ico" type="image/png">

        <style>
            .form-control-placeholder::after {
                content: "";
                color: red;
            }
            .form-control-placeholder:not([for="nome"]):not([for="preco-padrao"]):not([for="preco-promocional"]):not([for="conteudo"])::after {
                content: "";
            }
            .bootstrap-datetimepicker-widget {
                z-index: 9999 !important;
                background-color: white;
                visibility: visible !important;
                opacity: 1 !important;
                display: block !important;
            }
            .tempusdominus-bootstrap-4 {
                position: relative;
            }
            .input-group-append {
                cursor: pointer;
            }
        </style>
    </head>
    <body>
        <div id="wrapper">
            <nav class="navbar-default navbar-static-side">
                <div class="sidebar-collapse">
                    <ul class="nav metismenu" id="side-menu">
                        <li class="nav-header">
                            <div class="dropdown profile-element">
                                <a href="{% url "administrativo:usuarios" %}">
                                    <img src="{% static 'administrativo/img/logo.svg' %}" alt="Futmundi logo">
                                </a>
                            </div>
                            <div class="logo-element">
                                <a href="{% url "administrativo:usuarios" %}">
                                    <img src="{% static 'administrativo/img/logosm.svg' %}" alt="Futmundi logo">
                                </a>                            
                            </div>
                        </li>
                        <li class="active">
                            <a href="{% url "administrativo:usuarios" %}"><i class="fa fa-user"></i> <span class="nav-label">Usuários</span></a>
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-trophy"></i> <span class="nav-label">Campeonatos</span><span class="fa arrow"></span></a>
                            <ul class="nav nav-second-level collapse">
                                <li><a href="{% url "administrativo:ambitos" %}">Âmbitos</a></li>
                                <li><a href="{% url "administrativo:campeonatos" %}">Campeonatos</a></li>
                                <li><a href="{% url "administrativo:templates" %}">Templates</a></li>
                                <li><a href="{% url "administrativo:times" %}">Times</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-shopping-cart"></i> <span class="nav-label">Pacotes</span><span class="fa arrow"></span></a>
                            <ul class="nav nav-second-level collapse">
                                <li><a href="{% url "administrativo:futcoins" %}">Futcoins</a></li>
                                <li><a href="{% url "administrativo:planos" %}">Planos</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-diamond"></i> <span class="nav-label">Futligas</span><span class="fa arrow"></span></a>
                            <ul class="nav nav-second-level collapse">
                                <li><a href="{% url "administrativo:futligas_classicas" %}">Clássicas</a></li>
                                <li><a href="{% url "administrativo:futligas_jogadores" %}">Jogadores</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-globe"></i> <span class="nav-label">Locais</span><span class="fa arrow"></span></a>
                            <ul class="nav nav-second-level collapse">
                                <li><a href="{% url "administrativo:continentes" %}">Continentes</a></li>
                                <li><a href="{% url "administrativo:paises" %}">Países</a></li>
                                <li><a href="{% url "administrativo:estados" %}">Estados</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-gear"></i> <span class="nav-label">Configurações</span><span class="fa arrow"></span></a>
                            <ul class="nav nav-second-level collapse">
                                <li><a href="{% url "administrativo:parametros" %}">Parâmetros</a></li>
                                <li><a href="{% url "administrativo:termo" %}">Termo</a></li>
                                <li><a href="{% url "administrativo:notificacoes" %}">Notificações</a></li>
                            </ul>
                        </li>
                        <li>
                            <a href="{% url "administrativo:relatorios" %}"><i class="fa fa-pie-chart"></i> <span class="nav-label">Relatórios</span></a>
                        </li>
                    </ul>
                </div>
            </nav>
            <div id="page-wrapper" class="gray-bg">
                <div class="row border-bottom">
                    <nav class="navbar navbar-static-top" style="margin-bottom: 0">
                        <div class="navbar-header">
                            <a class="navbar-minimalize minimalize-styl-2 btn btn-success " href="#"><i class="fa fa-bars"></i> </a>
                        </div>
                        <ul class="nav navbar-top-links navbar-right">
                            <li>
                                <span class="m-r-sm text-muted welcome-message">{{ request.session.admin_name }}</span>
                            </li>
                            <li class="dropdown">
                                <a class="dropdown-toggle count-info" data-toggle="dropdown" href="#">
                                    <i class="fa fa-gear"></i>
                                </a>
                                <ul class="dropdown-menu dropdown-alerts">
                                    <li>
                                        <a href="{% url "administrativo:administradores" %}" class="dropdown-item">
                                            <div>
                                                <i class="fa fa-users"></i> Administradores
                                            </div>
                                        </a>
                                    </li>
                                    <li class="dropdown-divider"></li>
                                    <li>
                                        <a href="{% url "administrativo:login" %}" class="dropdown-item">
                                            <div>
                                                <i class="fa fa-sign-out"></i> Sair
                                            </div>
                                        </a>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </nav>
                </div>
                <div class="row wrapper border-bottom white-bg page-heading">
                    <div class="col-lg-10">
                        <h2>Editar Pacote</h2>
                    </div>
                </div>
                <div class="wrapper wrapper-content">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="tabs-container">
                                <ul class="nav nav-tabs" role="tablist">
                                    <li><a class="nav-link active" data-toggle="tab" href="#geral">Geral</a></li>
                                    <li><a class="nav-link" data-toggle="tab" href="#configuracoes">Configurações</a></li>
                                </ul>
                                <div class="tab-content">
                                    <div id="geral" class="tab-pane active">
                                        <div class="panel-body">
                                            <form id="package-form" method="post" enctype="multipart/form-data" action="{% url 'administrativo:futcoin_editar' package.id %}">
                                                {% csrf_token %}
                                                <!-- Campos ocultos para garantir que todos os dados sejam enviados -->
                                                <input type="hidden" name="full_price" id="hidden_full_price">
                                                <input type="hidden" name="promotional_price" id="hidden_promotional_price">
                                                <input type="hidden" name="content" id="hidden_content">
                                                <input type="hidden" name="bonus" id="hidden_bonus">
                                                <input type="hidden" name="show_to" id="hidden_show_to">
                                                <input type="hidden" name="start_date" id="hidden_start_date">
                                                <input type="hidden" name="end_date" id="hidden_end_date">
                                                <input type="hidden" name="android_product_code" id="hidden_android_product_code">
                                                <input type="hidden" name="ios_product_code" id="hidden_ios_product_code">
                                                <input type="hidden" name="gateway_product_code" id="hidden_gateway_product_code">
                                                
                                                <div class="row">
                                                    <div class="col-lg-6">
                                                        <div class="form-group col-lg-12">
                                                            <div class="row">
                                                                <div class="col-lg-4">
                                                                    <input type="text" id="nome" name="name" class="form-control" value="{{ package.name }}" required>
                                                                    <label class="form-control-placeholder" for="nome">Nome *</label>
                                                                </div>
                                                            </div>
                                                        </div>                                                            
                                                        <div class="form-group mt10 col-lg-12">
                                                            <div class="row">
                                                                <div class="col-lg-3 mrm15">
                                                                    <div class="card ui-card-shadow ui-widget ui-widget-content ui-corner-all card-small">
                                                                        <div class="card-heading">
                                                                            <h5>Imagem</h5>
                                                                        </div>
                                                                        <div class="card-content" style="position: relative; padding: 0;">
                                                                            <div id="image-preview" style="display: flex; justify-content: center; padding: 0; margin-top: -7px;">
                                                                                {% if package.image %}
                                                                                    <img src="{{ package.image.url }}" style="width: 48px; height: 48px; object-fit: contain; cursor: pointer;" onclick="document.getElementById('image').click()">
                                                                                    <button type="button" class="btn btn-danger btn-xs" id="remove_image_btn" style="position: absolute; bottom: -7px; right: -30px;">
                                                                                        <i class="fa fa-trash"></i>
                                                                                    </button>
                                                                                {% else %}
                                                                                    <i class="fa fa-file-image-o" style="font-size: 48px; color: #ccc; cursor: pointer;" onclick="document.getElementById('image').click()"></i>
                                                                                {% endif %}
                                                                            </div>
                                                                            <input type="file" id="image" name="image" class="input-image" accept="image/*" style="display: none;">
                                                                            <input type="hidden" name="should_remove_image" id="should_remove_image" value="no">
                                                                        </div>                              
                                                                    </div>
                                                                </div>
                                                                <div class="col-lg-3 mt35">
                                                                    <div class="i-checks"><label> <input type="checkbox" name="enabled" {% if package.enabled %}checked{% endif %}> Ativo</label></div>
                                                                </div>
                                                            </div>
                                                        </div>                                    
                                                    </div>
                                                    <div class="col-lg-6">
                                                        <div class="form-group col-lg-12">
                                                            <div class="row">
                                                                <div class="col-lg-6 mtm20">
                                                                    <label class="control-label" for="tipo">Tipo</label>
                                                                    <select class="form-control js-example-basic-single" id="tipo" name="package_type" style="width: 80%">
                                                                        <option value="">Selecione</option>
                                                                        <option value="Padrão">Padrão</option>
                                                                        <option value="Promocional">Promocional</option>
                                                                    </select>
                                                                </div>
                                                            </div>
                                                        </div>                                                            
                                                        <div class="form-group col-lg-12">
                                                            <div class="row">
                                                                <div class="col-lg-4">
                                                                    <input type="text" id="etiqueta" name="label" class="form-control" value="{{ package.label }}">
                                                                    <label class="form-control-placeholder" for="etiqueta">Etiqueta</label>
                                                                </div>
                                                            </div>
                                                            <div class="row label-fields">
                                                                <div class="col-lg-4 mt10">                                                                        
                                                                    <label class="control-label">Cor Texto Etiqueta</label>
                                                                    <div id="id3" class="input-group colorpicker-component formcolorpicker">
                                                                        <input type="text" name="color_text_label" value="{{ package.color_text_label }}" class="form-control"/>
                                                                        <div class="input-group-append">
                                                                            <span class="input-group-text input-group-addon"><i></i></span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="col-lg-4 mt10">                                                                        
                                                                    <label class="control-label">Cor Fundo Etiqueta</label>
                                                                    <div id="id4" class="input-group colorpicker-component formcolorpicker">
                                                                        <input type="text" name="color_background_label" value="{{ package.color_background_label }}" class="form-control"/>
                                                                        <div class="input-group-append">
                                                                            <span class="input-group-text input-group-addon"><i></i></span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>                                                            
                                                        </div>                                    
                                                    </div>
                                                </div>
                                            </form>
                                        </div>                                    
                                    </div>
                                    <div id="configuracoes" class="tab-pane">
                                        <div class="panel-body">
                                            <form id="package-form-config" method="post" enctype="multipart/form-data" action="{% url 'administrativo:futcoin_editar' package.id %}">
                                                {% csrf_token %}
                                                <div class="row">
                                                    <div class="col-lg-6">
                                                        <div class="form-group col-lg-12">
                                                            <div class="row">
                                                                <div class="col-lg-4">
                                                                    <input type="number" 
                                                                           id="preco-padrao" 
                                                                           name="full_price" 
                                                                           class="form-control input-medium" 
                                                                           value="{{ package.full_price }}" 
                                                                           required 
                                                                           step="0.01" 
                                                                           min="0">
                                                                    <label class="form-control-placeholder" for="preco-padrao">Preço Padrão *</label>
                                                                </div>
                                                                <div class="col-lg-4">
                                                                    <input type="number" 
                                                                           id="preco-promocional" 
                                                                           name="promotional_price" 
                                                                           class="form-control input-medium" 
                                                                           value="{{ package.promotional_price }}" 
                                                                           step="0.01" 
                                                                           min="0">
                                                                    <label class="form-control-placeholder" for="preco-promocional">Preço Promocional</label>
                                                                </div>
                                                            </div>
                                                        </div>                                                            
                                                        <div class="form-group col-lg-12">
                                                            <div class="row">
                                                                <div class="col-lg-4">
                                                                    <input type="number" id="conteudo" name="content" class="form-control input-medium" value="{{ package.content }}" required>
                                                                    <label class="form-control-placeholder" for="conteudo">Conteúdo (f$) *</label>
                                                                </div>
                                                                <div class="col-lg-4 bonus-field">
                                                                    <input type="number" id="bonus" name="bonus" class="form-control input-medium" value="{{ package.bonus }}" min="0">
                                                                    <label class="form-control-placeholder" for="bonus">Bônus (f$)</label>
                                                                </div> 
                                                            </div>
                                                        </div>   
                                                        <div class="form-group col-lg-12">
                                                            <div class="row">
                                                                <div class="col-lg-4 mtm15">
                                                                    <label class="control-label" for="exibir-para">Exibir para</label>
                                                                    <select class="form-control" id="exibir-para" name="show_to">
                                                                        <option value="Todos">Todos</option>
                                                                        <option value="Comum">Comum</option>
                                                                        <option value="Craque">Craque</option>
                                                                    </select>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="form-group col-lg-12">
                                                            <div class="row">
                                                                <div class="col-lg-4">
                                                                    <input type="text" id="android-product-code" name="android_product_code" class="form-control" value="{{ package.android_product_code }}">
                                                                    <label class="form-control-placeholder" for="android-product-code">Código do Produto (Android)</label>
                                                                </div>
                                                                <div class="col-lg-4">
                                                                    <input type="text" id="ios-product-code" name="ios_product_code" class="form-control" value="{{ package.ios_product_code }}">
                                                                    <label class="form-control-placeholder" for="ios-product-code">Código do Produto (iOS)</label>
                                                                </div>
                                                                <div class="col-lg-4">
                                                                    <input type="text" id="gateway-product-code" name="gateway_product_code" class="form-control" value="{{ package.gateway_product_code }}">
                                                                    <label class="form-control-placeholder" for="gateway-product-code">Código do Produto (Gateway)</label>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-6">
                                                        <div class="form-group col-lg-12 date-fields">
                                                            <div class="row">
                                                                <div class="col-lg-6">
                                                                    <label class="control-label">Data de Início</label>
                                                                    <div class="input-group">
                                                                        <input type="text" 
                                                                               name="start_date" 
                                                                               class="form-control" 
                                                                               id="start-date-input" 
                                                                               value="{{ package.start_date|date:'d/m/Y H:i' }}"
                                                                               placeholder="DD/MM/AAAA HH:MM"/>
                                                                        <div class="input-group-append">
                                                                            <div class="input-group-text date-icon" id="start-date-icon"><i class="fa fa-calendar"></i></div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="col-lg-6">
                                                                    <label class="control-label">Data de Término</label>
                                                                    <div class="input-group">
                                                                        <input type="text" 
                                                                               name="end_date" 
                                                                               class="form-control" 
                                                                               id="end-date-input" 
                                                                               value="{{ package.end_date|date:'d/m/Y H:i' }}"
                                                                               placeholder="DD/MM/AAAA HH:MM"/>
                                                                        <div class="input-group-append">
                                                                            <div class="input-group-text date-icon" id="end-date-icon"><i class="fa fa-calendar"></i></div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="panel panel-default col-lg-12 mtm25 p15">
                                    <button type="button" class="btn btn-success ml20" id="btnSalvarPacote" onclick="submitForm()"><i class="fa fa-save mr5"></i> Salvar</button>
                                    <a href="{% url 'administrativo:futcoins' %}" class="btn btn-danger ml15"><i class="fa fa-ban mr5"></i> Cancelar</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Mainly scripts -->
        <script src="{% static 'administrativo/js/jquery-3.4.1.min.js' %}"></script>
        <script src="{% static 'administrativo/js/popper.min.js' %}"></script>
        <script src="{% static 'administrativo/js/bootstrap.js' %}"></script>
        <script src="{% static 'administrativo/js/plugins/metisMenu/jquery.metisMenu.js' %}"></script>
        <script src="{% static 'administrativo/js/plugins/slimscroll/jquery.slimscroll.min.js' %}"></script>
        <!-- Custom and plugin javascript -->
        <script src="{% static 'administrativo/js/inspinia.js' %}"></script>
        <script src="{% static 'administrativo/js/plugins/pace/pace.min.js' %}"></script>
        <script src="{% static 'administrativo/js/plugins/toastr/toastr.min.js' %}"></script>
        <script src="{% static 'administrativo/js/plugins/jasny/jasny-bootstrap.min.js' %}"></script>        
        <script src="{% static 'administrativo/js/plugins/iCheck/icheck.min.js' %}"></script>
        <script src="{% static 'administrativo/js/plugins/colorpicker/bootstrap-colorpicker.min.js' %}"></script>        
        <script src="{% static 'administrativo/js/plugins/moment/moment.js' %}"></script>
        <script src="{% static 'administrativo/js/plugins/moment/pt-br.js' %}"></script>
        <script src="{% static 'administrativo/js/plugins/tempusdominus/tempusdominus-bootstrap-4.min.js' %}"></script>
        <!-- Adicionar biblioteca TableDnD -->
        <script src="{% static 'administrativo/js/plugins/tablednd/jquery.tablednd.min.js' %}"></script>
        <script src="{% static 'administrativo/js/settings.js' %}"></script>

        <script type="text/javascript">
            console.log('Script carregado');
            
            // Preenche os dados do pacote a partir do JSON
            var packageData; // Variável global para ser acessível em todo o script
            
            $(document).ready(function() {
                // Preenche os dados do pacote
                try {
                    packageData = JSON.parse('{{ package_data|safe }}');
                    console.log('Dados do pacote recebidos do servidor:', packageData);
                } catch (e) {
                    console.error('Erro ao processar dados do pacote:', e);
                    packageData = {}; // Inicializa como objeto vazio em caso de erro
                }
                
                // Preencher os campos do formulário com os dados do pacote
                $('#nome').val(packageData.name);
                
                // Processa o tipo para garantir compatibilidade
                console.log('Tipo original do pacote:', packageData.package_type);
                let tipoProcessado = '';
                if (packageData.package_type === 'padrao' || packageData.package_type === 'Padrão' || packageData.package_type && packageData.package_type.toLowerCase() === 'padrão') {
                    tipoProcessado = 'Padrão';
                } else if (packageData.package_type === 'promocional' || packageData.package_type === 'Promocional' || packageData.package_type && packageData.package_type.toLowerCase() === 'promocional') {
                    tipoProcessado = 'Promocional';
                }
                console.log('Tipo processado:', tipoProcessado);
                $('#tipo').val(tipoProcessado);
                
                $('#preco-padrao').val(packageData.full_price);
                $('#preco-promocional').val(packageData.promotional_price || '');
                $('#conteudo').val(packageData.content);
                $('#bonus').val(packageData.bonus);
                
                // Corrigir o mapeamento do campo "Exibir para"
                console.log('Valor original de show_to:', packageData.show_to);
                if (packageData.show_to === 'todos') {
                    $('#exibir-para').val('Todos');
                } else if (packageData.show_to === 'comum') {
                    $('#exibir-para').val('Comum');
                } else if (packageData.show_to === 'craque') {
                    $('#exibir-para').val('Craque');
                }
                console.log('Valor definido para exibir-para:', $('#exibir-para').val());
                
                $('#etiqueta').val(packageData.label || '');
                $('#id3 input').val(packageData.color_text_label || '#FFFFFF');
                $('#id4 input').val(packageData.color_background_label || '#FFFFFF');
                $('#android-product-code').val(packageData.android_product_code || '');
                $('#ios-product-code').val(packageData.ios_product_code || '');
                $('#gateway-product-code').val(packageData.gateway_product_code || '');
                $('.i-checks input[type="checkbox"]').prop('checked', packageData.enabled);
                
                // Atualiza os colorpickers após definir os valores
                $('#id3, #id4').each(function() {
                    $(this).colorpicker('setValue', $(this).find('input').val());
                });
                
                // Definir manualmente os valores iniciais dos datepickers após a inicialização
                var startDateRaw = packageData.start_date;
                var endDateRaw = packageData.end_date;
                
                console.log('Definindo valores iniciais dos datepickers:');
                console.log('Data de início (raw):', startDateRaw);
                console.log('Data de término (raw):', endDateRaw);
                
                // Definir valores iniciais
                if (startDateRaw) {
                    $('#start-date-input').val(startDateRaw);
                    console.log('Data de início definida para:', startDateRaw);
                }
                
                if (endDateRaw) {
                    $('#end-date-input').val(endDateRaw);
                    console.log('Data de término definida para:', endDateRaw);
                }
                
                // Exibir a imagem se existir
                if (packageData.image) {
                    $('#image-preview').html(`
                        <img src="${packageData.image}" style="width: 48px; height: 48px; object-fit: contain; cursor: pointer;" onclick="document.getElementById('image').click()">
                        <button type="button" class="btn btn-danger btn-xs" id="remove_image_btn" style="position: absolute; bottom: -7px; right: -30px;">
                            <i class="fa fa-trash"></i>
                        </button>
                    `);
                    $('#image-preview').css('margin-top', '-7px');
                    
                    // Adiciona handler para o botão de remover
                    $('#remove_image_btn').on('click', function() {
                        $('#image').val('');
                        $('#should_remove_image').val('yes');
                        $('#image-preview').html('<i class="fa fa-file-image-o" style="font-size: 48px; color: #ccc; cursor: pointer;" onclick="document.getElementById(\'image\').click()"></i>');
                    });
                }
                
                // Dispara o evento change do tipo para ajustar a visibilidade dos campos
                $('#tipo').trigger('change');
            });
            
            console.log('Valores do pacote recebidos do servidor:');
            console.log('package.full_price:', '{{ package.full_price }}');
            console.log('package.promotional_price:', '{{ package.promotional_price }}');
            console.log('package.package_type:', '{{ package.package_type }}');
            console.log('package.start_date (raw):', '{{ package.start_date }}');
            console.log('package.start_date (formatted):', '{{ package.start_date|date:"d/m/Y H:i" }}');
            console.log('package.end_date (raw):', '{{ package.end_date }}');
            console.log('package.end_date (formatted):', '{{ package.end_date|date:"d/m/Y H:i" }}');
            
            // Função para formatar valores decimais
            function formatDecimal(value) {
                if (value === null || value === undefined || value === '') {
                    return '';
                }
                return parseFloat(value).toFixed(2);
            }
            
            // Função para formatar datas no formato correto
            function formatDateForDisplay(dateStr) {
                if (!dateStr) return '';
                
                try {
                    var dateMoment = moment(dateStr);
                    if (dateMoment.isValid()) {
                        return dateMoment.format('DD/MM/YYYY HH:mm');
                    }
                } catch (e) {
                    console.log('Erro ao formatar data:', e);
                }
                return dateStr;
            }
            
            // Função para formatar datas para o backend
            function formatDateForBackend(dateStr) {
                if (!dateStr) return '';
                
                // Aceita o formato que o usuário inseriu
                return dateStr;
            }
            
            // Função global para submeter o formulário
            function submitForm() {
                console.log('Função submitForm chamada');
                
                // Evitar múltiplas submissões
                if (window.isSubmitting) {
                    console.log('Formulário já está sendo enviado, ignorando clique');
                    return;
                }
                
                window.isSubmitting = true;
                
                // Validar campos obrigatórios
                var nome = $('#nome').val();
                if (!nome) {
                    toastr.error('O nome do pacote é obrigatório');
                    window.isSubmitting = false;
                    return;
                }
                
                // Preencher campos ocultos antes de submeter
                $('#hidden_full_price').val($('#preco-padrao').val());
                $('#hidden_promotional_price').val($('#preco-promocional').val());
                $('#hidden_content').val($('#conteudo').val());
                $('#hidden_bonus').val($('#bonus').val());
                $('#hidden_show_to').val($('#exibir-para').val());
                
                // Formatação correta das datas
                var startDate = $('#start-date-input').val();
                var endDate = $('#end-date-input').val();
                
                // Validação e formatação da data de início
                if (startDate) {
                    // Simplificando a validação para aceitar o que o usuário inseriu
                    $('#hidden_start_date').val(startDate);
                    console.log('Data de início definida:', startDate);
                }
                
                // Validação e formatação da data de término
                if (endDate) {
                    // Simplificando a validação para aceitar o que o usuário inseriu
                    $('#hidden_end_date').val(endDate);
                    console.log('Data de término definida:', endDate);
                }
                
                $('#hidden_android_product_code').val($('#android-product-code').val());
                $('#hidden_ios_product_code').val($('#ios-product-code').val());
                $('#hidden_gateway_product_code').val($('#gateway-product-code').val());

                // Cria o FormData com todos os campos do formulário
                var formData = new FormData();
                
                // Adiciona o CSRF token explicitamente
                formData.append('csrfmiddlewaretoken', $('meta[name="csrf-token"]').attr('content'));

                // Adiciona campos principais explicitamente
                formData.append('name', $('#nome').val());
                
                // Normaliza o valor do tipo
                var tipoOriginal = $('#tipo').val();
                var tipoNormalizado = tipoOriginal;
                if (tipoOriginal === 'Padrão') {
                    tipoNormalizado = 'padrao';
                } else if (tipoOriginal === 'Promocional') {
                    tipoNormalizado = 'promocional';
                }
                console.log('Tipo original:', tipoOriginal, 'Tipo normalizado:', tipoNormalizado);
                formData.append('package_type', tipoNormalizado);
                
                formData.append('full_price', $('#preco-padrao').val());
                formData.append('promotional_price', $('#preco-promocional').val());
                formData.append('content', $('#conteudo').val());
                formData.append('bonus', $('#bonus').val());
                formData.append('show_to', $('#exibir-para').val());
                formData.append('label', $('#etiqueta').val());
                formData.append('color_text_label', $('#id3 input').val());
                formData.append('color_background_label', $('#id4 input').val());
                formData.append('android_product_code', $('#android-product-code').val());
                formData.append('ios_product_code', $('#ios-product-code').val());
                formData.append('gateway_product_code', $('#gateway-product-code').val());
                formData.append('enabled', $('.i-checks input[type="checkbox"]').prop('checked'));
                
                // Adiciona as datas formatadas
                if ($('#start-date-input').val()) {
                    formData.append('start_date', $('#start-date-input').val());
                    console.log('Data de início enviada:', $('#start-date-input').val());
                }
                
                if ($('#end-date-input').val()) {
                    formData.append('end_date', $('#end-date-input').val());
                    console.log('Data de término enviada:', $('#end-date-input').val());
                }
                
                // Adiciona uma mensagem para ajudar na formatação das datas
                $('.date-icon-btn').on('click', function() {
                    var inputId = $(this).data('target');
                    alert('Por favor insira a data no formato DD/MM/AAAA HH:MM. Exemplo: 01/01/2023 14:30');
                    $(inputId).focus();
                });
                
                // Adiciona a imagem se houver
                if ($('#image')[0].files[0]) {
                    formData.append('image', $('#image')[0].files[0]);
                }
                
                // Adiciona o flag de remoção de imagem
                formData.append('should_remove_image', $('#should_remove_image').val());

                // Adiciona todos os outros campos dos dois formulários que possam não ter sido incluídos explicitamente
                $('#package-form, #package-form-config').each(function() {
                    var form = $(this);
                    form.find('input, select, textarea').each(function() {
                        var input = $(this);
                        var name = input.attr('name');
                        
                        // Pula campos que já foram adicionados explicitamente
                        if (!name || name === 'name' || name === 'package_type' || name === 'full_price' || 
                            name === 'promotional_price' || name === 'content' || name === 'bonus' || 
                            name === 'show_to' || name === 'label' || name === 'color_text_label' || 
                            name === 'color_background_label' || name === 'android_product_code' || 
                            name === 'ios_product_code' || name === 'gateway_product_code' || 
                            name === 'enabled' || name === 'start_date' || name === 'end_date' || 
                            name === 'image' || name === 'should_remove_image' || 
                            name === 'csrfmiddlewaretoken') {
                            return;
                        }

                        if (input.attr('type') === 'file') {
                            if (input[0].files[0]) {
                                formData.append(name, input[0].files[0]);
                            }
                        } else if (input.attr('type') === 'checkbox') {
                            formData.append(name, input.prop('checked'));
                        } else {
                            formData.append(name, input.val() || '');
                        }
                    });
                });

                // Envia os dados
                $.ajax({
                    url: "{% url 'administrativo:futcoin_editar' package.id %}",
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    headers: {
                        'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')
                    },
                    beforeSend: function() {
                        // Adicionar explicitamente as datas formatadas ao FormData
                        if ($('#hidden_start_date').val()) {
                            // Garantir que a data está no formato DD/MM/YYYY HH:mm
                            var startDateValue = $('#hidden_start_date').val();
                            if (!/^\d{2}\/\d{2}\/\d{4}\s\d{2}:\d{2}$/.test(startDateValue)) {
                                // Se não estiver no formato correto, tentar reformatar
                                try {
                                    var dateMoment = moment(startDateValue);
                                    if (dateMoment.isValid()) {
                                        startDateValue = dateMoment.format('DD/MM/YYYY HH:mm');
                                    }
                                } catch (e) {
                                    console.log('Erro ao reformatar data de início (beforeSend):', e);
                                }
                            }
                            formData.set('start_date', startDateValue);
                            console.log('Data de início enviada (beforeSend):', startDateValue);
                        }
                        
                        if ($('#hidden_end_date').val()) {
                            // Garantir que a data está no formato DD/MM/YYYY HH:mm
                            var endDateValue = $('#hidden_end_date').val();
                            if (!/^\d{2}\/\d{2}\/\d{4}\s\d{2}:\d{2}$/.test(endDateValue)) {
                                // Se não estiver no formato correto, tentar reformatar
                                try {
                                    var dateMoment = moment(endDateValue);
                                    if (dateMoment.isValid()) {
                                        endDateValue = dateMoment.format('DD/MM/YYYY HH:mm');
                                    }
                                } catch (e) {
                                    console.log('Erro ao reformatar data de término (beforeSend):', e);
                                }
                            }
                            formData.set('end_date', endDateValue);
                            console.log('Data de término enviada (beforeSend):', endDateValue);
                        }
                        
                        console.log('Dados finais do formulário:');
                        for (var pair of formData.entries()) {
                            console.log(pair[0] + ': ' + pair[1]); 
                        }
                    },
                    success: function(response) {
                        console.log('Resposta do servidor:', response);
                        if (response.success) {
                            toastr.success(response.message || 'Pacote atualizado com sucesso!');
                            setTimeout(function() {
                                window.location.href = "{% url 'administrativo:futcoins' %}";
                            }, 1000);
                        } else {
                            toastr.error(response.message || 'Erro ao atualizar pacote');
                        }
                        window.isSubmitting = false;
                    },
                    error: function(xhr, status, error) {
                        console.log('Erro:', error);
                        console.log('Status:', status);
                        console.log('XHR:', xhr);
                        
                        var errorMessage = 'Erro ao atualizar pacote';
                        try {
                            var response = JSON.parse(xhr.responseText);
                            errorMessage = response.message || errorMessage;
                        } catch (e) {
                            console.log('Erro ao parsear resposta:', e);
                        }
                        toastr.error(errorMessage);
                        window.isSubmitting = false;
                    }
                });
            }

            // Substituir o window.addEventListener por $(document).ready
            $(document).ready(function() {
                console.log('Página totalmente carregada');
                
                // Preencher os campos de preço com os valores formatados
                var fullPrice = '{{ package.full_price }}';
                var promotionalPrice = '{{ package.promotional_price }}';
                
                if (fullPrice) {
                    $('#preco-padrao').val(formatDecimal(fullPrice));
                }
                
                if (promotionalPrice && promotionalPrice !== 'None') {
                    $('#preco-promocional').val(formatDecimal(promotionalPrice));
                }
                
                // Garantir que as datas estejam no formato correto
                var startDateValue = $('#start-date-input').val();
                var endDateValue = $('#end-date-input').val();
                
                console.log('Valores iniciais das datas:');
                console.log('Data de início original:', startDateValue);
                console.log('Data de término original:', endDateValue);
                
                // Formatar as datas para exibição
                if (startDateValue) {
                    var formattedStartDate = formatDateForDisplay(startDateValue);
                    if (formattedStartDate) {
                        $('#start-date-input').val(formattedStartDate);
                        console.log('Data de início formatada para exibição:', formattedStartDate);
                    }
                }
                
                if (endDateValue) {
                    var formattedEndDate = formatDateForDisplay(endDateValue);
                    if (formattedEndDate) {
                        $('#end-date-input').val(formattedEndDate);
                        console.log('Data de término formatada para exibição:', formattedEndDate);
                    }
                }
                
                console.log('Valores formatados:');
                console.log('Preço padrão formatado:', $('#preco-padrao').val());
                console.log('Preço promocional formatado:', $('#preco-promocional').val());
                console.log('Data de início formatada:', $('#start-date-input').val());
                console.log('Data de término formatada:', $('#end-date-input').val());
                
                console.log('Valores iniciais dos campos:');
                console.log('Nome:', $('#nome').val());
                console.log('Tipo:', $('#tipo').val());
                console.log('Preço Padrão:', $('#preco-padrao').val());
                console.log('Preço Promocional:', $('#preco-promocional').val());
                console.log('Conteúdo:', $('#conteudo').val());
                console.log('Bônus:', $('#bonus').val());
                console.log('Exibir para:', $('#exibir-para').val());
                console.log('Data de Início:', $('#start-date-input').val());
                console.log('Data de Término:', $('#end-date-input').val());
                console.log('Código Android:', $('#android-product-code').val());
                console.log('Código iOS:', $('#ios-product-code').val());
                console.log('Código Gateway:', $('#gateway-product-code').val());

                // Setup CSRF token for AJAX requests
                $.ajaxSetup({
                    headers: {
                        'X-CSRFToken': $('meta[name="csrf-token"]').attr('content')
                    }
                });

                // Adicionar event listener para o botão de salvar
                $(document).on('click', '#btnSalvarPacote', function() {
                    console.log('Evento de clique do botão salvar acionado via jQuery');
                    submitForm();
                });

                // Preencher campos ocultos antes de submeter o formulário
                $('#package-form').on('submit', function() {
                    $('#hidden_full_price').val($('#preco-padrao').val());
                    $('#hidden_promotional_price').val($('#preco-promocional').val());
                    $('#hidden_content').val($('#conteudo').val());
                    $('#hidden_bonus').val($('#bonus').val());
                    $('#hidden_show_to').val($('#exibir-para').val());
                    
                    // Formatação correta das datas
                    var startDate = $('#start-date-input').val();
                    var endDate = $('#end-date-input').val();
                    
                    if (startDate) {
                        // Verificar se a data está no formato correto
                        if (!/^\d{2}\/\d{2}\/\d{4}\s\d{2}:\d{2}$/.test(startDate)) {
                            // Tentar reformatar a data
                            startDate = formatDateForDisplay(startDate);
                            if (!startDate) {
                                console.log('Erro: Data de início inválida');
                                return false;
                            }
                        }
                        
                        // Converter para o formato que o Django espera (YYYY-MM-DD HH:MM)
                        var formattedStartDate = formatDateForBackend(startDate);
                        if (formattedStartDate) {
                            $('#hidden_start_date').val(formattedStartDate);
                            console.log('Data de início formatada (submit):', formattedStartDate);
                        } else {
                            console.log('Erro: Não foi possível formatar a data de início');
                            return false;
                        }
                    }
                    
                    if (endDate) {
                        // Verificar se a data está no formato correto
                        if (!/^\d{2}\/\d{2}\/\d{4}\s\d{2}:\d{2}$/.test(endDate)) {
                            // Tentar reformatar a data
                            endDate = formatDateForDisplay(endDate);
                            if (!endDate) {
                                console.log('Erro: Data de término inválida');
                                return false;
                            }
                        }
                        
                        // Converter para o formato que o Django espera (YYYY-MM-DD HH:MM)
                        var formattedEndDate = formatDateForBackend(endDate);
                        if (formattedEndDate) {
                            $('#hidden_end_date').val(formattedEndDate);
                            console.log('Data de término formatada (submit):', formattedEndDate);
                        } else {
                            console.log('Erro: Não foi possível formatar a data de término');
                            return false;
                        }
                    }
                    
                    $('#hidden_android_product_code').val($('#android-product-code').val());
                    $('#hidden_ios_product_code').val($('#ios-product-code').val());
                    $('#hidden_gateway_product_code').val($('#gateway-product-code').val());
                    
                    console.log('Formulário submetido com campos ocultos preenchidos');
                    return true;
                });

                // Configuração do Toastr
                toastr.options = {
                    "closeButton": true,
                    "debug": false,
                    "newestOnTop": false,
                    "progressBar": true,
                    "positionClass": "toast-top-right",
                    "preventDuplicates": false,
                    "onclick": null,
                    "showDuration": "300",
                    "hideDuration": "500",
                    "timeOut": "1500",
                    "extendedTimeOut": "500",
                    "showEasing": "swing",
                    "hideEasing": "linear",
                    "showMethod": "fadeIn",
                    "hideMethod": "fadeOut"
                };

                // Inicializa os colorpickers
                $('.formcolorpicker').colorpicker();

                // Inicializa os datetimepickers com a configuração correta
                try {
                    // Destruir quaisquer instâncias anteriores para limpar
                    if ($.fn.datetimepicker) {
                        try {
                            $('#start-date-input').closest('.input-group').datetimepicker('destroy');
                            $('#end-date-input').closest('.input-group').datetimepicker('destroy');
                            console.log('Instâncias anteriores de datetimepicker destruídas com sucesso');
                        } catch (error) {
                            console.log('Sem instâncias anteriores para destruir:', error);
                        }
                        
                        // Inicializa os datetimepickers apenas uma vez
                        var startDateContainer = $('#start-date-input').closest('.input-group');
                        var endDateContainer = $('#end-date-input').closest('.input-group');
                        
                        // Adiciona listeners para atualizar os campos ocultos quando as datas mudarem
                        $('#start-date-input').on('change', function() {
                            var dateValue = $(this).val();
                            if (dateValue) {
                                $('#hidden_start_date').val(dateValue);
                                console.log('Data de início atualizada manualmente:', dateValue);
                            }
                        });
                        
                        $('#end-date-input').on('change', function() {
                            var dateValue = $(this).val();
                            if (dateValue) {
                                $('#hidden_end_date').val(dateValue);
                                console.log('Data de término atualizada manualmente:', dateValue);
                            }
                        });
                        
                        // Inicializa o datepicker de início
                        setTimeout(function() {
                            try {
                                startDateContainer.datetimepicker({
                                    format: 'DD/MM/YYYY HH:mm',
                                    locale: 'pt-br',
                                    icons: {
                                        time: 'fa fa-clock-o',
                                        date: 'fa fa-calendar',
                                        up: 'fa fa-chevron-up',
                                        down: 'fa fa-chevron-down',
                                        previous: 'fa fa-chevron-left',
                                        next: 'fa fa-chevron-right',
                                        today: 'fa fa-screenshot',
                                        clear: 'fa fa-trash',
                                        close: 'fa fa-remove'
                                    }
                                });
                                console.log('Datepicker de início inicializado com sucesso');
                                
                                // Adicionar listener para o datetimepicker de início
                                startDateContainer.off('change.datetimepicker').on('change.datetimepicker', function(e) {
                                    if (e && e.date) {
                                        var formattedDate = e.date.format('DD/MM/YYYY HH:mm');
                                        $('#hidden_start_date').val(formattedDate);
                                        $('#start-date-input').val(formattedDate);
                                        console.log('Data de início via datetimepicker:', formattedDate);
                                        
                                        // Definir data mínima para o datetimepicker de término
                                        try {
                                            endDateContainer.datetimepicker('minDate', e.date);
                                        } catch (err) {
                                            console.log('Erro ao definir minDate:', err);
                                        }
                                    }
                                });
                            } catch (e) {
                                console.error('Erro ao inicializar datepicker de início:', e);
                            }
                        }, 200);
                        
                        // Inicializa o datepicker de término com atraso para evitar conflitos
                        setTimeout(function() {
                            try {
                                endDateContainer.datetimepicker({
                                    format: 'DD/MM/YYYY HH:mm',
                                    locale: 'pt-br',
                                    icons: {
                                        time: 'fa fa-clock-o',
                                        date: 'fa fa-calendar',
                                        up: 'fa fa-chevron-up',
                                        down: 'fa fa-chevron-down',
                                        previous: 'fa fa-chevron-left',
                                        next: 'fa fa-chevron-right',
                                        today: 'fa fa-screenshot',
                                        clear: 'fa fa-trash',
                                        close: 'fa fa-remove'
                                    }
                                });
                                console.log('Datepicker de término inicializado com sucesso');
                                
                                // Adicionar listener para o datetimepicker de término
                                endDateContainer.off('change.datetimepicker').on('change.datetimepicker', function(e) {
                                    if (e && e.date) {
                                        var formattedDate = e.date.format('DD/MM/YYYY HH:mm');
                                        $('#hidden_end_date').val(formattedDate);
                                        $('#end-date-input').val(formattedDate);
                                        console.log('Data de término via datetimepicker:', formattedDate);
                                        
                                        // Definir data máxima para o datetimepicker de início
                                        try {
                                            startDateContainer.datetimepicker('maxDate', e.date);
                                        } catch (err) {
                                            console.log('Erro ao definir maxDate:', err);
                                        }
                                    }
                                });
                            } catch (e) {
                                console.error('Erro ao inicializar datepicker de término:', e);
                            }
                        }, 400);
                        
                        // Define os valores iniciais com atraso para evitar problemas
                        setTimeout(function() {
                            if (packageData && packageData.start_date) {
                                try {
                                    $('#start-date-input').val(packageData.start_date);
                                    console.log('Valor de data de início definido:', packageData.start_date);
                                } catch (e) {
                                    console.error('Erro ao definir data de início:', e);
                                }
                            }
                            
                            if (packageData && packageData.end_date) {
                                try {
                                    $('#end-date-input').val(packageData.end_date);
                                    console.log('Valor de data de término definido:', packageData.end_date);
                                } catch (e) {
                                    console.error('Erro ao definir data de término:', e);
                                }
                            }
                        }, 600);
                        
                        // Adiciona tratamento manual para abrir o datepicker ao clicar no ícone
                        $('#start-date-icon').on('click', function() {
                            try {
                                startDateContainer.datetimepicker('toggle');
                            } catch (e) {
                                console.error('Erro ao toggle datepicker de início:', e);
                                alert('Por favor insira a data no formato DD/MM/AAAA HH:MM. Exemplo: 01/01/2023 14:30');
                                $('#start-date-input').focus();
                            }
                        });
                        
                        $('#end-date-icon').on('click', function() {
                            try {
                                endDateContainer.datetimepicker('toggle');
                            } catch (e) {
                                console.error('Erro ao toggle datepicker de término:', e);
                                alert('Por favor insira a data no formato DD/MM/AAAA HH:MM. Exemplo: 01/01/2023 14:30');
                                $('#end-date-input').focus();
                            }
                        });
                    } else {
                        console.error('Plugin datetimepicker não está disponível');
                    }
                } catch (e) {
                    console.error('Erro geral ao processar campos de data:', e);
                    alert('Ocorreu um erro ao inicializar os seletores de data. Por favor, insira as datas manualmente no formato DD/MM/AAAA HH:MM');
                }

                // Inicializa iCheck
                $('.i-checks').iCheck({
                    checkboxClass: 'icheckbox_square-green',
                    radioClass: 'iradio_square-green'
                });

                // Controle de visibilidade baseado no tipo
                $('#tipo').change(function() {
                    var tipo = $(this).val();
                    
                    if (tipo === '') {
                        // Quando for Selecione, oculta todos os campos
                        $('.date-fields').hide();
                        $('.label-fields').hide();
                        $('#etiqueta').closest('.form-group').hide();
                    } else if (tipo === 'padrao' || tipo === 'Padrão') {
                        // Quando for Padrão, mostra etiqueta mas oculta campos de data
                        $('.date-fields').hide();
                        $('.label-fields').show();
                        $('#etiqueta').closest('.form-group').show();
                    } else if (tipo === 'promocional' || tipo === 'Promocional') {
                        // Quando for Promocional, mostra todos os campos
                        $('.date-fields').show();
                        $('.label-fields').show();
                        $('#etiqueta').closest('.form-group').show();
                    }
                });
                
                // Dispara o evento change do tipo para configurar visibilidade inicial
                $('#tipo').trigger('change');

                // Preview da imagem
                $('.input-image').change(function() {
                    var file = this.files[0];
                    if (file) {
                        var reader = new FileReader();
                        reader.onload = function(e) {
                            $('#image-preview').html(`
                                <img src="${e.target.result}" style="width: 48px; height: 48px; object-fit: contain; cursor: pointer;" onclick="document.getElementById('image').click()">
                                <button type="button" class="btn btn-danger btn-xs" id="remove_image_btn" style="position: absolute; bottom: -7px; right: -30px;">
                                    <i class="fa fa-trash"></i>
                                </button>
                            `);
                        }
                        reader.readAsDataURL(file);
                    }
                });

                // Handler para o botão de remover imagem
                $(document).on('click', '#remove_image_btn', function() {
                    $('#image').val('');
                    $('#should_remove_image').val('yes');
                    $('#image-preview').html('<i class="fa fa-file-image-o" style="font-size: 48px; color: #ccc; cursor: pointer;" onclick="document.getElementById(\'image\').click()"></i>');
                });
            });
        </script>
    </body>
</html>
